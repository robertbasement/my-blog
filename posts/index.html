<!DOCTYPE html>
<html lang="en-us">
    <head><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content='from cmoney.client import CMoneyDownloader host_addr = &#39;192.168.1.56&#39; dl = CMoneyDownloader(host_addr) event_df = await dl.query(&#39;日個股事件&#39;, start=&#39;20150101&#39;) import pandas as pd import numpy as np import matplotlib.pyplot as plt company_event = pd.read_feather(&#39;/Users/roberthsu/Documents/TrendForce_project/cmoney_warehouse/daily/company_event.ftr&#39;) SUB_TICKERS = [&#39;2059&#39;, &#39;3529&#39;, &#39;2383&#39;, &#39;2330&#39;, &#39;8069&#39;, &#39;5274&#39;, &#39;3008&#39;, &#39;2454&#39;, &#39;3533&#39;] company_event = company_event[company_event[&#39;股票代號&#39;].isin(SUB_TICKERS)] company_event.columns Index([&#39;日期&#39;, &#39;股票代號&#39;, &#39;股票名稱&#39;, &#39;月營收公告&#39;, &#39;財報公告&#39;, &#39;除息日&#39;, &#39;除權日&#39;, &#39;法說會&#39;, &#39;減資前&#39;, &#39;減資後&#39;, &#39;股東會&#39;, &#39;申報轉讓&#39;, &#39;庫藏股&#39;, &#39;注意股票&#39;, &#39;新股上市&#39;, &#39;人事異動&#39;, &#39;停資&#39;, &#39;停券&#39;, &#39;最後回補日&#39;, &#39;今日事件數&#39;, &#39;RTIME&#39;], dtype=&#39;object&#39;) company_event.loc[~company_event[&#39;減資前&#39;].isna(), [&#39;日期&#39;, &#39;股票代號&#39;]] company_event.columns 400張以上大戶持股比例數據異常
company_event.loc[(company_event[&#39;新股上市&#39;]==0) , [&#39;日期&#39;, &#39;股票代號&#39;]].iloc[-20::] .dataframe tbody tr th { vertical-align: top; } .dataframe thead th { text-align: right; } '><title></title>

<link rel='canonical' href='https://robertbasement.github.io/my-blog/posts/'>

<link rel="stylesheet" href="/my-blog/scss/style.min.css"><meta property='og:title' content=''>
<meta property='og:description' content='from cmoney.client import CMoneyDownloader host_addr = &#39;192.168.1.56&#39; dl = CMoneyDownloader(host_addr) event_df = await dl.query(&#39;日個股事件&#39;, start=&#39;20150101&#39;) import pandas as pd import numpy as np import matplotlib.pyplot as plt company_event = pd.read_feather(&#39;/Users/roberthsu/Documents/TrendForce_project/cmoney_warehouse/daily/company_event.ftr&#39;) SUB_TICKERS = [&#39;2059&#39;, &#39;3529&#39;, &#39;2383&#39;, &#39;2330&#39;, &#39;8069&#39;, &#39;5274&#39;, &#39;3008&#39;, &#39;2454&#39;, &#39;3533&#39;] company_event = company_event[company_event[&#39;股票代號&#39;].isin(SUB_TICKERS)] company_event.columns Index([&#39;日期&#39;, &#39;股票代號&#39;, &#39;股票名稱&#39;, &#39;月營收公告&#39;, &#39;財報公告&#39;, &#39;除息日&#39;, &#39;除權日&#39;, &#39;法說會&#39;, &#39;減資前&#39;, &#39;減資後&#39;, &#39;股東會&#39;, &#39;申報轉讓&#39;, &#39;庫藏股&#39;, &#39;注意股票&#39;, &#39;新股上市&#39;, &#39;人事異動&#39;, &#39;停資&#39;, &#39;停券&#39;, &#39;最後回補日&#39;, &#39;今日事件數&#39;, &#39;RTIME&#39;], dtype=&#39;object&#39;) company_event.loc[~company_event[&#39;減資前&#39;].isna(), [&#39;日期&#39;, &#39;股票代號&#39;]] company_event.columns 400張以上大戶持股比例數據異常
company_event.loc[(company_event[&#39;新股上市&#39;]==0) , [&#39;日期&#39;, &#39;股票代號&#39;]].iloc[-20::] .dataframe tbody tr th { vertical-align: top; } .dataframe thead th { text-align: right; } '>
<meta property='og:url' content='https://robertbasement.github.io/my-blog/posts/'>
<meta property='og:site_name' content='RobertBasement'>
<meta property='og:type' content='article'><meta property='article:section' content='Post' />
<meta name="twitter:title" content="">
<meta name="twitter:description" content="from cmoney.client import CMoneyDownloader host_addr = &#39;192.168.1.56&#39; dl = CMoneyDownloader(host_addr) event_df = await dl.query(&#39;日個股事件&#39;, start=&#39;20150101&#39;) import pandas as pd import numpy as np import matplotlib.pyplot as plt company_event = pd.read_feather(&#39;/Users/roberthsu/Documents/TrendForce_project/cmoney_warehouse/daily/company_event.ftr&#39;) SUB_TICKERS = [&#39;2059&#39;, &#39;3529&#39;, &#39;2383&#39;, &#39;2330&#39;, &#39;8069&#39;, &#39;5274&#39;, &#39;3008&#39;, &#39;2454&#39;, &#39;3533&#39;] company_event = company_event[company_event[&#39;股票代號&#39;].isin(SUB_TICKERS)] company_event.columns Index([&#39;日期&#39;, &#39;股票代號&#39;, &#39;股票名稱&#39;, &#39;月營收公告&#39;, &#39;財報公告&#39;, &#39;除息日&#39;, &#39;除權日&#39;, &#39;法說會&#39;, &#39;減資前&#39;, &#39;減資後&#39;, &#39;股東會&#39;, &#39;申報轉讓&#39;, &#39;庫藏股&#39;, &#39;注意股票&#39;, &#39;新股上市&#39;, &#39;人事異動&#39;, &#39;停資&#39;, &#39;停券&#39;, &#39;最後回補日&#39;, &#39;今日事件數&#39;, &#39;RTIME&#39;], dtype=&#39;object&#39;) company_event.loc[~company_event[&#39;減資前&#39;].isna(), [&#39;日期&#39;, &#39;股票代號&#39;]] company_event.columns 400張以上大戶持股比例數據異常
company_event.loc[(company_event[&#39;新股上市&#39;]==0) , [&#39;日期&#39;, &#39;股票代號&#39;]].iloc[-20::] .dataframe tbody tr th { vertical-align: top; } .dataframe thead th { text-align: right; } ">
      <script async src="https://www.googletagmanager.com/gtag/js?id=G-YZL9P8D9FJ"></script>
      <script>
        var doNotTrack = false;
        if ( false ) {
          var dnt = (navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack);
          var doNotTrack = (dnt == "1" || dnt == "yes");
        }
        if (!doNotTrack) {
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', 'G-YZL9P8D9FJ');
        }
      </script>
    </head>
    <body class="
    article-page has-toc
">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "auto");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex 
    
        extended
    
">
    
        <div id="article-toolbar">
            <a href="https://robertbasement.github.io/my-blog/" class="back-home">
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-chevron-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <polyline points="15 6 9 12 15 18" />
</svg>



                <span>Back</span>
            </a>
        </div>
    
<main class="main full-width">
    <article class="main-article">
    <header class="article-header">

    <div class="article-details">
    

    <h2 class="article-title">
        <a href="/my-blog/posts/"></a>
    </h2>

    

    
    <footer class="article-time">
        

        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



                <time class="article-time--reading">
                    37 minute read
                </time>
            </div>
        
    </footer>
    
</div>
</header>

    <section class="article-content">
    <div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">pd</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">float_format</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:.4f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">SUB_TICKERS</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;2059&#39;</span><span class="p">,</span> <span class="s1">&#39;3529&#39;</span><span class="p">,</span> <span class="s1">&#39;2383&#39;</span><span class="p">,</span> <span class="s1">&#39;2330&#39;</span><span class="p">,</span> <span class="s1">&#39;8069&#39;</span><span class="p">,</span> <span class="s1">&#39;5274&#39;</span><span class="p">,</span> <span class="s1">&#39;3008&#39;</span><span class="p">,</span> <span class="s1">&#39;2454&#39;</span><span class="p">,</span> <span class="s1">&#39;3533&#39;</span><span class="p">]</span>
</span></span></code></pre></div><h2 id="月營收">月營收</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">mon_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_feather</span><span class="p">(</span><span class="s1">&#39;/Users/roberthsu/Documents/TrendForce_project/cmoney_warehouse/monthly/monthly_revenue.ftr&#39;</span><span class="p">)</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">mon_df</span> <span class="o">=</span> <span class="n">mon_df</span><span class="p">[</span><span class="n">mon_df</span><span class="p">[</span><span class="s1">&#39;股票代號&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">SUB_TICKERS</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl"><span class="n">mon_df</span> <span class="o">=</span> <span class="n">mon_df</span><span class="p">[</span><span class="o">~</span><span class="n">mon_df</span><span class="p">[</span><span class="s1">&#39;公告日&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()]</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">mon_df</span><span class="p">[</span><span class="s1">&#39;公告日_dt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">mon_df</span><span class="p">[</span><span class="s1">&#39;公告日&#39;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="n">mon_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;公告日_dt&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">mon_df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span></code></pre></div><h2 id="收盤價">收盤價</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">price_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_feather</span><span class="p">(</span><span class="s1">&#39;/Users/roberthsu/Documents/TrendForce_project/cmoney_warehouse/daily/org_price.ftr&#39;</span><span class="p">)</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">price0050</span> <span class="o">=</span> <span class="n">price_df</span><span class="p">[</span><span class="n">price_df</span><span class="p">[</span><span class="s1">&#39;股票代號&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;0050&#39;</span><span class="p">]</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">price0050</span><span class="p">[</span><span class="s1">&#39;日期_dt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">price0050</span><span class="p">[</span><span class="s1">&#39;日期&#39;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="n">price0050</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;日期_dt&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">price0050</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span></code></pre></div><pre><code>/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1320320034.py:1: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
  price0050['日期_dt'] = pd.to_datetime(price0050['日期'])
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1320320034.py:2: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
  price0050.sort_values('日期_dt', inplace=True, ascending=True)
</code></pre>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">price_df</span> <span class="o">=</span> <span class="n">price_df</span><span class="p">[</span><span class="n">price_df</span><span class="p">[</span><span class="s1">&#39;股票代號&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">SUB_TICKERS</span><span class="p">)]</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">price_df</span><span class="p">[</span><span class="s1">&#39;日期_dt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">price_df</span><span class="p">[</span><span class="s1">&#39;日期&#39;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="n">price_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;日期_dt&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">price_df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">holding_nDays</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">120</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">        <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;hold_</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s1">Days_ret&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;收盤價&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="n">n</span><span class="p">)</span> <span class="o">/</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;收盤價&#39;</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">        <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;hold_</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s1">Days_ret&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;hold_</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s1">Days_ret&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># 實際上隔日才能操作</span>
</span></span><span class="line"><span class="cl">        <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;last_</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s1">Days_ret&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;hold_</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s1">Days_ret&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="n">n</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="c1"># 實際上隔日才能操作</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;hold_</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s1">Days_winrate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;hold_</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s1">Days_ret&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span> <span class="p">:</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">df</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">price_df</span> <span class="o">=</span> <span class="n">price_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;股票代號&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">holding_nDays</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span></code></pre></div><pre><code>/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/392270890.py:1: DeprecationWarning: DataFrameGroupBy.apply operated on the grouping columns. This behavior is deprecated, and in a future version of pandas the grouping columns will be excluded from the operation. Either pass `include_groups=False` to exclude the groupings or explicitly select the grouping columns after groupby to silence this warning.
  price_df = price_df.groupby('股票代號').apply(holding_nDays).reset_index(drop=True)
</code></pre>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">price0050</span> <span class="o">=</span> <span class="n">price0050</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;股票代號&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">holding_nDays</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span></code></pre></div><pre><code>/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/2395123834.py:1: DeprecationWarning: DataFrameGroupBy.apply operated on the grouping columns. This behavior is deprecated, and in a future version of pandas the grouping columns will be excluded from the operation. Either pass `include_groups=False` to exclude the groupings or explicitly select the grouping columns after groupby to silence this warning.
  price0050 = price0050.groupby('股票代號').apply(holding_nDays).reset_index(drop=True)
</code></pre>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">price_df</span> <span class="o">=</span> <span class="n">price_df</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">price0050</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">left_on</span><span class="o">=</span><span class="p">([</span><span class="s1">&#39;日期_dt&#39;</span><span class="p">]),</span> <span class="n">right_on</span><span class="o">=</span><span class="p">([</span><span class="s1">&#39;日期_dt&#39;</span><span class="p">]),</span> <span class="n">suffixes</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;_0050&#39;</span><span class="p">))</span>
</span></span></code></pre></div><h2 id="融資">融資</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">margin_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_feather</span><span class="p">(</span><span class="s1">&#39;/Users/roberthsu/Documents/TrendForce_project/cmoney_warehouse/daily/dayMarginTrading.ftr&#39;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;日期&#39;</span><span class="p">,</span> <span class="s1">&#39;股票代號&#39;</span><span class="p">,</span> <span class="s1">&#39;資餘&#39;</span><span class="p">,</span> <span class="s1">&#39;券餘&#39;</span><span class="p">,</span> <span class="s1">&#39;券資比&#39;</span><span class="p">,</span> <span class="s1">&#39;當沖比率&#39;</span><span class="p">,</span> <span class="s1">&#39;融資成本(推估)&#39;</span><span class="p">,</span> <span class="s1">&#39;融券成本(推估)&#39;</span><span class="p">,</span> <span class="s1">&#39;融資維持率(%)&#39;</span><span class="p">,</span> <span class="s1">&#39;融券維持率(%)&#39;</span><span class="p">,</span><span class="s1">&#39;整體維持率(%)&#39;</span><span class="p">])</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">price_df</span> <span class="o">=</span> <span class="n">price_df</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">margin_df</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">left_on</span><span class="o">=</span><span class="p">([</span><span class="s1">&#39;日期&#39;</span><span class="p">,</span> <span class="s1">&#39;股票代號&#39;</span><span class="p">]),</span> <span class="n">right_on</span><span class="o">=</span><span class="p">([</span><span class="s1">&#39;日期&#39;</span><span class="p">,</span> <span class="s1">&#39;股票代號&#39;</span><span class="p">]))</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">price_df</span><span class="p">[</span><span class="s1">&#39;維持率反推融資平均損益&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">price_df</span><span class="p">[</span><span class="s1">&#39;融資維持率(%)&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">0.6</span><span class="p">)</span> <span class="o">-</span> <span class="mi">100</span><span class="p">)</span> <span class="o">/</span><span class="mi">100</span>
</span></span></code></pre></div><h2 id="週集保">週集保</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">weekly_depostie</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_feather</span><span class="p">(</span><span class="s1">&#39;/Users/roberthsu/Documents/TrendForce_project/cmoney_warehouse/weeklyDepository.ftr&#39;</span><span class="p">)</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">weekly_depostie</span> <span class="o">=</span> <span class="n">weekly_depostie</span><span class="p">[</span><span class="n">weekly_depostie</span><span class="p">[</span><span class="s1">&#39;股票代號&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">SUB_TICKERS</span><span class="p">)]</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">weekly_depostie</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;日期&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">weekly_depostie</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">agg</span> <span class="o">=</span> <span class="n">weekly_depostie</span><span class="p">[</span><span class="n">weekly_depostie</span><span class="p">[</span><span class="s1">&#39;持股分級&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="s1">&#39;0400001-0600000&#39;</span><span class="p">,</span> <span class="s1">&#39;0600001-0800000&#39;</span><span class="p">,</span> <span class="s1">&#39;0800001-1000000&#39;</span><span class="p">,</span> <span class="s1">&#39;1000001以上&#39;</span><span class="p">])]</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;日期&#39;</span><span class="p">,</span> <span class="s1">&#39;股票代號&#39;</span><span class="p">])[</span><span class="s1">&#39;佔集保庫存數比例(%)&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">to_frame</span><span class="p">()</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">agg</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">company_event</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_feather</span><span class="p">(</span><span class="s1">&#39;/Users/roberthsu/Documents/TrendForce_project/cmoney_warehouse/daily/company_event.ftr&#39;</span><span class="p">)</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">company_event</span> <span class="o">=</span> <span class="n">company_event</span><span class="p">[</span><span class="n">company_event</span><span class="p">[</span><span class="s1">&#39;股票代號&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">SUB_TICKERS</span><span class="p">)]</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">date_pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;^\d</span><span class="si">{8}</span><span class="s1">$&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">company_event</span> <span class="o">=</span> <span class="n">company_event</span><span class="p">[</span><span class="n">company_event</span><span class="p">[</span><span class="s1">&#39;日期&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="n">date_pattern</span><span class="p">)]</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">company_event</span><span class="p">[</span><span class="s1">&#39;日期_dt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">company_event</span><span class="p">[</span><span class="s1">&#39;日期&#39;</span><span class="p">])</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">company_event</span><span class="p">[</span><span class="s1">&#39;friday_of_week&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">company_event</span><span class="p">[</span><span class="s1">&#39;日期_dt&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">offsets</span><span class="o">.</span><span class="n">Week</span><span class="p">(</span><span class="n">weekday</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">company_event</span><span class="p">[</span><span class="s1">&#39;adjust_week&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="n">company_event</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">company_event</span><span class="p">[</span><span class="s1">&#39;新股上市&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">company_event</span><span class="p">[</span><span class="s1">&#39;減資前&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span><span class="p">),</span> <span class="s1">&#39;adjust_week&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">agg</span><span class="p">[</span><span class="s1">&#39;日期_dt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">agg</span><span class="p">[</span><span class="s1">&#39;日期&#39;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="n">agg</span><span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">agg</span><span class="p">[</span><span class="s1">&#39;日期_dt&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">agg</span><span class="p">[</span><span class="s1">&#39;週集保月線&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">agg</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;股票代號&#39;</span><span class="p">])[</span><span class="s1">&#39;佔集保庫存數比例(%)&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">agg</span><span class="p">[</span><span class="s1">&#39;週集保半年線&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">agg</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;股票代號&#39;</span><span class="p">])[</span><span class="s1">&#39;佔集保庫存數比例(%)&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">24</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">agg</span><span class="p">[</span><span class="s1">&#39;週集保diff&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">agg</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;股票代號&#39;</span><span class="p">])[</span><span class="s1">&#39;佔集保庫存數比例(%)&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">agg</span> <span class="o">=</span> <span class="n">agg</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">company_event</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">company_event</span><span class="p">[</span><span class="s1">&#39;adjust_week&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;friday_of_week&#39;</span><span class="p">,</span> <span class="s1">&#39;股票代號&#39;</span><span class="p">,</span> <span class="s1">&#39;減資前&#39;</span><span class="p">,</span> <span class="s1">&#39;新股上市&#39;</span><span class="p">,</span> <span class="s1">&#39;adjust_week&#39;</span><span class="p">]],</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">left_on</span><span class="o">=</span><span class="p">([</span><span class="s1">&#39;日期_dt&#39;</span><span class="p">,</span> <span class="s1">&#39;股票代號&#39;</span><span class="p">]),</span> <span class="n">right_on</span><span class="o">=</span><span class="p">([</span><span class="s1">&#39;friday_of_week&#39;</span><span class="p">,</span> <span class="s1">&#39;股票代號&#39;</span><span class="p">]))</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># 有股數異動 當周週集保diff -&gt; 0</span>
</span></span><span class="line"><span class="cl"><span class="n">agg</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">agg</span><span class="p">[</span><span class="s1">&#39;adjust_week&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;週集保diff&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">agg</span><span class="p">[</span><span class="s1">&#39;週集保diff4week&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">agg</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;股票代號&#39;</span><span class="p">])[</span><span class="s1">&#39;週集保diff&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">price_df</span> <span class="o">=</span> <span class="n">price_df</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">agg</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">left_on</span><span class="o">=</span><span class="p">([</span><span class="s1">&#39;日期&#39;</span><span class="p">,</span> <span class="s1">&#39;股票代號&#39;</span><span class="p">]),</span> <span class="n">right_on</span><span class="o">=</span><span class="p">([</span><span class="s1">&#39;日期&#39;</span><span class="p">,</span> <span class="s1">&#39;股票代號&#39;</span><span class="p">]))</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">price_df</span><span class="p">[</span><span class="s1">&#39;cut&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">qcut</span><span class="p">(</span><span class="n">price_df</span><span class="p">[</span><span class="s1">&#39;last_20Days_ret_0050&#39;</span><span class="p">],</span> <span class="mi">10</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">res</span> <span class="o">=</span> <span class="n">price_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;cut&#39;</span><span class="p">,</span> <span class="s1">&#39;股票代號&#39;</span><span class="p">])[</span><span class="s1">&#39;hold_20Days_ret&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">res</span><span class="p">[</span><span class="s1">&#39;hold_20Days_winrate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">price_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;cut&#39;</span><span class="p">,</span> <span class="s1">&#39;股票代號&#39;</span><span class="p">])[</span><span class="s1">&#39;hold_20Days_winrate&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl"><span class="n">res</span><span class="p">[</span><span class="s1">&#39;signal_count&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">price_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;cut&#39;</span><span class="p">,</span> <span class="s1">&#39;股票代號&#39;</span><span class="p">])[</span><span class="s1">&#39;hold_20Days_winrate&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">count</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">res</span>
</span></span></code></pre></div><pre><code>/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_17654/3876432843.py:2: FutureWarning: The default of observed=False is deprecated and will be changed to True in a future version of pandas. Pass observed=False to retain current behavior or observed=True to adopt the future default and silence this warning.
  res = price_df.groupby(['cut', '股票代號'])['hold_20Days_ret'].mean().reset_index(drop=False)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_17654/3876432843.py:3: FutureWarning: The default of observed=False is deprecated and will be changed to True in a future version of pandas. Pass observed=False to retain current behavior or observed=True to adopt the future default and silence this warning.
  res['hold_20Days_winrate'] = price_df.groupby(['cut', '股票代號'])['hold_20Days_winrate'].mean().reset_index(drop=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_17654/3876432843.py:4: FutureWarning: The default of observed=False is deprecated and will be changed to True in a future version of pandas. Pass observed=False to retain current behavior or observed=True to adopt the future default and silence this warning.
  res['signal_count'] = price_df.groupby(['cut', '股票代號'])['hold_20Days_winrate'].count().reset_index(drop=True)
</code></pre>
<!-- raw HTML omitted -->
<pre><code>.dataframe tbody tr th {
    vertical-align: top;
}

.dataframe thead th {
    text-align: right;
}
</code></pre>
<p><!-- raw HTML omitted --></p>
<!-- raw HTML omitted -->
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">res</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">price_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;股票代號&#39;</span><span class="p">)[</span><span class="s1">&#39;hold_20Days_ret&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">left_on</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;股票代號&#39;</span><span class="p">),</span> <span class="n">right_on</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;股票代號&#39;</span><span class="p">),</span> <span class="n">suffixes</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;_baseline&#39;</span><span class="p">))</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">res</span><span class="p">[</span><span class="s1">&#39;diff_ret&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;hold_20Days_ret&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;hold_20Days_ret_baseline&#39;</span><span class="p">]</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">for</span> <span class="n">ticker</span> <span class="ow">in</span> <span class="n">SUB_TICKERS</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">res</span><span class="p">[</span><span class="s1">&#39;股票代號&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">ticker</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;cut&#39;</span><span class="p">,</span> <span class="s1">&#39;股票代號&#39;</span><span class="p">,</span> <span class="s1">&#39;diff_ret&#39;</span><span class="p">,</span> <span class="s1">&#39;hold_20Days_winrate&#39;</span><span class="p">,</span> <span class="s1">&#39;signal_count&#39;</span><span class="p">]])</span>
</span></span></code></pre></div><pre><code>                     cut  股票代號  diff_ret  hold_20Days_winrate  signal_count
0      (-7.381, -0.0403]  2059    0.0074               0.5253           297
9     (-0.0403, -0.0209]  2059   -0.0003               0.5539           612
18    (-0.0209, -0.0112]  2059   -0.0105               0.5278           612
27   (-0.0112, -0.00457]  2059    0.0055               0.6105           493
36  (-0.00457, 0.000588]  2059   -0.0055               0.5302           464
45    (0.000588, 0.0064]  2059   -0.0165               0.5211           474
54      (0.0064, 0.0132]  2059   -0.0066               0.5511           470
63      (0.0132, 0.0236]  2059    0.0048               0.5630           579
72      (0.0236, 0.0459]  2059    0.0154               0.4592           368
81       (0.0459, 6.477]  2059   -0.0042               0.4848           330
                     cut  股票代號  diff_ret  hold_20Days_winrate  signal_count
5      (-7.381, -0.0403]  3529    0.0076               0.5681           639
14    (-0.0403, -0.0209]  3529    0.0057               0.5977           430
23    (-0.0209, -0.0112]  3529    0.0197               0.6016           251
32   (-0.0112, -0.00457]  3529   -0.0115               0.4541           185
41  (-0.00457, 0.000588]  3529   -0.0182               0.4237           118
50    (0.000588, 0.0064]  3529    0.0286               0.5524           105
59      (0.0064, 0.0132]  3529    0.0080               0.5088           114
68      (0.0132, 0.0236]  3529    0.0233               0.6364           132
77      (0.0236, 0.0459]  3529   -0.0101               0.5516           368
86       (0.0459, 6.477]  3529   -0.0001               0.5152           924
                     cut  股票代號  diff_ret  hold_20Days_winrate  signal_count
2      (-7.381, -0.0403]  2383   -0.0163               0.5163           337
11    (-0.0403, -0.0209]  2383   -0.0155               0.6022           450
20    (-0.0209, -0.0112]  2383    0.0208               0.5992           509
29   (-0.0112, -0.00457]  2383    0.0109               0.6031           456
38  (-0.00457, 0.000588]  2383   -0.0056               0.5408           845
47    (0.000588, 0.0064]  2383    0.0085               0.5935           866
56      (0.0064, 0.0132]  2383    0.0112               0.5605           860
65      (0.0132, 0.0236]  2383   -0.0099               0.4559           601
74      (0.0236, 0.0459]  2383    0.0042               0.4363           314
83       (0.0459, 6.477]  2383    0.0311               0.5296           287
                     cut  股票代號  diff_ret  hold_20Days_winrate  signal_count
1      (-7.381, -0.0403]  2330   -0.0388               0.4315           788
10    (-0.0403, -0.0209]  2330    0.0045               0.5472           424
19    (-0.0209, -0.0112]  2330   -0.0026               0.5797           364
28   (-0.0112, -0.00457]  2330    0.0076               0.6842           741
37  (-0.00457, 0.000588]  2330   -0.0034               0.6103           839
46    (0.000588, 0.0064]  2330   -0.0058               0.5833           768
55      (0.0064, 0.0132]  2330   -0.0045               0.6129           824
64      (0.0132, 0.0236]  2330    0.0027               0.6062           617
73      (0.0236, 0.0459]  2330    0.0221               0.6621           441
82       (0.0459, 6.477]  2330   -0.0033               0.5289           484
                     cut  股票代號  diff_ret  hold_20Days_winrate  signal_count
8      (-7.381, -0.0403]  8069   -0.0083               0.4898           786
17    (-0.0403, -0.0209]  8069    0.0377               0.6390           313
26    (-0.0209, -0.0112]  8069    0.0130               0.5763           321
35   (-0.0112, -0.00457]  8069   -0.0059               0.5538           316
44  (-0.00457, 0.000588]  8069    0.0035               0.5430           256
53    (0.000588, 0.0064]  8069   -0.0044               0.5430           291
62      (0.0064, 0.0132]  8069    0.0173               0.6335           352
71      (0.0132, 0.0236]  8069    0.0035               0.5276           381
80      (0.0236, 0.0459]  8069   -0.0176               0.4596           594
89       (0.0459, 6.477]  8069   -0.0020               0.5591           744
                     cut  股票代號  diff_ret  hold_20Days_winrate  signal_count
7      (-7.381, -0.0403]  5274    0.0202               0.6256           438
16    (-0.0403, -0.0209]  5274   -0.0428               0.5028           179
25    (-0.0209, -0.0112]  5274   -0.0071               0.6331           169
34   (-0.0112, -0.00457]  5274    0.0072               0.6823           192
43  (-0.00457, 0.000588]  5274    0.0079               0.6508           126
52    (0.000588, 0.0064]  5274    0.0453               0.7287           129
61      (0.0064, 0.0132]  5274    0.0348               0.7063           160
70      (0.0132, 0.0236]  5274    0.0197               0.6702           188
79      (0.0236, 0.0459]  5274    0.0036               0.6394           416
88       (0.0459, 6.477]  5274   -0.0205               0.5478           712
                     cut  股票代號  diff_ret  hold_20Days_winrate  signal_count
4      (-7.381, -0.0403]  3008    0.0105               0.4967           449
13    (-0.0403, -0.0209]  3008    0.0191               0.6574           788
22    (-0.0209, -0.0112]  3008    0.0128               0.6181           720
31   (-0.0112, -0.00457]  3008    0.0030               0.5690           652
40  (-0.00457, 0.000588]  3008   -0.0275               0.4177           565
49    (0.000588, 0.0064]  3008   -0.0320               0.3731           453
58      (0.0064, 0.0132]  3008   -0.0063               0.4907           377
67      (0.0132, 0.0236]  3008    0.0032               0.5278           485
76      (0.0236, 0.0459]  3008   -0.0048               0.5455           627
85       (0.0459, 6.477]  3008    0.0236               0.5260           365
                     cut  股票代號  diff_ret  hold_20Days_winrate  signal_count
3      (-7.381, -0.0403]  2454   -0.0014               0.5589           433
12    (-0.0403, -0.0209]  2454   -0.0161               0.4977           663
21    (-0.0209, -0.0112]  2454    0.0020               0.6016           728
30   (-0.0112, -0.00457]  2454   -0.0285               0.4292           643
39  (-0.00457, 0.000588]  2454    0.0040               0.5687           466
48    (0.000588, 0.0064]  2454    0.0165               0.6183           503
57      (0.0064, 0.0132]  2454   -0.0053               0.5879           512
66      (0.0132, 0.0236]  2454    0.0106               0.6314           681
75      (0.0236, 0.0459]  2454   -0.0067               0.5551           726
84       (0.0459, 6.477]  2454   -0.0048               0.5616           276
                     cut  股票代號  diff_ret  hold_20Days_winrate  signal_count
6      (-7.381, -0.0403]  3533   -0.0589               0.2222            36
15    (-0.0403, -0.0209]  3533    0.0147               0.6366           344
24    (-0.0209, -0.0112]  3533    0.0306               0.6929           521
33   (-0.0112, -0.00457]  3533   -0.0040               0.5455           528
42  (-0.00457, 0.000588]  3533   -0.0483               0.3852           527
51    (0.000588, 0.0064]  3533   -0.0313               0.4356           606
60      (0.0064, 0.0132]  3533    0.0060               0.5898           529
69      (0.0132, 0.0236]  3533    0.0259               0.6311           534
78      (0.0236, 0.0459]  3533    0.0143               0.4725           345
87       (0.0459, 6.477]  3533    0.1118               0.8333            78
</code></pre>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Sample data</span>
</span></span><span class="line"><span class="cl"><span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;date&#39;</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="s1">&#39;2025-01-01&#39;</span><span class="p">,</span> <span class="n">periods</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;D&#39;</span><span class="p">),</span>  <span class="c1"># 20 consecutive dates</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">i</span> <span class="o">**</span> <span class="mi">2</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">20</span><span class="p">)]</span>  <span class="c1"># Example values (can be any time series data)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Convert to a DataFrame</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Convert date to numeric (e.g., number of days since the first date)</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="p">[</span><span class="s1">&#39;date_numeric&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">())</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">days</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Function to calculate slope for a window</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">calculate_slope</span><span class="p">(</span><span class="n">window</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">date_numeric</span> <span class="o">=</span> <span class="n">window</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>  <span class="c1"># Extract the first column (date_numeric)</span>
</span></span><span class="line"><span class="cl">    <span class="n">value</span> <span class="o">=</span> <span class="n">window</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>         <span class="c1"># Extract the second column (value)</span>
</span></span><span class="line"><span class="cl">    <span class="n">x_diff</span> <span class="o">=</span> <span class="n">date_numeric</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">date_numeric</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># Time difference</span>
</span></span><span class="line"><span class="cl">    <span class="n">y_diff</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>                <span class="c1"># Value difference</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">y_diff</span> <span class="o">/</span> <span class="n">x_diff</span> <span class="k">if</span> <span class="n">x_diff</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Apply rolling window calculation</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">rolling_slope</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">window_size</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">slopes</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">-</span> <span class="n">window_size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">window</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="n">window_size</span><span class="p">][[</span><span class="s1">&#39;date_numeric&#39;</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">slopes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">calculate_slope</span><span class="p">(</span><span class="n">window</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">window_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">slopes</span>  <span class="c1"># Fill the start with NaNs for alignment</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Add slope to the DataFrame</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="p">[</span><span class="s1">&#39;slope&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rolling_slope</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">window_size</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Output the result</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
</span></span></code></pre></div><pre><code>         date  value  date_numeric   slope
0  2025-01-01      0             0     NaN
1  2025-01-02      1             1     NaN
2  2025-01-03      4             2     NaN
3  2025-01-04      9             3     NaN
4  2025-01-05     16             4  4.0000
5  2025-01-06     25             5  6.0000
6  2025-01-07     36             6  8.0000
7  2025-01-08     49             7 10.0000
8  2025-01-09     64             8 12.0000
9  2025-01-10     81             9 14.0000
10 2025-01-11    100            10 16.0000
11 2025-01-12    121            11 18.0000
12 2025-01-13    144            12 20.0000
13 2025-01-14    169            13 22.0000
14 2025-01-15    196            14 24.0000
15 2025-01-16    225            15 26.0000
16 2025-01-17    256            16 28.0000
17 2025-01-18    289            17 30.0000
18 2025-01-19    324            18 32.0000
19 2025-01-20    361            19 34.0000
</code></pre>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Sample data</span>
</span></span><span class="line"><span class="cl"><span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;date&#39;</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="s1">&#39;2025-01-01&#39;</span><span class="p">,</span> <span class="n">periods</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;D&#39;</span><span class="p">),</span>  <span class="c1"># 20 consecutive dates</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">i</span> <span class="o">**</span> <span class="mi">2</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">20</span><span class="p">)]</span>  <span class="c1"># Example values (can be any time series data)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Convert to a DataFrame</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Convert date to numeric (e.g., number of days since the first date)</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="p">[</span><span class="s1">&#39;date_numeric&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">())</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">days</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Function to calculate slope for a window</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">calculate_slope</span><span class="p">(</span><span class="n">window_df</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">x_diff</span> <span class="o">=</span> <span class="n">window_df</span><span class="p">[</span><span class="s1">&#39;date_numeric&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">window_df</span><span class="p">[</span><span class="s1">&#39;date_numeric&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># Time difference</span>
</span></span><span class="line"><span class="cl">    <span class="n">y_diff</span> <span class="o">=</span> <span class="n">window_df</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">window_df</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>               <span class="c1"># Value difference</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">y_diff</span> <span class="o">/</span> <span class="n">x_diff</span> <span class="k">if</span> <span class="n">x_diff</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Apply rolling window calculation</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">rolling_slope</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">window_size</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">slopes</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">-</span> <span class="n">window_size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">window</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="n">window_size</span><span class="p">]</span>  <span class="c1"># Get the rolling window as a DataFrame</span>
</span></span><span class="line"><span class="cl">        <span class="n">slopes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">calculate_slope</span><span class="p">(</span><span class="n">window</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">window_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">slopes</span>  <span class="c1"># Fill the start with NaNs for alignment</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Add slope to the DataFrame</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="p">[</span><span class="s1">&#39;slope&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rolling_slope</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">window_size</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Output the result</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
</span></span></code></pre></div><pre><code>         date  value  date_numeric   slope
0  2025-01-01      0             0     NaN
1  2025-01-02      1             1     NaN
2  2025-01-03      4             2     NaN
3  2025-01-04      9             3     NaN
4  2025-01-05     16             4  4.0000
5  2025-01-06     25             5  6.0000
6  2025-01-07     36             6  8.0000
7  2025-01-08     49             7 10.0000
8  2025-01-09     64             8 12.0000
9  2025-01-10     81             9 14.0000
10 2025-01-11    100            10 16.0000
11 2025-01-12    121            11 18.0000
12 2025-01-13    144            12 20.0000
13 2025-01-14    169            13 22.0000
14 2025-01-15    196            14 24.0000
15 2025-01-16    225            15 26.0000
16 2025-01-17    256            16 28.0000
17 2025-01-18    289            17 30.0000
18 2025-01-19    324            18 32.0000
19 2025-01-20    361            19 34.0000
</code></pre>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">price_df</span><span class="p">[</span><span class="s1">&#39;date_numeric&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">price_df</span><span class="p">[</span><span class="s1">&#39;日期_dt&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">price_df</span><span class="p">[</span><span class="s1">&#39;日期_dt&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">())</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">days</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">price_df</span><span class="o">.</span><span class="n">columns</span>
</span></span></code></pre></div><pre><code>Index(['日期', '股票代號', '股票名稱', '開盤價', '最高價', '最低價', '收盤價', '漲跌', '漲幅(%)',
       '振幅(%)', '成交量', '成交筆數', '成交金額(千)', '均張', '成交量變動(%)', '均張變動(%)',
       '股本(百萬)', '總市值(億)', '市值比重(%)', '本益比', '股價淨值比', '本益比(近四季)', '週轉率(%)',
       '成交值比重(%)', '漲跌停', 'RTIME', '日期_dt', 'hold_5Days_ret', 'last_5Days_ret',
       'hold_5Days_winrate', 'hold_10Days_ret', 'last_10Days_ret',
       'hold_10Days_winrate', 'hold_20Days_ret', 'last_20Days_ret',
       'hold_20Days_winrate', 'hold_60Days_ret', 'last_60Days_ret',
       'hold_60Days_winrate', 'hold_120Days_ret', 'last_120Days_ret',
       'hold_120Days_winrate', '日期_0050', '股票代號_0050', '股票名稱_0050', '開盤價_0050',
       '最高價_0050', '最低價_0050', '收盤價_0050', '漲跌_0050', '漲幅(%)_0050',
       '振幅(%)_0050', '成交量_0050', '成交筆數_0050', '成交金額(千)_0050', '均張_0050',
       '成交量變動(%)_0050', '均張變動(%)_0050', '股本(百萬)_0050', '總市值(億)_0050',
       '市值比重(%)_0050', '本益比_0050', '股價淨值比_0050', '本益比(近四季)_0050',
       '週轉率(%)_0050', '成交值比重(%)_0050', '漲跌停_0050', 'RTIME_0050',
       'hold_5Days_ret_0050', 'last_5Days_ret_0050', 'hold_5Days_winrate_0050',
       'hold_10Days_ret_0050', 'last_10Days_ret_0050',
       'hold_10Days_winrate_0050', 'hold_20Days_ret_0050',
       'last_20Days_ret_0050', 'hold_20Days_winrate_0050',
       'hold_60Days_ret_0050', 'last_60Days_ret_0050',
       'hold_60Days_winrate_0050', 'hold_120Days_ret_0050',
       'last_120Days_ret_0050', 'hold_120Days_winrate_0050', 'date_numeric'],
      dtype='object')
</code></pre>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># 120日本益比的切線斜率</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Function to calculate slope for a window</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">calculate_slope</span><span class="p">(</span><span class="n">window_df</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">x_diff</span> <span class="o">=</span> <span class="n">window_df</span><span class="p">[</span><span class="s1">&#39;date_numeric&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">window_df</span><span class="p">[</span><span class="s1">&#39;date_numeric&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span> <span class="c1"># Time difference</span>
</span></span><span class="line"><span class="cl">    <span class="n">y_diff</span> <span class="o">=</span> <span class="p">(</span><span class="n">window_df</span><span class="p">[</span><span class="s1">&#39;本益比(近四季)&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">window_df</span><span class="p">[</span><span class="s1">&#39;本益比(近四季)&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span><span class="o">/</span> <span class="n">window_df</span><span class="p">[</span><span class="s1">&#39;本益比(近四季)&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>            <span class="c1"># Value difference</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">y_diff</span> <span class="o">/</span> <span class="n">x_diff</span> <span class="k">if</span> <span class="n">x_diff</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Apply rolling window calculation</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">rolling_slope</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">window_size</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">slopes</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">-</span> <span class="n">window_size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">window</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="n">window_size</span><span class="p">]</span>  <span class="c1"># Get the rolling window as a DataFrame</span>
</span></span><span class="line"><span class="cl">        <span class="n">slopes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">calculate_slope</span><span class="p">(</span><span class="n">window</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;slope_</span><span class="si">{</span><span class="n">window_size</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">window_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">slopes</span>  <span class="c1"># Fill the start with NaNs for alignment</span>
</span></span><span class="line"><span class="cl">    <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;slope_</span><span class="si">{</span><span class="n">window_size</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;slope_</span><span class="si">{</span><span class="n">window_size</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># 本益比用今天的收盤價去計算 明天才知道result</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">df</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Add slope to the DataFrame</span>
</span></span><span class="line"><span class="cl"><span class="c1"># price_df[&#39;slope&#39;] = rolling_slope(price_df, window_size=5)</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">120</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">    <span class="n">price_df</span> <span class="o">=</span> <span class="n">price_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;股票代號&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">df</span> <span class="p">:</span> <span class="n">rolling_slope</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">window_size</span><span class="o">=</span><span class="n">w</span><span class="p">))</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span></code></pre></div><pre><code>/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/2524162785.py:20: DeprecationWarning: DataFrameGroupBy.apply operated on the grouping columns. This behavior is deprecated, and in a future version of pandas the grouping columns will be excluded from the operation. Either pass `include_groups=False` to exclude the groupings or explicitly select the grouping columns after groupby to silence this warning.
  price_df = price_df.groupby('股票代號').apply(lambda df : rolling_slope(df, window_size=w)).reset_index(drop=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/2524162785.py:20: DeprecationWarning: DataFrameGroupBy.apply operated on the grouping columns. This behavior is deprecated, and in a future version of pandas the grouping columns will be excluded from the operation. Either pass `include_groups=False` to exclude the groupings or explicitly select the grouping columns after groupby to silence this warning.
  price_df = price_df.groupby('股票代號').apply(lambda df : rolling_slope(df, window_size=w)).reset_index(drop=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/2524162785.py:20: DeprecationWarning: DataFrameGroupBy.apply operated on the grouping columns. This behavior is deprecated, and in a future version of pandas the grouping columns will be excluded from the operation. Either pass `include_groups=False` to exclude the groupings or explicitly select the grouping columns after groupby to silence this warning.
  price_df = price_df.groupby('股票代號').apply(lambda df : rolling_slope(df, window_size=w)).reset_index(drop=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/2524162785.py:20: DeprecationWarning: DataFrameGroupBy.apply operated on the grouping columns. This behavior is deprecated, and in a future version of pandas the grouping columns will be excluded from the operation. Either pass `include_groups=False` to exclude the groupings or explicitly select the grouping columns after groupby to silence this warning.
  price_df = price_df.groupby('股票代號').apply(lambda df : rolling_slope(df, window_size=w)).reset_index(drop=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/2524162785.py:20: DeprecationWarning: DataFrameGroupBy.apply operated on the grouping columns. This behavior is deprecated, and in a future version of pandas the grouping columns will be excluded from the operation. Either pass `include_groups=False` to exclude the groupings or explicitly select the grouping columns after groupby to silence this warning.
  price_df = price_df.groupby('股票代號').apply(lambda df : rolling_slope(df, window_size=w)).reset_index(drop=True)
</code></pre>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">price_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">price_df</span><span class="p">[</span><span class="s1">&#39;股票代號&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;2330&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;日期&#39;</span><span class="p">,</span><span class="s1">&#39;本益比(近四季)&#39;</span><span class="p">,</span> <span class="s1">&#39;slope_5&#39;</span><span class="p">,</span> <span class="s1">&#39;date_numeric&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">20</span><span class="p">::]</span>
</span></span></code></pre></div><!-- raw HTML omitted -->
<pre><code>.dataframe tbody tr th {
    vertical-align: top;
}

.dataframe thead th {
    text-align: right;
}
</code></pre>
<p><!-- raw HTML omitted --></p>
<!-- raw HTML omitted -->
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="p">((</span><span class="mf">25.6</span><span class="o">-</span><span class="mf">29.5</span><span class="p">)</span><span class="o">/</span><span class="mf">29.5</span><span class="p">)</span><span class="o">/</span><span class="mi">5</span>
</span></span></code></pre></div><pre><code>-0.026440677966101684
</code></pre>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">120</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">120</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">        <span class="n">price_df</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;slope_</span><span class="si">{</span><span class="n">w</span><span class="si">}</span><span class="s1">_rolling_</span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">price_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;股票代號&#39;</span><span class="p">)[</span><span class="sa">f</span><span class="s1">&#39;slope_</span><span class="si">{</span><span class="n">w</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">price_df</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;slope_</span><span class="si">{</span><span class="n">w</span><span class="si">}</span><span class="s1">_rolling_</span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s1">_SUM&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">price_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;股票代號&#39;</span><span class="p">)[</span><span class="sa">f</span><span class="s1">&#39;slope_</span><span class="si">{</span><span class="n">w</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">ret_cols</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;hold_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">Days_ret&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">120</span><span class="p">]]</span>
</span></span><span class="line"><span class="cl"><span class="n">winrate_cols</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;hold_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">Days_winrate&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">120</span><span class="p">]]</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">120</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">120</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="n">price_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">price_df</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;slope_</span><span class="si">{</span><span class="n">w</span><span class="si">}</span><span class="s1">_rolling_</span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">,</span> <span class="n">ret_cols</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># price_df.groupby(&#39;股票代號&#39;).apply(lambda df : rolling_slope(df, window_size=5))</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">w</span> <span class="o">=</span> <span class="mi">60</span>
</span></span><span class="line"><span class="cl"><span class="n">j</span> <span class="o">=</span> <span class="mi">60</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">ticker</span> <span class="ow">in</span> <span class="n">SUB_TICKERS</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">tmp</span> <span class="o">=</span> <span class="n">price_df</span><span class="p">[(</span><span class="n">price_df</span><span class="p">[</span><span class="s1">&#39;股票代號&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">ticker</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">price_df</span><span class="p">[</span><span class="s1">&#39;日期_dt&#39;</span><span class="p">]</span><span class="o">&gt;=</span><span class="s1">&#39;20150101&#39;</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">ax1</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">tmp</span><span class="p">[</span><span class="s1">&#39;本益比(近四季)_rolling5&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">[</span><span class="s1">&#39;本益比(近四季)&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">tmp</span><span class="p">[</span><span class="s1">&#39;日期_dt&#39;</span><span class="p">],</span> <span class="n">tmp</span><span class="p">[</span><span class="s1">&#39;本益比(近四季)_rolling5&#39;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;PE&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">ax2</span> <span class="o">=</span> <span class="n">ax1</span><span class="o">.</span><span class="n">twinx</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">tmp</span><span class="p">[</span><span class="s1">&#39;日期_dt&#39;</span><span class="p">],</span> <span class="n">tmp</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;slope_</span><span class="si">{</span><span class="n">w</span><span class="si">}</span><span class="s1">_rolling_</span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s1">_SUM&#39;</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;PE slope&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">ax3</span> <span class="o">=</span> <span class="n">ax1</span><span class="o">.</span><span class="n">twinx</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">ax3</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">tmp</span><span class="p">[</span><span class="s1">&#39;日期_dt&#39;</span><span class="p">],</span> <span class="n">tmp</span><span class="p">[</span><span class="s1">&#39;收盤價&#39;</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;price&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">ticker</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">indices</span> <span class="o">=</span> <span class="n">tmp</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">tmp</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;slope_</span><span class="si">{</span><span class="n">w</span><span class="si">}</span><span class="s1">_rolling_</span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s1">_SUM&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mf">0.02</span><span class="p">),</span> <span class="s1">&#39;日期_dt&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># Plot vertical lines</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">ax2</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">vector_backtest</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># input: df, 需要有signa columns, output : [[trade_data1], [trade_data2], ...] (list中包含多個list)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># df[&#39;signal&#39;] != df[&#39;signal&#39;].shift(1) 會return boolean, 對此用cumsum</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 在false的時候 就不會+1 就可以讓連續的組出現一樣的數字</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># [0  , 1, 1, 0, 0, 1, 1, 1] (df[&#39;signal&#39;])</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># [nan, 0, 1, 1, 0, 0, 1, 1] (df[&#39;signal&#39;].shift(1))</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># [T, T, F, T, F, T, F, F] -&gt; [1, 2, 2, 3, 3, 4, 4, 4]</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 然而連續組 同時包含signal==1 &amp; signal==0 部分</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 利用df[signal]==1 來取得signal==1的index</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;日期&#39;</span><span class="p">,</span> <span class="s1">&#39;股票代號&#39;</span><span class="p">,</span> <span class="s1">&#39;收盤價&#39;</span><span class="p">,</span> <span class="s1">&#39;signal&#39;</span><span class="p">]):</span>
</span></span><span class="line"><span class="cl">        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s2">&#34;df.columns should have 日期, 股票代號, 收盤價, signal&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;次日收盤價&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;收盤價&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;次二日收盤價&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;收盤價&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 將所有連續的事件相同數字表示, 而事件轉換時, 數字不相同</span>
</span></span><span class="line"><span class="cl">    <span class="n">change_indices</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span> 
</span></span><span class="line"><span class="cl">    <span class="c1"># 只想要group signal==1的事件</span>
</span></span><span class="line"><span class="cl">    <span class="n">groups</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">change_indices</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="n">event_list_all</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;&#39;&#39;
</span></span></span><span class="line"><span class="cl"><span class="s1">        盤後才知道訊號, 故操作都會在後續日期...
</span></span></span><span class="line"><span class="cl"><span class="s1">        訊號開始日期(start_date): 該日收盤後有符合訊號, 故買入價會是隔一日的收盤價
</span></span></span><span class="line"><span class="cl"><span class="s1">        訊號最後日期(end_date): 代表隔日收盤後就無訊號, 故賣出價是訊號最後日的隔二日收盤價
</span></span></span><span class="line"><span class="cl"><span class="s1">        ex: date=[10/1, 10/2, 10/3, 10/4], signal = [1, 1, 0, 0]
</span></span></span><span class="line"><span class="cl"><span class="s1">        則10/1為訊號開始日期 -&gt; 10/2收盤價買入
</span></span></span><span class="line"><span class="cl"><span class="s1">        10/2為訊號最後日期 -&gt; 10/3收盤才知道訊號結束 -&gt; 10/4收盤賣出 
</span></span></span><span class="line"><span class="cl"><span class="s1">        &#39;&#39;&#39;</span>
</span></span><span class="line"><span class="cl">        <span class="n">com_code</span> <span class="o">=</span> <span class="n">group</span><span class="p">[</span><span class="s1">&#39;股票代號&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="n">start_date</span> <span class="o">=</span> <span class="n">group</span><span class="p">[</span><span class="s1">&#39;日期&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="n">end_date</span> <span class="o">=</span> <span class="n">group</span><span class="p">[</span><span class="s1">&#39;日期&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="n">buy_price</span> <span class="o">=</span> <span class="n">group</span><span class="p">[</span><span class="s1">&#39;次日收盤價&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="n">sell_price</span> <span class="o">=</span> <span class="n">group</span><span class="p">[</span><span class="s1">&#39;次二日收盤價&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="n">ret</span> <span class="o">=</span> <span class="p">(</span><span class="n">sell_price</span><span class="o">/</span><span class="n">buy_price</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">        <span class="n">holding_days</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">group</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">event_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">com_code</span><span class="p">,</span> <span class="n">start_date</span><span class="p">,</span> <span class="n">end_date</span><span class="p">,</span> <span class="n">buy_price</span><span class="p">,</span> <span class="n">sell_price</span><span class="p">,</span> <span class="n">ret</span><span class="p">,</span> <span class="n">holding_days</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="n">event_list_all</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">event_list</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">event_list_all</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;slope_</span><span class="si">{</span><span class="n">w</span><span class="si">}</span><span class="s1">_rolling_</span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s1">_SUM&#39;</span><span class="p">)</span>
</span></span></code></pre></div><pre><code>slope_60_rolling_60_SUM
</code></pre>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">price_df</span><span class="p">[</span><span class="s1">&#39;本益比_rolling5&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">price_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;股票代號&#39;</span><span class="p">)[</span><span class="s1">&#39;本益比(近四季)&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">price_df</span><span class="p">[</span><span class="s1">&#39;本益比_rolling20&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">price_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;股票代號&#39;</span><span class="p">)[</span><span class="s1">&#39;本益比(近四季)&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span></code></pre></div><h2 id="看起來本益比切線斜率-累積增加0-對捕捉上升趨勢還不錯">看起來本益比切線斜率 累積增加&gt;0 對捕捉上升趨勢還不錯</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">price_df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">w</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">60</span>
</span></span><span class="line"><span class="cl"><span class="n">price_df</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="c1"># &amp; (price_df[&#39;本益比_rolling5&#39;]&gt;=price_df[&#39;本益比_rolling20&#39;])</span>
</span></span><span class="line"><span class="cl"><span class="c1">#  | (price_df[f&#39;slope_{w}&#39;] &lt; price_df[f&#39;slope_{w}_rolling_{j}&#39;])</span>
</span></span><span class="line"><span class="cl"><span class="n">price_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">price_df</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;slope_</span><span class="si">{</span><span class="n">w</span><span class="si">}</span><span class="s1">_rolling_</span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s1">_SUM&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.02</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">price_df</span><span class="p">[</span><span class="s1">&#39;last_20Days_ret_0050&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">,</span> <span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">res_list</span> <span class="o">=</span> <span class="n">price_df</span><span class="p">[(</span><span class="n">price_df</span><span class="p">[</span><span class="s1">&#39;日期_dt&#39;</span><span class="p">]</span><span class="o">&gt;=</span><span class="s1">&#39;20150101&#39;</span><span class="p">)]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;股票代號&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">vector_backtest</span><span class="p">)</span>
</span></span></code></pre></div><pre><code>/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/312944587.py:6: DeprecationWarning: DataFrameGroupBy.apply operated on the grouping columns. This behavior is deprecated, and in a future version of pandas the grouping columns will be excluded from the operation. Either pass `include_groups=False` to exclude the groupings or explicitly select the grouping columns after groupby to silence this warning.
  res_list = price_df[(price_df['日期_dt']&gt;='20150101')].groupby('股票代號').apply(vector_backtest)
</code></pre>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">price_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">price_df</span><span class="p">[</span><span class="s1">&#39;last_20Days_ret_0050&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">price_df</span><span class="p">[</span><span class="s1">&#39;last_60Days_ret_0050&#39;</span><span class="p">]),</span> <span class="n">ret_cols</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</span></span></code></pre></div><pre><code>hold_5Days_ret     0.0080
hold_10Days_ret    0.0148
hold_20Days_ret    0.0310
hold_60Days_ret    0.0807
hold_120Days_ret   0.1454
dtype: float64
</code></pre>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">price_df</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="c1"># &amp; (price_df[&#39;本益比_rolling5&#39;]&gt;=price_df[&#39;本益比_rolling20&#39;])</span>
</span></span><span class="line"><span class="cl"><span class="n">price_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">price_df</span><span class="p">[</span><span class="s1">&#39;last_20Days_ret_0050&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">price_df</span><span class="p">[</span><span class="s1">&#39;last_60Days_ret_0050&#39;</span><span class="p">]),</span> <span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">res_list</span> <span class="o">=</span> <span class="n">price_df</span><span class="p">[(</span><span class="n">price_df</span><span class="p">[</span><span class="s1">&#39;日期_dt&#39;</span><span class="p">]</span><span class="o">&gt;=</span><span class="s1">&#39;20150101&#39;</span><span class="p">)]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;股票代號&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">vector_backtest</span><span class="p">)</span>
</span></span></code></pre></div><pre><code>/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/3156983121.py:4: DeprecationWarning: DataFrameGroupBy.apply operated on the grouping columns. This behavior is deprecated, and in a future version of pandas the grouping columns will be excluded from the operation. Either pass `include_groups=False` to exclude the groupings or explicitly select the grouping columns after groupby to silence this warning.
  res_list = price_df[(price_df['日期_dt']&gt;='20150101')].groupby('股票代號').apply(vector_backtest)
</code></pre>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">w</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">60</span>
</span></span><span class="line"><span class="cl"><span class="n">price_df</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="c1"># &amp; (price_df[&#39;本益比_rolling5&#39;]&gt;=price_df[&#39;本益比_rolling20&#39;])</span>
</span></span><span class="line"><span class="cl"><span class="n">price_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">price_df</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;slope_</span><span class="si">{</span><span class="n">w</span><span class="si">}</span><span class="s1">_rolling_</span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s1">_SUM&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.02</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">price_df</span><span class="p">[</span><span class="s1">&#39;last_60Days_ret_0050&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="o">-</span><span class="mf">0.1</span><span class="p">)</span> <span class="p">,</span> <span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">res_list</span> <span class="o">=</span> <span class="n">price_df</span><span class="p">[(</span><span class="n">price_df</span><span class="p">[</span><span class="s1">&#39;日期_dt&#39;</span><span class="p">]</span><span class="o">&gt;=</span><span class="s1">&#39;20150101&#39;</span><span class="p">)]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;股票代號&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">vector_backtest</span><span class="p">)</span>
</span></span></code></pre></div><pre><code>/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_17654/95528996.py:5: DeprecationWarning: DataFrameGroupBy.apply operated on the grouping columns. This behavior is deprecated, and in a future version of pandas the grouping columns will be excluded from the operation. Either pass `include_groups=False` to exclude the groupings or explicitly select the grouping columns after groupby to silence this warning.
  res_list = price_df[(price_df['日期_dt']&gt;='20150101')].groupby('股票代號').apply(vector_backtest)
</code></pre>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">price_df</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="o">-</span><span class="mi">140</span><span class="p">:</span><span class="o">-</span><span class="mi">120</span><span class="p">]</span>
</span></span></code></pre></div><pre><code>Index(['收盤價', '漲跌', '漲幅(%)', '振幅(%)', '成交量', '成交筆數', '成交金額(千)', '均張',
       '成交量變動(%)', '均張變動(%)', '股本(百萬)', '總市值(億)', '市值比重(%)', '本益比', '股價淨值比',
       '本益比(近四季)', '週轉率(%)', '成交值比重(%)', '漲跌停', 'RTIME'],
      dtype='object')
</code></pre>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">price_df</span><span class="p">[</span><span class="s1">&#39;20MA&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">price_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;股票代號&#39;</span><span class="p">)[</span><span class="s1">&#39;收盤價&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">price_df</span><span class="p">[</span><span class="s1">&#39;60MA&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">price_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;股票代號&#39;</span><span class="p">)[</span><span class="s1">&#39;收盤價&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">price_df</span><span class="p">[</span><span class="s1">&#39;200MA&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">price_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;股票代號&#39;</span><span class="p">)[</span><span class="s1">&#39;收盤價&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span></code></pre></div><h2 id="local-minima-maxima">Local Minima, maxima</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">scipy.signal</span> <span class="kn">import</span> <span class="n">argrelextrema</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">groupby_extrema</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">col</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 1. Identify Local Minima and Maxima</span>
</span></span><span class="line"><span class="cl">    <span class="n">window</span> <span class="o">=</span> <span class="mi">10</span>  <span class="c1"># Window size for extrema detection</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">local_max_indices</span> <span class="o">=</span> <span class="n">argrelextrema</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">greater</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="n">window</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">local_min_indices</span> <span class="o">=</span> <span class="n">argrelextrema</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">less</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="n">window</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Extract local maxima and minima, ensuring proper alignment (avoid leakage)</span>
</span></span><span class="line"><span class="cl">    <span class="n">local_maxima</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">local_max_indices</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">local_max_indices</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">local_minima</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">local_min_indices</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">local_min_indices</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Step 2: Compare successive maxima</span>
</span></span><span class="line"><span class="cl">    <span class="n">max_comparisons_larger_idx</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">    <span class="n">max_comparisons_smaller_idx</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">local_maxima</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">local_maxima</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">current_max</span> <span class="o">=</span> <span class="n">local_maxima</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="n">next_max</span> <span class="o">=</span> <span class="n">local_maxima</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">next_max</span> <span class="o">&gt;</span> <span class="n">current_max</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">max_comparisons_larger_idx</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">local_maxima</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">max_comparisons_smaller_idx</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">local_maxima</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;max_comparisons_larger&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">    <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">max_comparisons_larger_idx</span><span class="p">,</span> <span class="s1">&#39;max_comparisons_larger&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">max_comparisons_smaller_idx</span><span class="p">,</span> <span class="s1">&#39;max_comparisons_larger&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;max_comparisons_larger&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">ffill</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;max_comparisons_larger&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;max_comparisons_larger&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="n">window</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;local_maxima&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">    <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">max_comparisons_larger_idx</span><span class="p">,</span> <span class="s1">&#39;local_maxima&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">local_maxima</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">max_comparisons_larger_idx</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;local_maxima&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">ffill</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;local_maxima&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;local_maxima&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="n">window</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">df</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1">## 反向 股價跌破 local minima 又這個local minima &lt; 上一個 在谷底的感覺</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">groupby_extrema_sup</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">col</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 1. Identify Local Minima and Maxima</span>
</span></span><span class="line"><span class="cl">    <span class="n">window</span> <span class="o">=</span> <span class="mi">10</span>  <span class="c1"># Window size for extrema detection</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">local_max_indices</span> <span class="o">=</span> <span class="n">argrelextrema</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">greater</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="n">window</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">local_min_indices</span> <span class="o">=</span> <span class="n">argrelextrema</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">less</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="n">window</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Extract local maxima and minima, ensuring proper alignment (avoid leakage)</span>
</span></span><span class="line"><span class="cl">    <span class="n">local_maxima</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">local_max_indices</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">local_max_indices</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">local_minima</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">local_min_indices</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">local_min_indices</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># print(local_minima)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Step 2: Compare successive maxima</span>
</span></span><span class="line"><span class="cl">    <span class="n">min_comparisons_larger_idx</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">    <span class="n">min_comparisons_smaller_idx</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">local_minima</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">local_minima</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">current_min</span> <span class="o">=</span> <span class="n">local_minima</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="n">next_min</span> <span class="o">=</span> <span class="n">local_minima</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">next_min</span> <span class="o">&lt;</span> <span class="n">current_min</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">min_comparisons_smaller_idx</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">local_minima</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">min_comparisons_larger_idx</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">local_minima</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="n">min_comparisons_smaller_idx</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;min_comparisons_smaller&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">    <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">min_comparisons_smaller_idx</span><span class="p">,</span> <span class="s1">&#39;min_comparisons_smaller&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">min_comparisons_larger_idx</span><span class="p">,</span> <span class="s1">&#39;min_comparisons_smaller&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;min_comparisons_smaller&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">ffill</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;min_comparisons_smaller&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;min_comparisons_smaller&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="n">window</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;local_minima&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">    <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">min_comparisons_smaller_idx</span><span class="p">,</span> <span class="s1">&#39;local_minima&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">local_minima</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">min_comparisons_smaller_idx</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;local_minima&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">ffill</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;local_minima&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;local_minima&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="n">window</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">df</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">w</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">60</span>
</span></span><span class="line"><span class="cl"><span class="n">price_df</span> <span class="o">=</span> <span class="n">price_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;股票代號&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">df</span> <span class="p">:</span> <span class="n">groupby_extrema</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;slope_</span><span class="si">{</span><span class="n">w</span><span class="si">}</span><span class="s1">_rolling_</span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s1">_SUM&#39;</span><span class="p">))</span>
</span></span></code></pre></div><pre><code>/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:29: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:29: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:34: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['local_maxima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:34: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['local_maxima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:29: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:29: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:34: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['local_maxima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:34: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['local_maxima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:29: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:29: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:34: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['local_maxima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:34: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['local_maxima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:29: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:29: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:34: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['local_maxima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:34: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['local_maxima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:29: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:29: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:34: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['local_maxima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:34: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['local_maxima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:29: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:29: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:34: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['local_maxima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:34: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['local_maxima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:29: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:29: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:34: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['local_maxima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:34: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['local_maxima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:29: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:29: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:34: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['local_maxima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:34: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['local_maxima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:29: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:29: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:34: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['local_maxima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:34: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['local_maxima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/2373799201.py:2: DeprecationWarning: DataFrameGroupBy.apply operated on the grouping columns. This behavior is deprecated, and in a future version of pandas the grouping columns will be excluded from the operation. Either pass `include_groups=False` to exclude the groupings or explicitly select the grouping columns after groupby to silence this warning.
  price_df = price_df.groupby('股票代號').apply(lambda df : groupby_extrema(df, f'slope_{w}_rolling_{j}_SUM'))
</code></pre>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">w</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">60</span>
</span></span><span class="line"><span class="cl"><span class="n">price_df</span> <span class="o">=</span> <span class="n">price_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;股票代號&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">df</span> <span class="p">:</span> <span class="n">groupby_extrema_sup</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;slope_</span><span class="si">{</span><span class="n">w</span><span class="si">}</span><span class="s1">_rolling_</span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s1">_SUM&#39;</span><span class="p">))</span>
</span></span></code></pre></div><pre><code>[np.int64(647), np.int64(727), np.int64(916), np.int64(1198), np.int64(1314), np.int64(1388), np.int64(1801), np.int64(2151), np.int64(2358), np.int64(2549), np.int64(2999), np.int64(3101), np.int64(3290), np.int64(4081), np.int64(4249), np.int64(4392), np.int64(4752)]
[np.int64(388), np.int64(960), np.int64(1098), np.int64(1504), np.int64(1633), np.int64(1760), np.int64(2227), np.int64(2331), np.int64(2519), np.int64(2642), np.int64(2956), np.int64(3136), np.int64(3325), np.int64(3444), np.int64(3646), np.int64(3675), np.int64(3740), np.int64(4131), np.int64(4369), np.int64(4417), np.int64(4677), np.int64(4757), np.int64(4858), np.int64(4902), np.int64(5019), np.int64(5178), np.int64(5262), np.int64(5381), np.int64(5749), np.int64(6100), np.int64(6562), np.int64(6835), np.int64(6941), np.int64(7077), np.int64(7161)]
[np.int64(799), np.int64(1099), np.int64(2475), np.int64(2879), np.int64(2999), np.int64(3090), np.int64(3347), np.int64(3469), np.int64(3750), np.int64(4090), np.int64(4196), np.int64(4293), np.int64(4472), np.int64(4599), np.int64(4716), np.int64(4844), np.int64(5076), np.int64(5188), np.int64(5317), np.int64(5535), np.int64(5556), np.int64(5818), np.int64(5899), np.int64(6264), np.int64(6430), np.int64(6451), np.int64(6795), np.int64(6893)]
[np.int64(380), np.int64(624), np.int64(749), np.int64(1254), np.int64(1441), np.int64(1629), np.int64(1859), np.int64(2107), np.int64(2236), np.int64(2638), np.int64(2710), np.int64(2894), np.int64(2993), np.int64(3240), np.int64(3541), np.int64(3848), np.int64(4122), np.int64(4240), np.int64(4639), np.int64(4952), np.int64(5171), np.int64(5380), np.int64(5662), np.int64(5684), np.int64(5735)]
[np.int64(345), np.int64(628), np.int64(1091), np.int64(1513), np.int64(1715), np.int64(1910), np.int64(1946), np.int64(2023), np.int64(2086), np.int64(2190), np.int64(2438), np.int64(2813), np.int64(3199), np.int64(3389), np.int64(3426), np.int64(3459), np.int64(3681), np.int64(3819), np.int64(3965), np.int64(4515), np.int64(4766), np.int64(4890), np.int64(5135), np.int64(5230), np.int64(5349), np.int64(5502)]
[np.int64(374), np.int64(465), np.int64(598), np.int64(624), np.int64(1017), np.int64(1173), np.int64(1588), np.int64(1710), np.int64(1939), np.int64(2157), np.int64(2286), np.int64(2761), np.int64(2816), np.int64(3084), np.int64(3111), np.int64(3293)]
[np.int64(653), np.int64(953), np.int64(1046), np.int64(1150), np.int64(1469), np.int64(1596), np.int64(1628), np.int64(1706), np.int64(1826), np.int64(1922), np.int64(2362), np.int64(2518), np.int64(2731), np.int64(3190), np.int64(3637), np.int64(3741), np.int64(3757), np.int64(3873), np.int64(4145)]
[np.int64(318), np.int64(534), np.int64(796), np.int64(1031), np.int64(1068), np.int64(1110), np.int64(1153), np.int64(1328), np.int64(1394), np.int64(1716), np.int64(1835), np.int64(2269)]
[np.int64(765), np.int64(952), np.int64(1659), np.int64(1962), np.int64(2577), np.int64(3066), np.int64(3310), np.int64(3626), np.int64(3773), np.int64(3796), np.int64(3961), np.int64(4354), np.int64(4559), np.int64(4661), np.int64(4841)]


/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:32: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['min_comparisons_smaller'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:32: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['min_comparisons_smaller'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:37: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['local_minima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:37: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['local_minima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:32: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['min_comparisons_smaller'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:32: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['min_comparisons_smaller'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:37: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['local_minima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:37: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['local_minima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:32: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['min_comparisons_smaller'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:32: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['min_comparisons_smaller'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:37: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['local_minima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:37: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['local_minima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:32: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['min_comparisons_smaller'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:32: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['min_comparisons_smaller'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:37: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['local_minima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:37: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['local_minima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:32: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['min_comparisons_smaller'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:32: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['min_comparisons_smaller'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:37: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['local_minima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:37: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['local_minima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:32: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['min_comparisons_smaller'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:32: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['min_comparisons_smaller'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:37: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['local_minima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:37: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['local_minima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:32: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['min_comparisons_smaller'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:32: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['min_comparisons_smaller'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:37: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['local_minima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:37: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['local_minima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:32: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['min_comparisons_smaller'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:32: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['min_comparisons_smaller'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:37: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['local_minima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:37: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['local_minima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:32: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['min_comparisons_smaller'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:32: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['min_comparisons_smaller'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:37: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['local_minima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:37: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['local_minima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/3911248321.py:2: DeprecationWarning: DataFrameGroupBy.apply operated on the grouping columns. This behavior is deprecated, and in a future version of pandas the grouping columns will be excluded from the operation. Either pass `include_groups=False` to exclude the groupings or explicitly select the grouping columns after groupby to silence this warning.
  price_df = price_df.groupby('股票代號').apply(lambda df : groupby_extrema_sup(df, f'slope_{w}_rolling_{j}_SUM'))
</code></pre>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">w</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">60</span>
</span></span><span class="line"><span class="cl"><span class="n">price_df</span> <span class="o">=</span> <span class="n">price_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;股票代號&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">df</span> <span class="p">:</span> <span class="n">groupby_extrema</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="s1">&#39;收盤價&#39;</span><span class="p">))</span>
</span></span></code></pre></div><pre><code>/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:29: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:29: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:34: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['local_maxima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:34: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['local_maxima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:29: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:29: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:34: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['local_maxima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:34: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['local_maxima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:29: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:29: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:34: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['local_maxima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:34: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['local_maxima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:29: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:29: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:34: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['local_maxima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:34: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['local_maxima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:29: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:29: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:34: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['local_maxima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:34: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['local_maxima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:29: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:29: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:34: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['local_maxima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:34: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['local_maxima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:29: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:29: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:34: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['local_maxima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:34: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['local_maxima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:29: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:29: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:34: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['local_maxima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:34: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['local_maxima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:29: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:29: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:34: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['local_maxima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/326216370.py:34: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['local_maxima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/2624941152.py:2: DeprecationWarning: DataFrameGroupBy.apply operated on the grouping columns. This behavior is deprecated, and in a future version of pandas the grouping columns will be excluded from the operation. Either pass `include_groups=False` to exclude the groupings or explicitly select the grouping columns after groupby to silence this warning.
  price_df = price_df.groupby('股票代號').apply(lambda df : groupby_extrema(df, '收盤價'))
</code></pre>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">w</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">60</span>
</span></span><span class="line"><span class="cl"><span class="n">price_df</span> <span class="o">=</span> <span class="n">price_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;股票代號&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">df</span> <span class="p">:</span> <span class="n">groupby_extrema_sup</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="s1">&#39;收盤價&#39;</span><span class="p">))</span>
</span></span></code></pre></div><pre><code>[np.int64(204), np.int64(287), np.int64(387), np.int64(690), np.int64(886), np.int64(1026), np.int64(1259), np.int64(1299), np.int64(1369), np.int64(1471), np.int64(1508), np.int64(1530), np.int64(1583), np.int64(1742), np.int64(2029), np.int64(2081), np.int64(2308), np.int64(2343), np.int64(2501), np.int64(2543), np.int64(2626), np.int64(2713), np.int64(2737), np.int64(2794), np.int64(3012), np.int64(3029), np.int64(3053), np.int64(3107), np.int64(3157), np.int64(3169), np.int64(3267), np.int64(3314), np.int64(3345), np.int64(3420), np.int64(3452), np.int64(3475), np.int64(3494), np.int64(3681), np.int64(3819), np.int64(4028), np.int64(4159), np.int64(4193), np.int64(4316), np.int64(4338), np.int64(4367), np.int64(4410), np.int64(4563), np.int64(4706), np.int64(4746), np.int64(4790)]
[np.int64(40), np.int64(133), np.int64(185), np.int64(258), np.int64(317), np.int64(343), np.int64(386), np.int64(431), np.int64(615), np.int64(904), np.int64(943), np.int64(1029), np.int64(1069), np.int64(1159), np.int64(1224), np.int64(1537), np.int64(1562), np.int64(1646), np.int64(1704), np.int64(1757), np.int64(1797), np.int64(1823), np.int64(1875), np.int64(1896), np.int64(1942), np.int64(2037), np.int64(2083), np.int64(2110), np.int64(2125), np.int64(2149), np.int64(2193), np.int64(2253), np.int64(2277), np.int64(2491), np.int64(2553), np.int64(2592), np.int64(2616), np.int64(2641), np.int64(2704), np.int64(2912), np.int64(2930), np.int64(2948), np.int64(3039), np.int64(3102), np.int64(3284), np.int64(3333), np.int64(3400), np.int64(3470), np.int64(3508), np.int64(3668), np.int64(3695), np.int64(3713), np.int64(3951), np.int64(4018), np.int64(4088), np.int64(4291), np.int64(4359), np.int64(4375), np.int64(4390), np.int64(4593), np.int64(4802), np.int64(4895), np.int64(4960), np.int64(5006), np.int64(5243), np.int64(5336), np.int64(5389), np.int64(5488), np.int64(5564), np.int64(5962), np.int64(6047), np.int64(6086), np.int64(6169), np.int64(6187), np.int64(6219), np.int64(6310), np.int64(6506), np.int64(6636), np.int64(6754), np.int64(6786), np.int64(6856), np.int64(6991), np.int64(7030), np.int64(7068), np.int64(7145), np.int64(7262), np.int64(7367), np.int64(7573)]
[np.int64(96), np.int64(147), np.int64(203), np.int64(240), np.int64(401), np.int64(468), np.int64(587), np.int64(715), np.int64(789), np.int64(1042), np.int64(1190), np.int64(1235), np.int64(1283), np.int64(1432), np.int64(1463), np.int64(1489), np.int64(1530), np.int64(1632), np.int64(1646), np.int64(1669), np.int64(1894), np.int64(1986), np.int64(2041), np.int64(2101), np.int64(2167), np.int64(2263), np.int64(2449), np.int64(2622), np.int64(2822), np.int64(2847), np.int64(2976), np.int64(3006), np.int64(3078), np.int64(3287), np.int64(3307), np.int64(3349), np.int64(3437), np.int64(3543), np.int64(3629), np.int64(3673), np.int64(3693), np.int64(3710), np.int64(3737), np.int64(3820), np.int64(3890), np.int64(4051), np.int64(4140), np.int64(4164), np.int64(4193), np.int64(4274), np.int64(4496), np.int64(4577), np.int64(4681), np.int64(4806), np.int64(4827), np.int64(5003), np.int64(5026), np.int64(5273), np.int64(5294), np.int64(5333), np.int64(5387), np.int64(5430), np.int64(5477), np.int64(5508), np.int64(5742), np.int64(5760), np.int64(5812), np.int64(5844), np.int64(5999), np.int64(6123), np.int64(6411), np.int64(6484), np.int64(6574), np.int64(6600), np.int64(6702), np.int64(6727), np.int64(6777), np.int64(6840), np.int64(6911)]
[np.int64(215), np.int64(229), np.int64(247), np.int64(390), np.int64(584), np.int64(692), np.int64(789), np.int64(833), np.int64(875), np.int64(1018), np.int64(1058), np.int64(1121), np.int64(1136), np.int64(1196), np.int64(1216), np.int64(1234), np.int64(1317), np.int64(1588), np.int64(1622), np.int64(1729), np.int64(1818), np.int64(1829), np.int64(2054), np.int64(2120), np.int64(2193), np.int64(2220), np.int64(2295), np.int64(2394), np.int64(2421), np.int64(2459), np.int64(2476), np.int64(2493), np.int64(2673), np.int64(2817), np.int64(2850), np.int64(2959), np.int64(3232), np.int64(3282), np.int64(3419), np.int64(3494), np.int64(3594), np.int64(3608), np.int64(3664), np.int64(3754), np.int64(3793), np.int64(3845), np.int64(4071), np.int64(4196), np.int64(4214), np.int64(4229), np.int64(4275), np.int64(4324), np.int64(4611), np.int64(4961), np.int64(4997), np.int64(5096), np.int64(5125), np.int64(5173), np.int64(5233), np.int64(5367), np.int64(5429), np.int64(5549), np.int64(5607)]


/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:32: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['min_comparisons_smaller'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:32: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['min_comparisons_smaller'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:37: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['local_minima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:37: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['local_minima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:32: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['min_comparisons_smaller'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:32: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['min_comparisons_smaller'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:37: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['local_minima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:37: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['local_minima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:32: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['min_comparisons_smaller'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:32: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['min_comparisons_smaller'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:37: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['local_minima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:37: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['local_minima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:32: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['min_comparisons_smaller'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:32: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['min_comparisons_smaller'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:37: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['local_minima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:37: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['local_minima'].ffill(inplace=True)


[np.int64(86), np.int64(106), np.int64(213), np.int64(429), np.int64(450), np.int64(573), np.int64(592), np.int64(639), np.int64(718), np.int64(1006), np.int64(1066), np.int64(1146), np.int64(1188), np.int64(1217), np.int64(1241), np.int64(1277), np.int64(1472), np.int64(1580), np.int64(1650), np.int64(1679), np.int64(1775), np.int64(1854), np.int64(1965), np.int64(2041), np.int64(2244), np.int64(2354), np.int64(2387), np.int64(2428), np.int64(2507), np.int64(2524), np.int64(2648), np.int64(2708), np.int64(2769), np.int64(2828), np.int64(2868), np.int64(3122), np.int64(3142), np.int64(3332), np.int64(3355), np.int64(3370), np.int64(3423), np.int64(3438), np.int64(3644), np.int64(3742), np.int64(3858), np.int64(3932), np.int64(3950), np.int64(3985), np.int64(4114), np.int64(4136), np.int64(4154), np.int64(4174), np.int64(4271), np.int64(4461), np.int64(4573), np.int64(4602), np.int64(4671), np.int64(4805), np.int64(4847), np.int64(4963), np.int64(4982), np.int64(5085), np.int64(5457), np.int64(5559), np.int64(5594)]
[np.int64(63), np.int64(113), np.int64(163), np.int64(232), np.int64(292), np.int64(338), np.int64(349), np.int64(424), np.int64(436), np.int64(451), np.int64(520), np.int64(531), np.int64(640), np.int64(671), np.int64(1002), np.int64(1117), np.int64(1129), np.int64(1300), np.int64(1344), np.int64(1529), np.int64(1554), np.int64(1632), np.int64(1645), np.int64(1661), np.int64(1738), np.int64(1798), np.int64(1881), np.int64(1923), np.int64(2102), np.int64(2175), np.int64(2214), np.int64(2246), np.int64(2363), np.int64(2593), np.int64(2704), np.int64(2759), np.int64(2812), np.int64(3083), np.int64(3175), np.int64(3245), np.int64(3313)]
[np.int64(123), np.int64(149), np.int64(219), np.int64(260), np.int64(280), np.int64(608), np.int64(637), np.int64(727), np.int64(813), np.int64(894), np.int64(921), np.int64(997), np.int64(1090), np.int64(1115), np.int64(1235), np.int64(1275), np.int64(1370), np.int64(1384), np.int64(1482), np.int64(1502), np.int64(1654), np.int64(1826), np.int64(1838), np.int64(1865), np.int64(1896), np.int64(2014), np.int64(2086), np.int64(2190), np.int64(2208), np.int64(2302), np.int64(2471), np.int64(2513), np.int64(2569), np.int64(2583), np.int64(2681), np.int64(2821), np.int64(2838), np.int64(3028), np.int64(3096), np.int64(3264), np.int64(3308), np.int64(3377), np.int64(3513), np.int64(3590), np.int64(3668), np.int64(3728), np.int64(3814), np.int64(3853), np.int64(3908), np.int64(4095)]
[np.int64(38), np.int64(114), np.int64(255), np.int64(302), np.int64(314), np.int64(335), np.int64(674), np.int64(778), np.int64(922), np.int64(1079), np.int64(1276), np.int64(1310), np.int64(1342), np.int64(1486), np.int64(1781), np.int64(1968), np.int64(2036), np.int64(2161), np.int64(2174), np.int64(2223), np.int64(2255), np.int64(2276), np.int64(2310), np.int64(2328), np.int64(2444), np.int64(2476), np.int64(2498), np.int64(2520), np.int64(2659), np.int64(2826)]
[np.int64(59), np.int64(146), np.int64(176), np.int64(272), np.int64(395), np.int64(475), np.int64(553), np.int64(571), np.int64(659), np.int64(901), np.int64(960), np.int64(1056), np.int64(1080), np.int64(1112), np.int64(1139), np.int64(1491), np.int64(1530), np.int64(1555), np.int64(1733), np.int64(1809), np.int64(1925), np.int64(1940), np.int64(2024), np.int64(2035), np.int64(2156), np.int64(2201), np.int64(2304), np.int64(2334), np.int64(2395), np.int64(2528), np.int64(2578), np.int64(2629), np.int64(2651), np.int64(2763), np.int64(2811), np.int64(2831), np.int64(2908), np.int64(2930), np.int64(3133), np.int64(3285), np.int64(3345), np.int64(3451), np.int64(3500), np.int64(3582), np.int64(3611), np.int64(3837), np.int64(3914), np.int64(3948), np.int64(4087), np.int64(4230), np.int64(4327), np.int64(4414), np.int64(4433), np.int64(4510), np.int64(4587), np.int64(4607), np.int64(4700), np.int64(4783), np.int64(4799), np.int64(4828), np.int64(4944), np.int64(5083)]


/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:32: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['min_comparisons_smaller'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:32: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['min_comparisons_smaller'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:37: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['local_minima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:37: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['local_minima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:32: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['min_comparisons_smaller'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:32: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['min_comparisons_smaller'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:37: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['local_minima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:37: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['local_minima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:32: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['min_comparisons_smaller'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:32: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['min_comparisons_smaller'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:37: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['local_minima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:37: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['local_minima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:32: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['min_comparisons_smaller'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:32: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['min_comparisons_smaller'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:37: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['local_minima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:37: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['local_minima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:32: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['min_comparisons_smaller'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:32: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['min_comparisons_smaller'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:37: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['local_minima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1558634327.py:37: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['local_minima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/785596803.py:2: DeprecationWarning: DataFrameGroupBy.apply operated on the grouping columns. This behavior is deprecated, and in a future version of pandas the grouping columns will be excluded from the operation. Either pass `include_groups=False` to exclude the groupings or explicitly select the grouping columns after groupby to silence this warning.
  price_df = price_df.groupby('股票代號').apply(lambda df : groupby_extrema_sup(df, '收盤價'))
</code></pre>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">price_df</span><span class="p">[</span><span class="s1">&#39;日期_dt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">price_df</span><span class="p">[</span><span class="s1">&#39;日期&#39;</span><span class="p">]</span> <span class="p">)</span>
</span></span></code></pre></div><h2 id="strategy-logic">strategy Logic</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">price_df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># 近一個月 400張大戶 增加2%以上</span>
</span></span><span class="line"><span class="cl"><span class="n">price_df</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="n">price_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">price_df</span><span class="p">[</span><span class="s1">&#39;週集保diff4week&#39;</span><span class="p">]</span><span class="o">&gt;</span><span class="mf">0.5</span><span class="p">),</span> <span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">res_list</span> <span class="o">=</span> <span class="n">price_df</span><span class="p">[(</span><span class="n">price_df</span><span class="p">[</span><span class="s1">&#39;日期_dt&#39;</span><span class="p">]</span><span class="o">&gt;=</span><span class="s1">&#39;20150101&#39;</span><span class="p">)]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;股票代號&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">vector_backtest</span><span class="p">)</span>
</span></span></code></pre></div><pre><code>/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/4079245513.py:4: DeprecationWarning: DataFrameGroupBy.apply operated on the grouping columns. This behavior is deprecated, and in a future version of pandas the grouping columns will be excluded from the operation. Either pass `include_groups=False` to exclude the groupings or explicitly select the grouping columns after groupby to silence this warning.
  res_list = price_df[(price_df['日期_dt']&gt;='20150101')].groupby('股票代號').apply(vector_backtest)
</code></pre>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">price_df</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">price_df</span><span class="p">[</span><span class="s1">&#39;維持率反推融資平均損益&#39;</span><span class="p">]</span><span class="o">&lt;-</span><span class="mf">0.1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">price_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask</span><span class="p">,</span> <span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">res_list</span> <span class="o">=</span> <span class="n">price_df</span><span class="p">[(</span><span class="n">price_df</span><span class="p">[</span><span class="s1">&#39;日期_dt&#39;</span><span class="p">]</span><span class="o">&gt;=</span><span class="s1">&#39;20150101&#39;</span><span class="p">)]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;股票代號&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">vector_backtest</span><span class="p">)</span>
</span></span></code></pre></div><pre><code>/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/857034293.py:4: DeprecationWarning: DataFrameGroupBy.apply operated on the grouping columns. This behavior is deprecated, and in a future version of pandas the grouping columns will be excluded from the operation. Either pass `include_groups=False` to exclude the groupings or explicitly select the grouping columns after groupby to silence this warning.
  res_list = price_df[(price_df['日期_dt']&gt;='20150101')].groupby('股票代號').apply(vector_backtest)
</code></pre>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">price_df</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="c1"># &amp; (price_df[&#39;收盤價&#39;]&gt;price_df[&#39;local_maxima&#39;])) | (price_df[&#39;維持率反推融資平均損益&#39;]&lt;-0.1)</span>
</span></span><span class="line"><span class="cl"><span class="n">price_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">price_df</span><span class="p">[</span><span class="s1">&#39;收盤價&#39;</span><span class="p">]</span><span class="o">&gt;</span><span class="n">price_df</span><span class="p">[</span><span class="s1">&#39;local_maxima&#39;</span><span class="p">]),</span> <span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">res_list</span> <span class="o">=</span> <span class="n">price_df</span><span class="p">[(</span><span class="n">price_df</span><span class="p">[</span><span class="s1">&#39;日期_dt&#39;</span><span class="p">]</span><span class="o">&gt;=</span><span class="s1">&#39;20150101&#39;</span><span class="p">)]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;股票代號&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">vector_backtest</span><span class="p">)</span>
</span></span></code></pre></div><pre><code>/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1700805250.py:4: DeprecationWarning: DataFrameGroupBy.apply operated on the grouping columns. This behavior is deprecated, and in a future version of pandas the grouping columns will be excluded from the operation. Either pass `include_groups=False` to exclude the groupings or explicitly select the grouping columns after groupby to silence this warning.
  res_list = price_df[(price_df['日期_dt']&gt;='20150101')].groupby('股票代號').apply(vector_backtest)
</code></pre>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">price_df</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="n">price_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[((</span><span class="n">price_df</span><span class="p">[</span><span class="s1">&#39;min_comparisons_smaller&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">price_df</span><span class="p">[</span><span class="s1">&#39;收盤價&#39;</span><span class="p">]</span><span class="o">&lt;</span><span class="n">price_df</span><span class="p">[</span><span class="s1">&#39;local_minima&#39;</span><span class="p">]))</span> <span class="o">|</span> <span class="p">(</span><span class="n">price_df</span><span class="p">[</span><span class="s1">&#39;維持率反推融資平均損益&#39;</span><span class="p">]</span><span class="o">&lt;-</span><span class="mf">0.1</span><span class="p">),</span> <span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">res_list</span> <span class="o">=</span> <span class="n">price_df</span><span class="p">[(</span><span class="n">price_df</span><span class="p">[</span><span class="s1">&#39;日期_dt&#39;</span><span class="p">]</span><span class="o">&gt;=</span><span class="s1">&#39;20150101&#39;</span><span class="p">)]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;股票代號&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">vector_backtest</span><span class="p">)</span>
</span></span></code></pre></div><pre><code>/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/168196673.py:3: DeprecationWarning: DataFrameGroupBy.apply operated on the grouping columns. This behavior is deprecated, and in a future version of pandas the grouping columns will be excluded from the operation. Either pass `include_groups=False` to exclude the groupings or explicitly select the grouping columns after groupby to silence this warning.
  res_list = price_df[(price_df['日期_dt']&gt;='20150101')].groupby('股票代號').apply(vector_backtest)
</code></pre>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">price_df</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="n">price_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">price_df</span><span class="p">[</span><span class="s1">&#39;20MA&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">price_df</span><span class="p">[</span><span class="s1">&#39;200MA&#39;</span><span class="p">])</span> <span class="p">,</span> <span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">res_list</span> <span class="o">=</span> <span class="n">price_df</span><span class="p">[(</span><span class="n">price_df</span><span class="p">[</span><span class="s1">&#39;日期_dt&#39;</span><span class="p">]</span><span class="o">&gt;=</span><span class="s1">&#39;20150101&#39;</span><span class="p">)]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;股票代號&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">vector_backtest</span><span class="p">)</span>
</span></span></code></pre></div><pre><code>/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/3380416550.py:3: DeprecationWarning: DataFrameGroupBy.apply operated on the grouping columns. This behavior is deprecated, and in a future version of pandas the grouping columns will be excluded from the operation. Either pass `include_groups=False` to exclude the groupings or explicitly select the grouping columns after groupby to silence this warning.
  res_list = price_df[(price_df['日期_dt']&gt;='20150101')].groupby('股票代號').apply(vector_backtest)
</code></pre>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">price_df</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="c1"># (price_df[&#39;max_comparisons_larger&#39;]==1)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># (price_df[&#39;min_comparisons_smaller&#39;]==1)</span>
</span></span><span class="line"><span class="cl"><span class="c1">#  &amp; (price_df[f&#39;slope_{w}_rolling_{j}_SUM&#39;]&gt;price_df[&#39;local_maxima&#39;])</span>
</span></span><span class="line"><span class="cl"><span class="n">price_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">price_df</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;slope_</span><span class="si">{</span><span class="n">w</span><span class="si">}</span><span class="s1">_rolling_</span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s1">_SUM&#39;</span><span class="p">]</span><span class="o">&lt;</span><span class="n">price_df</span><span class="p">[</span><span class="s1">&#39;local_minima&#39;</span><span class="p">]),</span> <span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">res_list</span> <span class="o">=</span> <span class="n">price_df</span><span class="p">[(</span><span class="n">price_df</span><span class="p">[</span><span class="s1">&#39;日期_dt&#39;</span><span class="p">]</span><span class="o">&gt;=</span><span class="s1">&#39;20150101&#39;</span><span class="p">)]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;股票代號&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">vector_backtest</span><span class="p">)</span>
</span></span></code></pre></div><pre><code>/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/939178834.py:6: DeprecationWarning: DataFrameGroupBy.apply operated on the grouping columns. This behavior is deprecated, and in a future version of pandas the grouping columns will be excluded from the operation. Either pass `include_groups=False` to exclude the groupings or explicitly select the grouping columns after groupby to silence this warning.
  res_list = price_df[(price_df['日期_dt']&gt;='20150101')].groupby('股票代號').apply(vector_backtest)
</code></pre>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">price_df</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="n">price_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">price_df</span><span class="p">[</span><span class="s1">&#39;收盤價&#39;</span><span class="p">]</span><span class="o">&lt;</span><span class="n">price_df</span><span class="p">[</span><span class="s1">&#39;local_minima&#39;</span><span class="p">]),</span> <span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">res_list</span> <span class="o">=</span> <span class="n">price_df</span><span class="p">[(</span><span class="n">price_df</span><span class="p">[</span><span class="s1">&#39;日期_dt&#39;</span><span class="p">]</span><span class="o">&gt;=</span><span class="s1">&#39;20150101&#39;</span><span class="p">)]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;股票代號&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">vector_backtest</span><span class="p">)</span>
</span></span></code></pre></div><pre><code>/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/4128040719.py:3: DeprecationWarning: DataFrameGroupBy.apply operated on the grouping columns. This behavior is deprecated, and in a future version of pandas the grouping columns will be excluded from the operation. Either pass `include_groups=False` to exclude the groupings or explicitly select the grouping columns after groupby to silence this warning.
  res_list = price_df[(price_df['日期_dt']&gt;='20150101')].groupby('股票代號').apply(vector_backtest)
</code></pre>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">price_df</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="n">price_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">price_df</span><span class="p">[</span><span class="s1">&#39;收盤價&#39;</span><span class="p">]</span><span class="o">&gt;</span><span class="n">price_df</span><span class="p">[</span><span class="s1">&#39;local_maxima&#39;</span><span class="p">]),</span> <span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">res_list</span> <span class="o">=</span> <span class="n">price_df</span><span class="p">[(</span><span class="n">price_df</span><span class="p">[</span><span class="s1">&#39;日期_dt&#39;</span><span class="p">]</span><span class="o">&gt;=</span><span class="s1">&#39;20150101&#39;</span><span class="p">)]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;股票代號&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">vector_backtest</span><span class="p">)</span>
</span></span></code></pre></div><pre><code>/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/357474516.py:3: DeprecationWarning: DataFrameGroupBy.apply operated on the grouping columns. This behavior is deprecated, and in a future version of pandas the grouping columns will be excluded from the operation. Either pass `include_groups=False` to exclude the groupings or explicitly select the grouping columns after groupby to silence this warning.
  res_list = price_df[(price_df['日期_dt']&gt;='20150101')].groupby('股票代號').apply(vector_backtest)
</code></pre>
<h2 id="組合上下行">組合上下行</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">price_df</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="c1"># (price_df[&#39;max_comparisons_larger&#39;]==1)</span>
</span></span><span class="line"><span class="cl"><span class="c1">#  &amp; (price_df[f&#39;slope_{w}_rolling_{j}_SUM&#39;]&gt;price_df[&#39;local_maxima&#39;])</span>
</span></span><span class="line"><span class="cl"><span class="n">price_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">price_df</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;slope_</span><span class="si">{</span><span class="n">w</span><span class="si">}</span><span class="s1">_rolling_</span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s1">_SUM&#39;</span><span class="p">]</span><span class="o">&gt;</span><span class="n">price_df</span><span class="p">[</span><span class="s1">&#39;local_maxima&#39;</span><span class="p">])</span> <span class="o">|</span> <span class="p">(</span><span class="n">price_df</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;slope_</span><span class="si">{</span><span class="n">w</span><span class="si">}</span><span class="s1">_rolling_</span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s1">_SUM&#39;</span><span class="p">]</span><span class="o">&lt;</span><span class="n">price_df</span><span class="p">[</span><span class="s1">&#39;local_minima&#39;</span><span class="p">]),</span> <span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">res_list</span> <span class="o">=</span> <span class="n">price_df</span><span class="p">[(</span><span class="n">price_df</span><span class="p">[</span><span class="s1">&#39;日期_dt&#39;</span><span class="p">]</span><span class="o">&gt;=</span><span class="s1">&#39;20150101&#39;</span><span class="p">)]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;股票代號&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">vector_backtest</span><span class="p">)</span>
</span></span></code></pre></div><pre><code>/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/950731482.py:5: DeprecationWarning: DataFrameGroupBy.apply operated on the grouping columns. This behavior is deprecated, and in a future version of pandas the grouping columns will be excluded from the operation. Either pass `include_groups=False` to exclude the groupings or explicitly select the grouping columns after groupby to silence this warning.
  res_list = price_df[(price_df['日期_dt']&gt;='20150101')].groupby('股票代號').apply(vector_backtest)
</code></pre>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">price_df</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="n">price_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">price_df</span><span class="p">[</span><span class="s1">&#39;收盤價&#39;</span><span class="p">]</span><span class="o">&lt;</span><span class="n">price_df</span><span class="p">[</span><span class="s1">&#39;local_minima&#39;</span><span class="p">]),</span> <span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">res_list</span> <span class="o">=</span> <span class="n">price_df</span><span class="p">[(</span><span class="n">price_df</span><span class="p">[</span><span class="s1">&#39;日期_dt&#39;</span><span class="p">]</span><span class="o">&gt;=</span><span class="s1">&#39;20150101&#39;</span><span class="p">)]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;股票代號&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">vector_backtest</span><span class="p">)</span>
</span></span></code></pre></div><pre><code>/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/4128040719.py:3: DeprecationWarning: DataFrameGroupBy.apply operated on the grouping columns. This behavior is deprecated, and in a future version of pandas the grouping columns will be excluded from the operation. Either pass `include_groups=False` to exclude the groupings or explicitly select the grouping columns after groupby to silence this warning.
  res_list = price_df[(price_df['日期_dt']&gt;='20150101')].groupby('股票代號').apply(vector_backtest)
</code></pre>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">price_df</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="n">price_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">price_df</span><span class="p">[</span><span class="s1">&#39;min_comparisons_smaller&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">),</span> <span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">res_list</span> <span class="o">=</span> <span class="n">price_df</span><span class="p">[(</span><span class="n">price_df</span><span class="p">[</span><span class="s1">&#39;日期_dt&#39;</span><span class="p">]</span><span class="o">&gt;=</span><span class="s1">&#39;20150101&#39;</span><span class="p">)]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;股票代號&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">vector_backtest</span><span class="p">)</span>
</span></span></code></pre></div><pre><code>/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/3623880085.py:3: DeprecationWarning: DataFrameGroupBy.apply operated on the grouping columns. This behavior is deprecated, and in a future version of pandas the grouping columns will be excluded from the operation. Either pass `include_groups=False` to exclude the groupings or explicitly select the grouping columns after groupby to silence this warning.
  res_list = price_df[(price_df['日期_dt']&gt;='20150101')].groupby('股票代號').apply(vector_backtest)
</code></pre>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">price_df</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="n">price_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">price_df</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;slope_</span><span class="si">{</span><span class="n">w</span><span class="si">}</span><span class="s1">_rolling_</span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s1">_SUM&#39;</span><span class="p">]</span><span class="o">&lt;</span><span class="n">price_df</span><span class="p">[</span><span class="s1">&#39;local_minima&#39;</span><span class="p">])</span> <span class="o">|</span> <span class="p">(</span><span class="n">price_df</span><span class="p">[</span><span class="s1">&#39;min_comparisons_smaller&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">),</span> <span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">res_list</span> <span class="o">=</span> <span class="n">price_df</span><span class="p">[(</span><span class="n">price_df</span><span class="p">[</span><span class="s1">&#39;日期_dt&#39;</span><span class="p">]</span><span class="o">&gt;=</span><span class="s1">&#39;20150101&#39;</span><span class="p">)]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;股票代號&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">vector_backtest</span><span class="p">)</span>
</span></span></code></pre></div><pre><code>/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1110539843.py:6: DeprecationWarning: DataFrameGroupBy.apply operated on the grouping columns. This behavior is deprecated, and in a future version of pandas the grouping columns will be excluded from the operation. Either pass `include_groups=False` to exclude the groupings or explicitly select the grouping columns after groupby to silence this warning.
  res_list = price_df[(price_df['日期_dt']&gt;='20150101')].groupby('股票代號').apply(vector_backtest)
</code></pre>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">price_df</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="n">price_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">price_df</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;slope_</span><span class="si">{</span><span class="n">w</span><span class="si">}</span><span class="s1">_rolling_</span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s1">_SUM&#39;</span><span class="p">]</span><span class="o">&gt;</span> <span class="mf">0.02</span><span class="p">),</span> <span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">res_list</span> <span class="o">=</span> <span class="n">price_df</span><span class="p">[(</span><span class="n">price_df</span><span class="p">[</span><span class="s1">&#39;日期_dt&#39;</span><span class="p">]</span><span class="o">&gt;=</span><span class="s1">&#39;20150101&#39;</span><span class="p">)]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;股票代號&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">vector_backtest</span><span class="p">)</span>
</span></span></code></pre></div><pre><code>/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/3456730543.py:3: DeprecationWarning: DataFrameGroupBy.apply operated on the grouping columns. This behavior is deprecated, and in a future version of pandas the grouping columns will be excluded from the operation. Either pass `include_groups=False` to exclude the groupings or explicitly select the grouping columns after groupby to silence this warning.
  res_list = price_df[(price_df['日期_dt']&gt;='20150101')].groupby('股票代號').apply(vector_backtest)
</code></pre>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">price_df</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="n">price_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">price_df</span><span class="p">[</span><span class="s1">&#39;收盤價&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">price_df</span><span class="p">[</span><span class="s1">&#39;60MA&#39;</span><span class="p">])</span> <span class="o">|</span> <span class="p">(</span><span class="n">price_df</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;slope_</span><span class="si">{</span><span class="n">w</span><span class="si">}</span><span class="s1">_rolling_</span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s1">_SUM&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.02</span><span class="p">)</span> <span class="p">,</span> <span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">res_list</span> <span class="o">=</span> <span class="n">price_df</span><span class="p">[(</span><span class="n">price_df</span><span class="p">[</span><span class="s1">&#39;日期_dt&#39;</span><span class="p">]</span><span class="o">&gt;=</span><span class="s1">&#39;20150101&#39;</span><span class="p">)]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;股票代號&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">vector_backtest</span><span class="p">)</span>
</span></span></code></pre></div><pre><code>/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/1528418423.py:3: DeprecationWarning: DataFrameGroupBy.apply operated on the grouping columns. This behavior is deprecated, and in a future version of pandas the grouping columns will be excluded from the operation. Either pass `include_groups=False` to exclude the groupings or explicitly select the grouping columns after groupby to silence this warning.
  res_list = price_df[(price_df['日期_dt']&gt;='20150101')].groupby('股票代號').apply(vector_backtest)
</code></pre>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">price_df</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="n">price_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">price_df</span><span class="p">[</span><span class="s1">&#39;收盤價&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">price_df</span><span class="p">[</span><span class="s1">&#39;60MA&#39;</span><span class="p">])</span> <span class="p">,</span> <span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">res_list</span> <span class="o">=</span> <span class="n">price_df</span><span class="p">[(</span><span class="n">price_df</span><span class="p">[</span><span class="s1">&#39;日期_dt&#39;</span><span class="p">]</span><span class="o">&gt;=</span><span class="s1">&#39;20150101&#39;</span><span class="p">)]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;股票代號&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">vector_backtest</span><span class="p">)</span>
</span></span></code></pre></div><pre><code>/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_17654/538384737.py:3: DeprecationWarning: DataFrameGroupBy.apply operated on the grouping columns. This behavior is deprecated, and in a future version of pandas the grouping columns will be excluded from the operation. Either pass `include_groups=False` to exclude the groupings or explicitly select the grouping columns after groupby to silence this warning.
  res_list = price_df[(price_df['日期_dt']&gt;='20150101')].groupby('股票代號').apply(vector_backtest)
</code></pre>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># price_df[price_df[&#39;signal&#39;]==1]</span>
</span></span></code></pre></div><h2 id="now">NOW</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">price_df</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="c1"># (price_df[&#39;max_comparisons_larger&#39;]==1)</span>
</span></span><span class="line"><span class="cl"><span class="c1">#  &amp; (price_df[f&#39;slope_{w}_rolling_{j}_SUM&#39;]&gt;price_df[&#39;local_maxima&#39;])</span>
</span></span><span class="line"><span class="cl"><span class="c1">#  (price_df[&#39;週集保diff4week&#39;]&gt;0.5)|  (price_df[&#39;維持率反推融資平均損益&#39;]&lt;-0.1)</span>
</span></span><span class="line"><span class="cl"><span class="n">price_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[((</span><span class="n">price_df</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;slope_</span><span class="si">{</span><span class="n">w</span><span class="si">}</span><span class="s1">_rolling_</span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s1">_SUM&#39;</span><span class="p">]</span><span class="o">&gt;</span><span class="mf">0.02</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">price_df</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;slope_</span><span class="si">{</span><span class="n">w</span><span class="si">}</span><span class="s1">_rolling_</span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s1">_SUM&#39;</span><span class="p">]</span><span class="o">&gt;</span><span class="n">price_df</span><span class="p">[</span><span class="s1">&#39;local_maxima&#39;</span><span class="p">]))</span> <span class="o">|</span> <span class="p">(</span><span class="n">price_df</span><span class="p">[</span><span class="s1">&#39;週集保diff4week&#39;</span><span class="p">]</span><span class="o">&gt;</span><span class="mf">0.5</span><span class="p">)</span> <span class="o">|</span>  <span class="p">(</span><span class="n">price_df</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;slope_</span><span class="si">{</span><span class="n">w</span><span class="si">}</span><span class="s1">_rolling_</span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s1">_SUM&#39;</span><span class="p">]</span><span class="o">&lt;</span><span class="n">price_df</span><span class="p">[</span><span class="s1">&#39;local_minima&#39;</span><span class="p">])</span> <span class="o">|</span>  <span class="p">(</span><span class="n">price_df</span><span class="p">[</span><span class="s1">&#39;維持率反推融資平均損益&#39;</span><span class="p">]</span><span class="o">&lt;-</span><span class="mf">0.1</span><span class="p">),</span> <span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">res_list</span> <span class="o">=</span> <span class="n">price_df</span><span class="p">[(</span><span class="n">price_df</span><span class="p">[</span><span class="s1">&#39;日期_dt&#39;</span><span class="p">]</span><span class="o">&gt;=</span><span class="s1">&#39;20150101&#39;</span><span class="p">)]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;股票代號&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">vector_backtest</span><span class="p">)</span>
</span></span></code></pre></div><pre><code>/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/3722245375.py:6: DeprecationWarning: DataFrameGroupBy.apply operated on the grouping columns. This behavior is deprecated, and in a future version of pandas the grouping columns will be excluded from the operation. Either pass `include_groups=False` to exclude the groupings or explicitly select the grouping columns after groupby to silence this warning.
  res_list = price_df[(price_df['日期_dt']&gt;='20150101')].groupby('股票代號').apply(vector_backtest)
</code></pre>
<h2 id="簡易pnl模擬">簡易PnL模擬</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">res_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">res_list</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">tmp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;股票代號&#39;</span><span class="p">,</span> <span class="s1">&#39;訊號開始日&#39;</span><span class="p">,</span> <span class="s1">&#39;訊號結束日&#39;</span><span class="p">,</span> <span class="s1">&#39;買入價格&#39;</span><span class="p">,</span> <span class="s1">&#39;賣出價格&#39;</span><span class="p">,</span> <span class="s1">&#39;return&#39;</span><span class="p">,</span> <span class="s1">&#39;訊號持續天數&#39;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">    <span class="n">res_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">res_df</span><span class="p">,</span> <span class="n">tmp</span><span class="p">],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">res_df</span><span class="p">[</span><span class="s1">&#39;return_fee&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">res_df</span><span class="p">[</span><span class="s1">&#39;return&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.00585</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">show_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;ticker_benchmark_pnl&#39;</span><span class="p">,</span> <span class="s1">&#39;strategy_pnl&#39;</span><span class="p">,</span> <span class="s1">&#39;time_in_markets&#39;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">ticker</span> <span class="ow">in</span> <span class="n">SUB_TICKERS</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">GOAL</span> <span class="o">=</span> <span class="p">(</span><span class="n">price_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">price_df</span><span class="p">[</span><span class="s1">&#39;股票代號&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">ticker</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">price_df</span><span class="p">[</span><span class="s1">&#39;日期_dt&#39;</span><span class="p">]</span><span class="o">&gt;=</span><span class="s1">&#39;20150101&#39;</span><span class="p">),</span> <span class="s1">&#39;收盤價&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">price_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">price_df</span><span class="p">[</span><span class="s1">&#39;股票代號&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">ticker</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">price_df</span><span class="p">[</span><span class="s1">&#39;日期_dt&#39;</span><span class="p">]</span><span class="o">&gt;=</span><span class="s1">&#39;20150101&#39;</span><span class="p">),</span> <span class="s1">&#39;收盤價&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="n">show_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ticker</span><span class="p">,</span> <span class="s1">&#39;ticker_benchmark_pnl&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">GOAL</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">res_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">res_df</span><span class="p">[</span><span class="s1">&#39;股票代號&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">ticker</span><span class="p">),</span> <span class="s1">&#39;return_fee&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">cumprod</span><span class="p">()</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">continue</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">strategy_pnl</span> <span class="o">=</span> <span class="n">res_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">res_df</span><span class="p">[</span><span class="s1">&#39;股票代號&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">ticker</span><span class="p">),</span> <span class="s1">&#39;return_fee&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">cumprod</span><span class="p">()</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">show_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ticker</span><span class="p">,</span> <span class="s1">&#39;strategy_pnl&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">strategy_pnl</span>
</span></span><span class="line"><span class="cl">    <span class="n">show_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ticker</span><span class="p">,</span> <span class="s1">&#39;time_in_markets&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">res_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">res_df</span><span class="p">[</span><span class="s1">&#39;股票代號&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">ticker</span><span class="p">),</span> <span class="s1">&#39;訊號持續天數&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">price_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">price_df</span><span class="p">[</span><span class="s1">&#39;股票代號&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">ticker</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">price_df</span><span class="p">[</span><span class="s1">&#39;日期_dt&#39;</span><span class="p">]</span><span class="o">&gt;=</span><span class="s1">&#39;20150101&#39;</span><span class="p">)])</span>
</span></span><span class="line"><span class="cl"><span class="n">show_df</span>
</span></span></code></pre></div><!-- raw HTML omitted -->
<pre><code>.dataframe tbody tr th {
    vertical-align: top;
}

.dataframe thead th {
    text-align: right;
}
</code></pre>
<p><!-- raw HTML omitted --></p>
<!-- raw HTML omitted -->
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">show_df</span><span class="p">[</span><span class="s1">&#39;perfect_res&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">show_df</span><span class="p">[</span><span class="s1">&#39;strategy_pnl&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">show_df</span><span class="p">[</span><span class="s1">&#39;time_in_markets&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">show_df</span><span class="p">[</span><span class="s1">&#39;0.8_benchmark&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">show_df</span><span class="p">[</span><span class="s1">&#39;ticker_benchmark_pnl&#39;</span><span class="p">]</span><span class="o">*</span><span class="mf">0.8</span>
</span></span><span class="line"><span class="cl"><span class="n">show_df</span>
</span></span></code></pre></div><!-- raw HTML omitted -->
<pre><code>.dataframe tbody tr th {
    vertical-align: top;
}

.dataframe thead th {
    text-align: right;
}
</code></pre>
<p><!-- raw HTML omitted --></p>
<!-- raw HTML omitted -->
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="n">show_df</span><span class="p">[</span><span class="n">show_df</span><span class="p">[</span><span class="s1">&#39;perfect_res&#39;</span><span class="p">]</span><span class="o">&gt;</span><span class="n">show_df</span><span class="p">[</span><span class="s1">&#39;0.8_benchmark&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
</span></span></code></pre></div><pre><code>Index(['2059', '3008'], dtype='object')
</code></pre>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">Counter</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">vector_backtest_ratio</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">buyholddays</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">   
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;&#39;&#39;
</span></span></span><span class="line"><span class="cl"><span class="s1">    for backtest PnL ratio
</span></span></span><span class="line"><span class="cl"><span class="s1">    index_count 算目前在該ticker 上累積bet的數量 
</span></span></span><span class="line"><span class="cl"><span class="s1">    &#39;&#39;&#39;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="n">df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;ratio&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="n">signal_idx</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">index</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="n">all_holding_idx</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">signal_idx</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">adding_idx</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">idx</span><span class="o">+</span><span class="n">buyholddays</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">        <span class="n">all_holding_idx</span> <span class="o">+=</span> <span class="n">adding_idx</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">    <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">all_holding_idx</span><span class="p">,</span> <span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">df</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">price_df</span> <span class="o">=</span> <span class="n">price_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;股票代號&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">df</span> <span class="p">:</span> <span class="n">vector_backtest_ratio</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
</span></span></code></pre></div><pre><code>/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/517245478.py:1: DeprecationWarning: DataFrameGroupBy.apply operated on the grouping columns. This behavior is deprecated, and in a future version of pandas the grouping columns will be excluded from the operation. Either pass `include_groups=False` to exclude the groupings or explicitly select the grouping columns after groupby to silence this warning.
  price_df = price_df.groupby('股票代號').apply(lambda df : vector_backtest_ratio(df, 10))
</code></pre>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">price_df</span> <span class="o">=</span> <span class="n">price_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;股票代號&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">df</span> <span class="p">:</span> <span class="n">vector_backtest_ratio</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="mi">20</span><span class="p">))</span>
</span></span></code></pre></div><pre><code>/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/2754594864.py:1: DeprecationWarning: DataFrameGroupBy.apply operated on the grouping columns. This behavior is deprecated, and in a future version of pandas the grouping columns will be excluded from the operation. Either pass `include_groups=False` to exclude the groupings or explicitly select the grouping columns after groupby to silence this warning.
  price_df = price_df.groupby('股票代號').apply(lambda df : vector_backtest_ratio(df, 20))
</code></pre>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">price_df</span> <span class="o">=</span> <span class="n">price_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;股票代號&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">df</span> <span class="p">:</span> <span class="n">vector_backtest_ratio</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="mi">60</span><span class="p">))</span>
</span></span></code></pre></div><pre><code>/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/3282921495.py:1: DeprecationWarning: DataFrameGroupBy.apply operated on the grouping columns. This behavior is deprecated, and in a future version of pandas the grouping columns will be excluded from the operation. Either pass `include_groups=False` to exclude the groupings or explicitly select the grouping columns after groupby to silence this warning.
  price_df = price_df.groupby('股票代號').apply(lambda df : vector_backtest_ratio(df, 60))
</code></pre>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">price_df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">res_list</span> <span class="o">=</span> <span class="n">price_df</span><span class="p">[(</span><span class="n">price_df</span><span class="p">[</span><span class="s1">&#39;日期_dt&#39;</span><span class="p">]</span><span class="o">&gt;=</span><span class="s1">&#39;20150101&#39;</span><span class="p">)]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;股票代號&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">vector_backtest</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">res_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">res_list</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">tmp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;股票代號&#39;</span><span class="p">,</span> <span class="s1">&#39;訊號開始日&#39;</span><span class="p">,</span> <span class="s1">&#39;訊號結束日&#39;</span><span class="p">,</span> <span class="s1">&#39;買入價格&#39;</span><span class="p">,</span> <span class="s1">&#39;賣出價格&#39;</span><span class="p">,</span> <span class="s1">&#39;return&#39;</span><span class="p">,</span> <span class="s1">&#39;訊號持續天數&#39;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">    <span class="n">res_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">res_df</span><span class="p">,</span> <span class="n">tmp</span><span class="p">],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">res_df</span><span class="p">[</span><span class="s1">&#39;return_fee&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">res_df</span><span class="p">[</span><span class="s1">&#39;return&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.00585</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
</span></span></code></pre></div><pre><code>/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/317971430.py:1: DeprecationWarning: DataFrameGroupBy.apply operated on the grouping columns. This behavior is deprecated, and in a future version of pandas the grouping columns will be excluded from the operation. Either pass `include_groups=False` to exclude the groupings or explicitly select the grouping columns after groupby to silence this warning.
  res_list = price_df[(price_df['日期_dt']&gt;='20150101')].groupby('股票代號').apply(vector_backtest)
</code></pre>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">show_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;ticker_benchmark_pnl&#39;</span><span class="p">,</span> <span class="s1">&#39;strategy_pnl&#39;</span><span class="p">,</span> <span class="s1">&#39;time_in_markets&#39;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">ticker</span> <span class="ow">in</span> <span class="n">SUB_TICKERS</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">GOAL</span> <span class="o">=</span> <span class="p">(</span><span class="n">price_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">price_df</span><span class="p">[</span><span class="s1">&#39;股票代號&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">ticker</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">price_df</span><span class="p">[</span><span class="s1">&#39;日期_dt&#39;</span><span class="p">]</span><span class="o">&gt;=</span><span class="s1">&#39;20150101&#39;</span><span class="p">),</span> <span class="s1">&#39;收盤價&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">price_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">price_df</span><span class="p">[</span><span class="s1">&#39;股票代號&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">ticker</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">price_df</span><span class="p">[</span><span class="s1">&#39;日期_dt&#39;</span><span class="p">]</span><span class="o">&gt;=</span><span class="s1">&#39;20150101&#39;</span><span class="p">),</span> <span class="s1">&#39;收盤價&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="n">show_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ticker</span><span class="p">,</span> <span class="s1">&#39;ticker_benchmark_pnl&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">GOAL</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">res_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">res_df</span><span class="p">[</span><span class="s1">&#39;股票代號&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">ticker</span><span class="p">),</span> <span class="s1">&#39;return_fee&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">cumprod</span><span class="p">()</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">continue</span>
</span></span><span class="line"><span class="cl">    <span class="n">strategy_pnl</span> <span class="o">=</span> <span class="n">res_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">res_df</span><span class="p">[</span><span class="s1">&#39;股票代號&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">ticker</span><span class="p">),</span> <span class="s1">&#39;return_fee&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">cumprod</span><span class="p">()</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">show_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ticker</span><span class="p">,</span> <span class="s1">&#39;strategy_pnl&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">strategy_pnl</span>
</span></span><span class="line"><span class="cl">    <span class="n">show_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ticker</span><span class="p">,</span> <span class="s1">&#39;time_in_markets&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">res_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">res_df</span><span class="p">[</span><span class="s1">&#39;股票代號&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">ticker</span><span class="p">),</span> <span class="s1">&#39;訊號持續天數&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">price_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">price_df</span><span class="p">[</span><span class="s1">&#39;股票代號&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">ticker</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">price_df</span><span class="p">[</span><span class="s1">&#39;日期_dt&#39;</span><span class="p">]</span><span class="o">&gt;=</span><span class="s1">&#39;20150101&#39;</span><span class="p">)])</span>
</span></span><span class="line"><span class="cl"><span class="n">show_df</span>
</span></span></code></pre></div><!-- raw HTML omitted -->
<pre><code>.dataframe tbody tr th {
    vertical-align: top;
}

.dataframe thead th {
    text-align: right;
}
</code></pre>
<p><!-- raw HTML omitted --></p>
<!-- raw HTML omitted -->
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">show_df</span><span class="p">[</span><span class="s1">&#39;perfect_res&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">show_df</span><span class="p">[</span><span class="s1">&#39;strategy_pnl&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">show_df</span><span class="p">[</span><span class="s1">&#39;time_in_markets&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">show_df</span><span class="p">[</span><span class="s1">&#39;0.8_benchmark&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">show_df</span><span class="p">[</span><span class="s1">&#39;ticker_benchmark_pnl&#39;</span><span class="p">]</span><span class="o">*</span><span class="mf">0.8</span>
</span></span><span class="line"><span class="cl"><span class="n">show_df</span>
</span></span></code></pre></div><!-- raw HTML omitted -->
<pre><code>.dataframe tbody tr th {
    vertical-align: top;
}

.dataframe thead th {
    text-align: right;
}
</code></pre>
<p><!-- raw HTML omitted --></p>
<!-- raw HTML omitted -->
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="n">show_df</span><span class="p">[</span><span class="n">show_df</span><span class="p">[</span><span class="s1">&#39;perfect_res&#39;</span><span class="p">]</span><span class="o">&gt;</span><span class="n">show_df</span><span class="p">[</span><span class="s1">&#39;0.8_benchmark&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
</span></span></code></pre></div><pre><code>Index(['2330', '8069', '3008'], dtype='object')
</code></pre>
<h2 id="如果是想要抄底的策略-holding-天數可能要拉長到可以等他漲回去">如果是想要抄底的策略 holding 天數可能要拉長到可以等他漲回去</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># price_df.loc[(price_df[&#39;股票代號&#39;]==&#39;2330&#39;) &amp; (price_df[&#39;signal&#39;]==1)].iloc[-20::]</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">res_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">res_df</span><span class="p">[</span><span class="s1">&#39;股票代號&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;2330&#39;</span><span class="p">)]</span>
</span></span></code></pre></div><!-- raw HTML omitted -->
<pre><code>.dataframe tbody tr th {
    vertical-align: top;
}

.dataframe thead th {
    text-align: right;
}
</code></pre>
<p><!-- raw HTML omitted --></p>
<!-- raw HTML omitted -->
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">res_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">res_df</span><span class="p">[</span><span class="s1">&#39;股票代號&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;3529&#39;</span><span class="p">)]</span>
</span></span></code></pre></div><!-- raw HTML omitted -->
<pre><code>.dataframe tbody tr th {
    vertical-align: top;
}

.dataframe thead th {
    text-align: right;
}
</code></pre>
<p><!-- raw HTML omitted --></p>
<!-- raw HTML omitted -->
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">res_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">res_df</span><span class="p">[</span><span class="s1">&#39;股票代號&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;5274&#39;</span><span class="p">)]</span>
</span></span></code></pre></div><!-- raw HTML omitted -->
<pre><code>.dataframe tbody tr th {
    vertical-align: top;
}

.dataframe thead th {
    text-align: right;
}
</code></pre>
<p><!-- raw HTML omitted --></p>
<!-- raw HTML omitted -->
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="mi">1410</span><span class="o">/</span><span class="mi">2410</span>
</span></span></code></pre></div><pre><code>0.5850622406639004
</code></pre>
<h2 id="2454-2383-2059-3008-done">2454, 2383, 2059, 3008 done</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">res_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">res_df</span><span class="p">[</span><span class="s1">&#39;股票代號&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;2383&#39;</span><span class="p">)]</span>
</span></span></code></pre></div><!-- raw HTML omitted -->
<pre><code>.dataframe tbody tr th {
    vertical-align: top;
}

.dataframe thead th {
    text-align: right;
}
</code></pre>
<p><!-- raw HTML omitted --></p>
<!-- raw HTML omitted -->
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">price_df</span><span class="p">[[</span><span class="s1">&#39;日期&#39;</span><span class="p">,</span> <span class="s1">&#39;股票代號&#39;</span><span class="p">,</span> <span class="s1">&#39;signal&#39;</span><span class="p">]</span><span class="o">+</span><span class="n">ret_cols</span><span class="o">+</span><span class="n">winrate_cols</span><span class="p">]</span><span class="o">.</span><span class="n">to_feather</span><span class="p">(</span><span class="s1">&#39;/Users/roberthsu/Documents/TrendForce_project/TW_forwardPE/data/test_get_strategy_result/test.ftr&#39;</span><span class="p">)</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"></code></pre></div><pre><code>/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/2871522017.py:29: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/2871522017.py:29: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/2871522017.py:33: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['local_maxima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/2871522017.py:29: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/2871522017.py:29: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/2871522017.py:33: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['local_maxima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/2871522017.py:29: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/2871522017.py:29: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/2871522017.py:33: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['local_maxima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/2871522017.py:29: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/2871522017.py:29: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/2871522017.py:33: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['local_maxima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/2871522017.py:29: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/2871522017.py:29: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/2871522017.py:33: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['local_maxima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/2871522017.py:29: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/2871522017.py:29: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/2871522017.py:33: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['local_maxima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/2871522017.py:29: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/2871522017.py:29: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/2871522017.py:33: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['local_maxima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/2871522017.py:29: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/2871522017.py:29: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/2871522017.py:33: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['local_maxima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/2871522017.py:29: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/2871522017.py:29: FutureWarning: Downcasting object dtype arrays on .fillna, .ffill, .bfill is deprecated and will change in a future version. Call result.infer_objects(copy=False) instead. To opt-in to the future behavior, set `pd.set_option('future.no_silent_downcasting', True)`
  df['max_comparisons_larger'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/2871522017.py:33: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing 'df[col].method(value, inplace=True)', try using 'df.method({col: value}, inplace=True)' or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df['local_maxima'].ffill(inplace=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_4023/2373799201.py:2: DeprecationWarning: DataFrameGroupBy.apply operated on the grouping columns. This behavior is deprecated, and in a future version of pandas the grouping columns will be excluded from the operation. Either pass `include_groups=False` to exclude the groupings or explicitly select the grouping columns after groupby to silence this warning.
  price_df = price_df.groupby('股票代號').apply(lambda df : groupby_extrema(df, f'slope_{w}_rolling_{j}_SUM'))
</code></pre>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">price_df</span><span class="p">[</span><span class="s1">&#39;cut&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">qcut</span><span class="p">(</span><span class="n">price_df</span><span class="p">[</span><span class="s1">&#39;slope&#39;</span><span class="p">],</span> <span class="mi">10</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">res</span> <span class="o">=</span> <span class="n">price_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;cut&#39;</span><span class="p">,</span> <span class="s1">&#39;股票代號&#39;</span><span class="p">])[</span><span class="s1">&#39;hold_20Days_ret&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">res</span><span class="p">[</span><span class="s1">&#39;hold_20Days_winrate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">price_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;cut&#39;</span><span class="p">,</span> <span class="s1">&#39;股票代號&#39;</span><span class="p">])[</span><span class="s1">&#39;hold_20Days_winrate&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl"><span class="n">res</span><span class="p">[</span><span class="s1">&#39;signal_count&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">price_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;cut&#39;</span><span class="p">,</span> <span class="s1">&#39;股票代號&#39;</span><span class="p">])[</span><span class="s1">&#39;hold_20Days_winrate&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">count</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">res</span>
</span></span></code></pre></div><pre><code>/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_17654/1444240800.py:2: FutureWarning: The default of observed=False is deprecated and will be changed to True in a future version of pandas. Pass observed=False to retain current behavior or observed=True to adopt the future default and silence this warning.
  res = price_df.groupby(['cut', '股票代號'])['hold_20Days_ret'].mean().reset_index(drop=False)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_17654/1444240800.py:3: FutureWarning: The default of observed=False is deprecated and will be changed to True in a future version of pandas. Pass observed=False to retain current behavior or observed=True to adopt the future default and silence this warning.
  res['hold_20Days_winrate'] = price_df.groupby(['cut', '股票代號'])['hold_20Days_winrate'].mean().reset_index(drop=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_17654/1444240800.py:4: FutureWarning: The default of observed=False is deprecated and will be changed to True in a future version of pandas. Pass observed=False to retain current behavior or observed=True to adopt the future default and silence this warning.
  res['signal_count'] = price_df.groupby(['cut', '股票代號'])['hold_20Days_winrate'].count().reset_index(drop=True)
</code></pre>
<!-- raw HTML omitted -->
<pre><code>.dataframe tbody tr th {
    vertical-align: top;
}

.dataframe thead th {
    text-align: right;
}
</code></pre>
<p><!-- raw HTML omitted --></p>
<!-- raw HTML omitted -->
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">df</span>
</span></span></code></pre></div><!-- raw HTML omitted -->
<pre><code>.dataframe tbody tr th {
    vertical-align: top;
}

.dataframe thead th {
    text-align: right;
}
</code></pre>
<p><!-- raw HTML omitted --></p>
<!-- raw HTML omitted -->
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">price_df</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="n">price_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">price_df</span><span class="p">[</span><span class="s1">&#39;last_20Days_ret_0050&#39;</span><span class="p">]</span><span class="o">&lt;=-</span><span class="mf">0.05</span><span class="p">),</span> <span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">price_df</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="n">price_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">price_df</span><span class="p">[</span><span class="s1">&#39;slope&#39;</span><span class="p">]</span><span class="o">&gt;=</span><span class="mf">0.1</span><span class="p">),</span> <span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">ret_cols</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;hold_</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s1">Days_ret&#39;</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">120</span><span class="p">]]</span>
</span></span><span class="line"><span class="cl"><span class="n">winrate_cols</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;hold_</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s1">Days_winrate&#39;</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">120</span><span class="p">]]</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">price_df</span><span class="p">[(</span><span class="n">price_df</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">price_df</span><span class="p">[</span><span class="s1">&#39;日期_dt&#39;</span><span class="p">]</span><span class="o">&gt;=</span><span class="s1">&#39;20150101&#39;</span><span class="p">)]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;股票代號&#39;</span><span class="p">)[</span><span class="n">ret_cols</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">-</span> <span class="n">price_df</span><span class="p">[(</span><span class="n">price_df</span><span class="p">[</span><span class="s1">&#39;日期_dt&#39;</span><span class="p">]</span><span class="o">&gt;=</span><span class="s1">&#39;20150101&#39;</span><span class="p">)]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;股票代號&#39;</span><span class="p">)[</span><span class="n">ret_cols</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</span></span></code></pre></div><!-- raw HTML omitted -->
<pre><code>.dataframe tbody tr th {
    vertical-align: top;
}

.dataframe thead th {
    text-align: right;
}
</code></pre>
<p><!-- raw HTML omitted --></p>
<!-- raw HTML omitted -->
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">price_df</span><span class="p">[(</span><span class="n">price_df</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">price_df</span><span class="p">[</span><span class="s1">&#39;日期_dt&#39;</span><span class="p">]</span><span class="o">&gt;=</span><span class="s1">&#39;20150101&#39;</span><span class="p">)]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;股票代號&#39;</span><span class="p">)[</span><span class="n">winrate_cols</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</span></span></code></pre></div><!-- raw HTML omitted -->
<pre><code>.dataframe tbody tr th {
    vertical-align: top;
}

.dataframe thead th {
    text-align: right;
}
</code></pre>
<p><!-- raw HTML omitted --></p>
<!-- raw HTML omitted -->
<h2 id="pe">PE</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">price_df</span><span class="p">[</span><span class="s1">&#39;cut&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">qcut</span><span class="p">(</span><span class="n">price_df</span><span class="p">[</span><span class="s1">&#39;本益比(近四季)&#39;</span><span class="p">],</span> <span class="mi">10</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">res</span> <span class="o">=</span> <span class="n">price_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;cut&#39;</span><span class="p">,</span> <span class="s1">&#39;股票代號&#39;</span><span class="p">])[</span><span class="s1">&#39;hold_20Days_ret&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">res</span><span class="p">[</span><span class="s1">&#39;hold_20Days_winrate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">price_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;cut&#39;</span><span class="p">,</span> <span class="s1">&#39;股票代號&#39;</span><span class="p">])[</span><span class="s1">&#39;hold_20Days_winrate&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl"><span class="n">res</span><span class="p">[</span><span class="s1">&#39;signal_count&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">price_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;cut&#39;</span><span class="p">,</span> <span class="s1">&#39;股票代號&#39;</span><span class="p">])[</span><span class="s1">&#39;hold_20Days_winrate&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">count</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">res</span>
</span></span></code></pre></div><pre><code>/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_17654/1178586764.py:2: FutureWarning: The default of observed=False is deprecated and will be changed to True in a future version of pandas. Pass observed=False to retain current behavior or observed=True to adopt the future default and silence this warning.
  res = price_df.groupby(['cut', '股票代號'])['hold_20Days_ret'].mean().reset_index(drop=False)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_17654/1178586764.py:3: FutureWarning: The default of observed=False is deprecated and will be changed to True in a future version of pandas. Pass observed=False to retain current behavior or observed=True to adopt the future default and silence this warning.
  res['hold_20Days_winrate'] = price_df.groupby(['cut', '股票代號'])['hold_20Days_winrate'].mean().reset_index(drop=True)
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_17654/1178586764.py:4: FutureWarning: The default of observed=False is deprecated and will be changed to True in a future version of pandas. Pass observed=False to retain current behavior or observed=True to adopt the future default and silence this warning.
  res['signal_count'] = price_df.groupby(['cut', '股票代號'])['hold_20Days_winrate'].count().reset_index(drop=True)
</code></pre>
<!-- raw HTML omitted -->
<pre><code>.dataframe tbody tr th {
    vertical-align: top;
}

.dataframe thead th {
    text-align: right;
}
</code></pre>
<p><!-- raw HTML omitted --></p>
<!-- raw HTML omitted -->
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">price_df</span><span class="o">.</span><span class="n">columns</span>
</span></span></code></pre></div><pre><code>Index(['日期', '股票代號', '股票名稱', '開盤價', '最高價', '最低價', '收盤價', '漲跌', '漲幅(%)',
       '振幅(%)', '成交量', '成交筆數', '成交金額(千)', '均張', '成交量變動(%)', '均張變動(%)',
       '股本(百萬)', '總市值(億)', '市值比重(%)', '本益比', '股價淨值比', '本益比(近四季)', '週轉率(%)',
       '成交值比重(%)', '漲跌停', 'RTIME', '日期_dt', 'hold_5Days_ret', 'last_5Days_ret',
       'hold_5Days_winrate', 'hold_10Days_ret', 'last_10Days_ret',
       'hold_10Days_winrate', 'hold_20Days_ret', 'last_20Days_ret',
       'hold_20Days_winrate', 'hold_60Days_ret', 'last_60Days_ret',
       'hold_60Days_winrate', 'hold_120Days_ret', 'last_120Days_ret',
       'hold_120Days_winrate', '日期_0050', '股票代號_0050', '股票名稱_0050', '開盤價_0050',
       '最高價_0050', '最低價_0050', '收盤價_0050', '漲跌_0050', '漲幅(%)_0050',
       '振幅(%)_0050', '成交量_0050', '成交筆數_0050', '成交金額(千)_0050', '均張_0050',
       '成交量變動(%)_0050', '均張變動(%)_0050', '股本(百萬)_0050', '總市值(億)_0050',
       '市值比重(%)_0050', '本益比_0050', '股價淨值比_0050', '本益比(近四季)_0050',
       '週轉率(%)_0050', '成交值比重(%)_0050', '漲跌停_0050', 'RTIME_0050',
       'hold_5Days_ret_0050', 'last_5Days_ret_0050', 'hold_5Days_winrate_0050',
       'hold_10Days_ret_0050', 'last_10Days_ret_0050',
       'hold_10Days_winrate_0050', 'hold_20Days_ret_0050',
       'last_20Days_ret_0050', 'hold_20Days_winrate_0050',
       'hold_60Days_ret_0050', 'last_60Days_ret_0050',
       'hold_60Days_winrate_0050', 'hold_120Days_ret_0050',
       'last_120Days_ret_0050', 'hold_120Days_winrate_0050', 'cut', 'signal'],
      dtype='object')
</code></pre>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">price_df</span><span class="p">[(</span><span class="n">price_df</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">price_df</span><span class="p">[</span><span class="s1">&#39;日期_dt&#39;</span><span class="p">]</span><span class="o">&gt;=</span><span class="s1">&#39;20150101&#39;</span><span class="p">)]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;股票代號&#39;</span><span class="p">)[</span><span class="n">winrate_cols</span><span class="p">]</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
</span></span></code></pre></div><!-- raw HTML omitted -->
<pre><code>.dataframe tbody tr th {
    vertical-align: top;
}

.dataframe thead th {
    text-align: right;
}
</code></pre>
<p><!-- raw HTML omitted --></p>
<!-- raw HTML omitted -->
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">price_df</span><span class="p">[[</span><span class="s1">&#39;日期&#39;</span><span class="p">,</span> <span class="s1">&#39;股票代號&#39;</span><span class="p">,</span> <span class="s1">&#39;signal&#39;</span><span class="p">]</span><span class="o">+</span><span class="n">ret_cols</span><span class="o">+</span><span class="n">winrate_cols</span><span class="p">]</span><span class="o">.</span><span class="n">to_feather</span><span class="p">(</span><span class="s1">&#39;/Users/roberthsu/Documents/TrendForce_project/TW_forwardPE/data/test_get_strategy_result/test.ftr&#39;</span><span class="p">)</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">income_stat_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_feather</span><span class="p">(</span><span class="s1">&#39;/Users/roberthsu/Documents/TrendForce_project/cmoney_warehouse/quarterly/quarterlyIncomeStatementSingal.ftr&#39;</span><span class="p">)</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">income_stat_df</span> <span class="o">=</span> <span class="n">income_stat_df</span><span class="p">[</span><span class="n">income_stat_df</span><span class="p">[</span><span class="s1">&#39;股票代號&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">SUB_TICKERS</span><span class="p">)]</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">income_stat_df</span><span class="p">[</span><span class="s1">&#39;公告日_dt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">income_stat_df</span><span class="p">[</span><span class="s1">&#39;公告日期&#39;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="n">income_stat_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;年季&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">income_stat_df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">income_stat_df</span>
</span></span></code></pre></div><!-- raw HTML omitted -->
<pre><code>.dataframe tbody tr th {
    vertical-align: top;
}

.dataframe thead th {
    text-align: right;
}
</code></pre>
<p><!-- raw HTML omitted --></p>
<!-- raw HTML omitted -->
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">re</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">income_stat_df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\s+&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">income_stat_df</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">income_stat_df</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">30</span><span class="p">]</span>
</span></span></code></pre></div><pre><code>Index(['年季', '股票代號', '股票名稱', '市場別', '財報類別', '銷貨收入淨額(千)', '銷貨收入(千)', '銷貨退回(千)',
       '銷貨折讓(千)', '營業收入淨額(千)', '營業成本(千)', '營業毛利(千)', '聯屬公司間未實現利益(千)',
       '聯屬公司間已實現利益(千)', '營業毛利淨額(千)', '營業費用(千)', '推銷費用(千)', '管理費用(千)',
       '研發費用(千)', '預期信用減損損益(千)', '其他營業費用(千)', '其他收益及費損(千)', '其他收益(千)',
       '其他費損(千)', '營業利益(千)', '營業外收入及支出(千)', '利息收入(千)', '銀行存款利息(千)',
       '按攤銷後成本衡量之金融資產利息收入(千)', '透過其他綜合損益按公允價值衡量之金融資產利息收入(千)'],
      dtype='object')
</code></pre>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">income_stat_df</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="o">-</span><span class="mi">30</span><span class="p">::]</span>
</span></span></code></pre></div><pre><code>Index(['國外營運機構淨投資避險中屬有效避險部分之避險工具損益(千)', '與待出售非流動資產直接相關之權益–可能重分類至損益(千)',
       '透過其他綜合損益按公允價值衡量之債務工具投資未實現評價損益(千)', '避險工具之損益–可能重分類至損益(千)',
       '採權益法認列關聯企業及合資其他綜合損益之份額–可能重分類至損益(千)', '可能重分類至損益之其他項目(千)',
       '與可能重分類至損益之項目相關之所得稅(千)', '綜合損益(千)', '稅後純益歸屬(千)', '母公司業主–稅後純益(千)',
       '非控制權益–稅後純益(千)', '共同控制下前手權益–稅後純益(千)', '綜合損益歸屬(千)', '母公司業主–綜合損益(千)',
       '非控制權益–綜合損益(千)', '共同控制下前手權益–綜合損益(千)', 'EBITDA(千)', '公告基本每股盈餘(元)',
       '公告稀釋每股盈餘(元)', '原始每股稅前盈餘(元)', '原始每股稅後盈餘(元)', '原始每股綜合盈餘(元)', '每股稅前盈餘(元)',
       '每股稅後盈餘(元)', '每股綜合盈餘(元)', '更新日期', '公告日期', '建立日期', 'RTIME', '公告日_dt'],
      dtype='object')
</code></pre>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">income_stat_df</span><span class="p">[</span><span class="s1">&#39;母公司業主–稅後純益(千)&#39;</span><span class="p">]</span>
</span></span></code></pre></div><pre><code>0           &lt;NA&gt;
1           &lt;NA&gt;
2           &lt;NA&gt;
3           &lt;NA&gt;
4        1602873
         ...    
818      4498178
819     25715520
820      2435866
821    247845528
822      1456409
Name: 母公司業主–稅後純益(千), Length: 823, dtype: Int64
</code></pre>
<h2 id="不同時間段-適合看得指標也不盡相同-我能不能這個概念---用基本面的變化來作為時間段的區分">不同時間段 適合看得指標也不盡相同 我能不能這個概念 -&gt; 用基本面的變化來作為時間段的區分</h2>
<p>像是基本面改善期間 -&gt; 適合的策略<br>
基本面維持不變時的策略<br>
股價過度反應/過高過低PE對應的策略<br>
像是 基本面漲, 股價沒漲 -&gt; 可能已經反應過了, 也可能是還沒反應<br>
順勢 基本面漲 &amp; 股價也漲<br>
大盤逆風 基本面漲 但股價大跌 -&gt; 先不要進場 等大盤回穩 or PE到一定程度才進場</p>
<h2 id="貝氏定理">貝氏定理</h2>
<ol>
<li>先把營收, EPS, 對比股價的圖Plot出來</li>
<li>判斷大盤行情 上行, 糾結, 下行 在對比各個features在這些期間之下的表現 ex: 大盤下行的時候 全部訊號都沒用 除了PE跌倒歷史quantile多少時可以買入&hellip;, 上行的時候跟著持有也不用管基本面etc</li>
</ol>
<h2 id="reample--merge">reample + merge</h2>
<h2 id="eps-forward-knowing--cal--resample--merge">EPS forward knowing , cal + resample + merge</h2>
<h3 id="1-先把每一季的eps做加總4季-agg-再藉由shift去假設-能夠完美預測未來n季">1. 先把每一季的EPS做加總(4季 agg) 再藉由shift去假設 能夠完美預測未來N季</h3>
<h3 id="再resample-至daily">再resample 至daily</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">resample_q_forward</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># print(df[&#39;股票代號&#39;].iloc[-1])</span>
</span></span><span class="line"><span class="cl">    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="o">~</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;公告日期&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()]</span>
</span></span><span class="line"><span class="cl">    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="o">~</span><span class="n">df</span><span class="o">.</span><span class="n">duplicated</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;公告日期&#39;</span><span class="p">])]</span>
</span></span><span class="line"><span class="cl">    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;knowNext0Q&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;每股稅後盈餘(元)&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;公告日_dt&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">     
</span></span><span class="line"><span class="cl">    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s1">&#39;D&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">ffill</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">df</span>
</span></span></code></pre></div><h3 id="2-與股價合併">2. 與股價合併</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">resample_q_df</span> <span class="o">=</span> 
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">combine_df</span> <span class="o">=</span> <span class="n">price_df</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">resample_q_df</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">left_on</span><span class="o">=</span><span class="p">([</span><span class="s1">&#39;日期_dt&#39;</span><span class="p">,</span> <span class="s1">&#39;股票代號&#39;</span><span class="p">]),</span> <span class="n">right_on</span><span class="o">=</span><span class="p">([</span><span class="s1">&#39;公告日_dt&#39;</span><span class="p">,</span> <span class="s1">&#39;股票代號&#39;</span><span class="p">]))</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">combine_df</span><span class="p">[</span><span class="s1">&#39;Y_M&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">combine_df</span><span class="p">[</span><span class="s1">&#39;日期_dt&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span>  <span class="n">combine_df</span><span class="p">[</span><span class="s1">&#39;日期_dt&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">month</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">sub</span> <span class="o">=</span> <span class="n">combine_df</span><span class="p">[</span><span class="n">combine_df</span><span class="p">[</span><span class="s1">&#39;股票代號&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;2330&#39;</span><span class="p">]</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;PEG_0Q&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>
</span></span></code></pre></div><pre><code>count   5167.0000
mean       1.5405
std        2.4577
min       -1.0632
25%        0.3917
50%        0.7254
75%        1.6816
max       20.2743
Name: PEG_0Q, dtype: float64
</code></pre>
<h3 id="3-有股價-有完美預測一段時間的eps---就有完美預估的pe">3. 有股價 有完美預測一段時間的EPS -&gt; 就有完美預估的PE</h3>
<h3 id="找出該期間的max-min值-主要是用來繪制河流圖">找出該期間的MAX, MIN值 主要是用來繪制河流圖</h3>
<h3 id="並shift">並shift</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">find_PE_range</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;&#39;&#39;
</span></span></span><span class="line"><span class="cl"><span class="s1">    groupby 年季, ticker
</span></span></span><span class="line"><span class="cl"><span class="s1">    假設知道未來N季的EPS 對應期間股價的P/E 區間的max, min
</span></span></span><span class="line"><span class="cl"><span class="s1">    應該要用於未來畫本益比河流圖所用
</span></span></span><span class="line"><span class="cl"><span class="s1">    &#39;&#39;&#39;</span>
</span></span><span class="line"><span class="cl">    <span class="n">tmp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">YM</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Y_M&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">Q</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;年季&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">tmp</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">Q</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">_max_PE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;PE_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">Q&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">tmp</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">Q</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">_mean_PE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;PE_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">Q&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">tmp</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">Q</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">_min_PE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;PE_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">Q&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># tmp.loc[Q, f&#39;{i}_max_PEG&#39;] = df[f&#39;PEG_{i}Q&#39;].max()</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># tmp.loc[Q, f&#39;{i}_mean_PEG&#39;] = df[f&#39;PEG_{i}Q&#39;].mean()</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># tmp.loc[Q, f&#39;{i}_min_PEG&#39;] = df[f&#39;PEG_{i}Q&#39;].min()</span>
</span></span><span class="line"><span class="cl">    <span class="n">tmp</span><span class="p">[</span><span class="s1">&#39;Q&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Q</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">tmp</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">pe_res</span> <span class="o">=</span> <span class="n">combine_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;股票代號&#39;</span><span class="p">,</span> <span class="s1">&#39;年季&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">find_PE_range</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span></span></code></pre></div><pre><code>/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_1441/3018702681.py:1: DeprecationWarning: DataFrameGroupBy.apply operated on the grouping columns. This behavior is deprecated, and in a future version of pandas the grouping columns will be excluded from the operation. Either pass `include_groups=False` to exclude the groupings or explicitly select the grouping columns after groupby to silence this warning.
  pe_res = combine_df.groupby(['股票代號', '年季']).apply(find_PE_range).reset_index(drop=False)
</code></pre>
<h3 id="用前一季之前的all-data-來計算-分位數">用前一季之前的All data 來計算 分位數</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Convert the &#39;quarter&#39; column to a Period with quarterly frequency</span>
</span></span><span class="line"><span class="cl"><span class="n">combine_df</span><span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">combine_df</span><span class="p">[</span><span class="s1">&#39;年季&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span>  <span class="c1"># Extract the year (first 4 digits)</span>
</span></span><span class="line"><span class="cl"><span class="n">combine_df</span><span class="p">[</span><span class="s1">&#39;qtr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">combine_df</span><span class="p">[</span><span class="s1">&#39;年季&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span>  <span class="c1"># Extract the quarter (last 2 digits)</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Create a new column with period as &#39;YYYYQ#&#39; format (like 2000Q4, 2001Q1, etc.)</span>
</span></span><span class="line"><span class="cl"><span class="n">combine_df</span><span class="p">[</span><span class="s1">&#39;period&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">combine_df</span><span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;Q&#39;</span> <span class="o">+</span> <span class="n">combine_df</span><span class="p">[</span><span class="s1">&#39;qtr&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">({</span><span class="s1">&#39;01&#39;</span><span class="p">:</span> <span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="s1">&#39;02&#39;</span><span class="p">:</span> <span class="s1">&#39;2&#39;</span><span class="p">,</span> <span class="s1">&#39;03&#39;</span><span class="p">:</span> <span class="s1">&#39;3&#39;</span><span class="p">,</span> <span class="s1">&#39;04&#39;</span><span class="p">:</span> <span class="s1">&#39;4&#39;</span><span class="p">})</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Convert to Pandas Period with quarterly frequency</span>
</span></span><span class="line"><span class="cl"><span class="n">combine_df</span><span class="p">[</span><span class="s1">&#39;period&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">PeriodIndex</span><span class="p">(</span><span class="n">combine_df</span><span class="p">[</span><span class="s1">&#39;period&#39;</span><span class="p">],</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;Q&#39;</span><span class="p">)</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">quantile_q</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="n">q_list</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;period&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">sub_df_list</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">q_list</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">thisQ</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;period&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">q</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="n">lastQ</span> <span class="o">=</span> <span class="n">df</span><span class="p">[(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;period&#39;</span><span class="p">]</span><span class="o">&gt;</span><span class="p">(</span><span class="n">q</span> <span class="o">-</span> <span class="mi">40</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;period&#39;</span><span class="p">]</span><span class="o">&lt;</span><span class="n">q</span><span class="p">)]</span> <span class="c1"># 20 -&gt; 5y,  12 -&gt; 3y</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">thisQ</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;q20_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">Q&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lastQ</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;PE_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">Q&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="mf">0.2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">thisQ</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;q40_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">Q&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lastQ</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;PE_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">Q&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="mf">0.4</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">thisQ</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;q60_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">Q&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lastQ</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;PE_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">Q&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="mf">0.6</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">thisQ</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;q80_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">Q&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lastQ</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;PE_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">Q&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="mf">0.8</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1"># thisQ[f&#39;q20_{i}Q_G&#39;] = lastQ[f&#39;PEG_{i}Q&#39;].quantile(0.2)</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># thisQ[f&#39;q40_{i}Q_G&#39;] = lastQ[f&#39;PEG_{i}Q&#39;].quantile(0.4)</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># thisQ[f&#39;q60_{i}Q_G&#39;] = lastQ[f&#39;PEG_{i}Q&#39;].quantile(0.6)</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># thisQ[f&#39;q80_{i}Q_G&#39;] = lastQ[f&#39;PEG_{i}Q&#39;].quantile(0.8)</span>
</span></span><span class="line"><span class="cl">        <span class="n">sub_df_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">thisQ</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="n">new_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">sub_df_list</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">new_df</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">res</span> <span class="o">=</span> <span class="n">combine_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;股票代號&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">quantile_q</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span></code></pre></div><pre><code>/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_1441/348048885.py:1: DeprecationWarning: DataFrameGroupBy.apply operated on the grouping columns. This behavior is deprecated, and in a future version of pandas the grouping columns will be excluded from the operation. Either pass `include_groups=False` to exclude the groupings or explicitly select the grouping columns after groupby to silence this warning.
  res = combine_df.groupby('股票代號').apply(quantile_q).reset_index(drop=True)
</code></pre>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">res</span>
</span></span></code></pre></div><!-- raw HTML omitted -->
<pre><code>.dataframe tbody tr th {
    vertical-align: top;
}

.dataframe thead th {
    text-align: right;
}
</code></pre>
<p><!-- raw HTML omitted --></p>
<!-- raw HTML omitted -->
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="s1">&#39;&#39;&#39;
</span></span></span><span class="line"><span class="cl"><span class="s1">分位數的計算區間 - depends on func. quantile_q
</span></span></span><span class="line"><span class="cl"><span class="s1">look back 20Q = 5y 區間
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">&#39;&#39;&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">sub</span> <span class="o">=</span> <span class="n">res</span><span class="p">[(</span><span class="n">res</span><span class="p">[</span><span class="s1">&#39;股票代號&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;3533&#39;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="s1">&#39;period&#39;</span><span class="p">]</span><span class="o">&gt;=</span><span class="s1">&#39;2008Q1&#39;</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">ax1</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_PE_knowNext</span><span class="si">{}</span><span class="s1">Q&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;股票代號&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">i</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="c1"># ax1.plot(sub[&#39;日期_dt&#39;], sub[&#39;PE_1Q&#39;],  label=&#39;PE_1Q&#39;)</span>
</span></span><span class="line"><span class="cl"><span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;日期_dt&#39;</span><span class="p">],</span> <span class="n">sub</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;q20_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">Q&#39;</span><span class="p">],</span>  <span class="n">label</span><span class="o">=</span><span class="s1">&#39;q20&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;日期_dt&#39;</span><span class="p">],</span> <span class="n">sub</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;q40_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">Q&#39;</span><span class="p">],</span>  <span class="n">label</span><span class="o">=</span><span class="s1">&#39;q40&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;日期_dt&#39;</span><span class="p">],</span> <span class="n">sub</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;q60_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">Q&#39;</span><span class="p">],</span>  <span class="n">label</span><span class="o">=</span><span class="s1">&#39;q60&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;日期_dt&#39;</span><span class="p">],</span> <span class="n">sub</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;q80_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">Q&#39;</span><span class="p">],</span>  <span class="n">label</span><span class="o">=</span><span class="s1">&#39;q80&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;日期_dt&#39;</span><span class="p">],</span> <span class="n">sub</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;PE_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">Q&#39;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</span></span></code></pre></div><pre><code>&lt;matplotlib.legend.Legend at 0x1283cb400&gt;
</code></pre>
<p><figure 
	>
	<a href="/my-blog/Final_test_files/Final_test_163_1.png" >
		<img src="/my-blog/Final_test_files/Final_test_163_1.png"
			
			
			
			loading="lazy"
			alt="png">
	</a>
	
	<figcaption>png</figcaption>
	
</figure></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="s1">&#39;&#39;&#39;
</span></span></span><span class="line"><span class="cl"><span class="s1">分位數的計算區間 - depends on func. quantile_q
</span></span></span><span class="line"><span class="cl"><span class="s1">look back 20Q = 5y 區間
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">&#39;&#39;&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">sub</span> <span class="o">=</span> <span class="n">res</span><span class="p">[(</span><span class="n">res</span><span class="p">[</span><span class="s1">&#39;股票代號&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;8069&#39;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="s1">&#39;period&#39;</span><span class="p">]</span><span class="o">&gt;=</span><span class="s1">&#39;2018Q1&#39;</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">ax1</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">i</span> <span class="o">=</span> <span class="mi">4</span>
</span></span><span class="line"><span class="cl"><span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_PE_knowNext</span><span class="si">{}</span><span class="s1">Q&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;股票代號&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">i</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="c1"># ax1.plot(sub[&#39;日期_dt&#39;], sub[&#39;PE_1Q&#39;],  label=&#39;PE_1Q&#39;)</span>
</span></span><span class="line"><span class="cl"><span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;日期_dt&#39;</span><span class="p">],</span> <span class="n">sub</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;q20_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">Q_G&#39;</span><span class="p">],</span>  <span class="n">label</span><span class="o">=</span><span class="s1">&#39;q20&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;日期_dt&#39;</span><span class="p">],</span> <span class="n">sub</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;q40_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">Q_G&#39;</span><span class="p">],</span>  <span class="n">label</span><span class="o">=</span><span class="s1">&#39;q40&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;日期_dt&#39;</span><span class="p">],</span> <span class="n">sub</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;q60_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">Q_G&#39;</span><span class="p">],</span>  <span class="n">label</span><span class="o">=</span><span class="s1">&#39;q60&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;日期_dt&#39;</span><span class="p">],</span> <span class="n">sub</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;q80_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">Q_G&#39;</span><span class="p">],</span>  <span class="n">label</span><span class="o">=</span><span class="s1">&#39;q80&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;日期_dt&#39;</span><span class="p">],</span> <span class="n">sub</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;PEG_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">Q&#39;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</span></span></code></pre></div><pre><code>&lt;matplotlib.legend.Legend at 0x124c216d0&gt;
</code></pre>
<p><figure 
	>
	<a href="/my-blog/Final_test_files/Final_test_164_1.png" >
		<img src="/my-blog/Final_test_files/Final_test_164_1.png"
			
			
			
			loading="lazy"
			alt="png">
	</a>
	
	<figcaption>png</figcaption>
	
</figure></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">res</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;PEG_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">Q&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">row</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;q20_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">Q_G&#39;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">            <span class="n">res</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;cata_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">Q_G&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;0~20_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">Q_G&#39;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;PEG_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">Q&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">row</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;q20_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">Q_G&#39;</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;PEG_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">Q&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">row</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;q40_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">Q_G&#39;</span><span class="p">]):</span>
</span></span><span class="line"><span class="cl">            <span class="n">res</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;cata_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">Q_G&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;20~40_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">Q_G&#39;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;PEG_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">Q&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">row</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;q40_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">Q_G&#39;</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;PEG_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">Q&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">row</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;q60_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">Q_G&#39;</span><span class="p">]):</span>
</span></span><span class="line"><span class="cl">            <span class="n">res</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;cata_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">Q_G&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;40~60_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">Q_G&#39;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;PEG_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">Q&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">row</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;q60_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">Q_G&#39;</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;PEG_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">Q&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">row</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;q80_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">Q_G&#39;</span><span class="p">]):</span>
</span></span><span class="line"><span class="cl">            <span class="n">res</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;cata_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">Q_G&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;60~80_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">Q_G&#39;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;PEG_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">Q&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">row</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;q80_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">Q_G&#39;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">            <span class="n">res</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;cata_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">Q_G&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;80~100_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">Q_G&#39;</span>    
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">res</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;PE_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">Q&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">row</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;q20_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">Q&#39;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">            <span class="n">res</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;cata_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">Q&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;0~20_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">Q&#39;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;PE_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">Q&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">row</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;q20_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">Q&#39;</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;PE_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">Q&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">row</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;q40_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">Q&#39;</span><span class="p">]):</span>
</span></span><span class="line"><span class="cl">            <span class="n">res</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;cata_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">Q&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;20~40_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">Q&#39;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;PE_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">Q&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">row</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;q40_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">Q&#39;</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;PE_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">Q&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">row</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;q60_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">Q&#39;</span><span class="p">]):</span>
</span></span><span class="line"><span class="cl">            <span class="n">res</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;cata_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">Q&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;40~60_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">Q&#39;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;PE_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">Q&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">row</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;q60_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">Q&#39;</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;PE_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">Q&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">row</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;q80_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">Q&#39;</span><span class="p">]):</span>
</span></span><span class="line"><span class="cl">            <span class="n">res</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;cata_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">Q&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;60~80_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">Q&#39;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;PE_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">Q&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">row</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;q80_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">Q&#39;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">            <span class="n">res</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;cata_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">Q&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;80~100_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">Q&#39;</span>    
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">res</span><span class="p">[</span><span class="n">res</span><span class="p">[</span><span class="s1">&#39;cata_0Q&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;0~20_0Q&#39;</span><span class="p">]</span>
</span></span></code></pre></div><!-- raw HTML omitted -->
<pre><code>.dataframe tbody tr th {
    vertical-align: top;
}

.dataframe thead th {
    text-align: right;
}
</code></pre>
<p><!-- raw HTML omitted --></p>
<!-- raw HTML omitted -->
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">preview_res</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;股票代號&#39;</span><span class="p">,</span> <span class="s1">&#39;cata_4Q&#39;</span><span class="p">])[[</span><span class="s1">&#39;hold_5Days_ret&#39;</span><span class="p">,</span> <span class="s1">&#39;hold_10Days_ret&#39;</span><span class="p">,</span> <span class="s1">&#39;hold_20Days_ret&#39;</span><span class="p">,</span> <span class="s1">&#39;hold_60Days_ret&#39;</span><span class="p">,</span> <span class="s1">&#39;hold_120Days_ret&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">preview_res</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;股票代號&#39;</span><span class="p">,</span> <span class="s1">&#39;cata_0Q&#39;</span><span class="p">])[[</span><span class="s1">&#39;hold_5Days_winrate&#39;</span><span class="p">,</span> <span class="s1">&#39;hold_10Days_winrate&#39;</span><span class="p">,</span> <span class="s1">&#39;hold_20Days_winrate&#39;</span><span class="p">,</span> <span class="s1">&#39;hold_60Days_winrate&#39;</span><span class="p">,</span> <span class="s1">&#39;hold_120Days_winrate&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">preview_res</span><span class="p">[</span><span class="s1">&#39;day_ratio&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;股票代號&#39;</span><span class="p">,</span> <span class="s1">&#39;cata_4Q&#39;</span><span class="p">])[</span><span class="s1">&#39;收盤價&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">count</span><span class="p">()</span><span class="o">/</span><span class="mi">6275</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">preview_res</span>
</span></span></code></pre></div><!-- raw HTML omitted -->
<pre><code>.dataframe tbody tr th {
    vertical-align: top;
}

.dataframe thead th {
    text-align: right;
}
</code></pre>
<p><!-- raw HTML omitted --></p>
<!-- raw HTML omitted -->
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="s1">&#39;&#39;&#39;
</span></span></span><span class="line"><span class="cl"><span class="s1">分位數的計算區間 - depends on func. quantile_q
</span></span></span><span class="line"><span class="cl"><span class="s1">look back 20Q = 5y 區間
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">&#39;&#39;&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">sub</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="n">res</span><span class="p">[</span><span class="s1">&#39;股票代號&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;2330&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">sub</span> <span class="o">=</span> <span class="n">res</span>
</span></span><span class="line"><span class="cl"><span class="n">sub</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;cata_0Q&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;20~40_0Q&#39;</span><span class="p">,</span> <span class="s1">&#39;hold_120Days_ret&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">quantile</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;0~20&#39;</span><span class="p">,</span> <span class="s1">&#39;20~40&#39;</span><span class="p">,</span> <span class="s1">&#39;40~60&#39;</span><span class="p">,</span> <span class="s1">&#39;60~80&#39;</span><span class="p">,</span> <span class="s1">&#39;80~100&#39;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">ax1</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">quantile</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">Q holding 120 ret&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># for i in range(0, 5):</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># ax1.plot(sub[&#39;日期_dt&#39;], sub[&#39;PE_1Q&#39;],  label=&#39;PE_1Q&#39;)</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="n">hist_obj</span> <span class="o">=</span> <span class="n">ax1</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">sub</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">sub</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;cata_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">Q&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">quantile</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">Q&#39;</span><span class="p">,</span> <span class="s1">&#39;hold_120Days_ret&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>  <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;q</span><span class="si">{</span><span class="n">quantile</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">Q&#39;</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>   <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span>
</span></span><span class="line"><span class="cl">                            <span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">color</span> <span class="o">=</span> <span class="n">hist_obj</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_facecolor</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">ax1</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">sub</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">sub</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;cata_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">Q&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">quantile</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">Q&#39;</span><span class="p">,</span> <span class="s1">&#39;hold_120Days_ret&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">ymin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ymax</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span>  <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;q</span><span class="si">{</span><span class="n">quantile</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">Q&#39;</span><span class="p">,</span>  <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        
</span></span></code></pre></div><p><figure 
	>
	<a href="/my-blog/Final_test_files/Final_test_172_0.png" >
		<img src="/my-blog/Final_test_files/Final_test_172_0.png"
			
			
			
			loading="lazy"
			alt="png">
	</a>
	
	<figcaption>png</figcaption>
	
</figure></p>
<p><figure 
	>
	<a href="/my-blog/Final_test_files/Final_test_172_1.png" >
		<img src="/my-blog/Final_test_files/Final_test_172_1.png"
			
			
			
			loading="lazy"
			alt="png">
	</a>
	
	<figcaption>png</figcaption>
	
</figure></p>
<p><figure 
	>
	<a href="/my-blog/Final_test_files/Final_test_172_2.png" >
		<img src="/my-blog/Final_test_files/Final_test_172_2.png"
			
			
			
			loading="lazy"
			alt="png">
	</a>
	
	<figcaption>png</figcaption>
	
</figure></p>
<p><figure 
	>
	<a href="/my-blog/Final_test_files/Final_test_172_3.png" >
		<img src="/my-blog/Final_test_files/Final_test_172_3.png"
			
			
			
			loading="lazy"
			alt="png">
	</a>
	
	<figcaption>png</figcaption>
	
</figure></p>
<p><figure 
	>
	<a href="/my-blog/Final_test_files/Final_test_172_4.png" >
		<img src="/my-blog/Final_test_files/Final_test_172_4.png"
			
			
			
			loading="lazy"
			alt="png">
	</a>
	
	<figcaption>png</figcaption>
	
</figure></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">stats</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Generate some sample data with different lengths</span>
</span></span><span class="line"><span class="cl"><span class="n">data1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>  <span class="c1"># Dataset 1</span>
</span></span><span class="line"><span class="cl"><span class="n">data2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">52</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">150</span><span class="p">)</span>  <span class="c1"># Dataset 2</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Perform a two-sample t-test assuming equal variances (Student&#39;s t-test)</span>
</span></span><span class="line"><span class="cl"><span class="n">t_stat</span><span class="p">,</span> <span class="n">p_value</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">ttest_ind</span><span class="p">(</span><span class="n">data1</span><span class="p">,</span> <span class="n">data2</span><span class="p">,</span> <span class="n">equal_var</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Student&#39;s t-test: t-statistic = </span><span class="si">{</span><span class="n">t_stat</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, p-value = </span><span class="si">{</span><span class="n">p_value</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Perform Welch&#39;s t-test (does not assume equal variances)</span>
</span></span><span class="line"><span class="cl"><span class="n">t_stat_welch</span><span class="p">,</span> <span class="n">p_value_welch</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">ttest_ind</span><span class="p">(</span><span class="n">data1</span><span class="p">,</span> <span class="n">data2</span><span class="p">,</span> <span class="n">equal_var</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Welch&#39;s t-test: t-statistic = </span><span class="si">{</span><span class="n">t_stat_welch</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, p-value = </span><span class="si">{</span><span class="n">p_value_welch</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="s1">&#39;&#39;&#39;
</span></span></span><span class="line"><span class="cl"><span class="s1">分位數的計算區間 - depends on func. quantile_q
</span></span></span><span class="line"><span class="cl"><span class="s1">look back 20Q = 5y 區間
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">&#39;&#39;&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">sub</span> <span class="o">=</span> <span class="n">res</span>
</span></span><span class="line"><span class="cl"><span class="n">tmp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">quantile</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;0~20&#39;</span><span class="p">,</span> <span class="s1">&#39;20~40&#39;</span><span class="p">,</span> <span class="s1">&#39;40~60&#39;</span><span class="p">,</span> <span class="s1">&#39;60~80&#39;</span><span class="p">,</span> <span class="s1">&#39;80~100&#39;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="n">t</span> <span class="o">=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">days</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">120</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">        <span class="n">data1</span> <span class="o">=</span> <span class="n">sub</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">sub</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;cata_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">Q&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">quantile</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">Q&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;hold_</span><span class="si">{</span><span class="n">days</span><span class="si">}</span><span class="s1">Days_ret&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
</span></span><span class="line"><span class="cl">        <span class="n">data2</span> <span class="o">=</span> <span class="n">sub</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">sub</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;cata_</span><span class="si">{</span><span class="n">t</span><span class="si">}</span><span class="s1">Q&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">quantile</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">t</span><span class="si">}</span><span class="s1">Q&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;hold_</span><span class="si">{</span><span class="n">days</span><span class="si">}</span><span class="s1">Days_ret&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">t_stat</span><span class="p">,</span> <span class="n">p_value</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">ttest_ind</span><span class="p">(</span><span class="n">data1</span><span class="p">,</span> <span class="n">data2</span><span class="p">,</span> <span class="n">equal_var</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Student&#39;s t-test: t-statistic = </span><span class="si">{</span><span class="n">t_stat</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, p-value = </span><span class="si">{</span><span class="n">p_value</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">quantile</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">t</span><span class="si">}</span><span class="s2">Q, &#39;hold_</span><span class="si">{</span><span class="n">days</span><span class="si">}</span><span class="s2">Days_ret&#39;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">tmp</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">quantile</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">Q vs </span><span class="si">{</span><span class="n">t</span><span class="si">}</span><span class="s1">Q&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;hold </span><span class="si">{</span><span class="n">days</span><span class="si">}</span><span class="s1"> mean return p-value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">p_value</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">tmp</span>
</span></span></code></pre></div><p>有多少 forward 0 在低本益比 但其實用forward 4Q是高本益比<br>
反之亦然<br>
這類股價其實是由未來營收所帶動的 也許就是我們想要抓的?<br>
forward 的優勢就在於 用歷史推估 跟由研調預測得出來的結論有明顯差異 材值得做</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">sub</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="n">res</span><span class="p">[</span><span class="s1">&#39;股票代號&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;2330&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">sub</span> <span class="o">=</span> <span class="n">res</span>
</span></span><span class="line"><span class="cl"><span class="n">mask1</span> <span class="o">=</span> <span class="p">(</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;cata_0Q&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;0~20_0Q&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">mask2</span> <span class="o">=</span>  <span class="p">(</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;cata_4Q&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;60~80_4Q&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># sub.loc[mask1 &amp; mask2, [&#39;股票代號&#39;, &#39;日期_dt&#39;,&#39;hold_5Days_ret&#39;, &#39;hold_10Days_ret&#39;, &#39;hold_20Days_ret&#39;, &#39;hold_60Days_ret&#39;, &#39;hold_120Days_ret&#39;]].describe()</span>
</span></span><span class="line"><span class="cl"><span class="n">sub</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask1</span> <span class="o">&amp;</span> <span class="n">mask2</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;hold_5Days_ret&#39;</span><span class="p">,</span> <span class="s1">&#39;hold_10Days_ret&#39;</span><span class="p">,</span> <span class="s1">&#39;hold_20Days_ret&#39;</span><span class="p">,</span> <span class="s1">&#39;hold_60Days_ret&#39;</span><span class="p">,</span> <span class="s1">&#39;hold_120Days_ret&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">sub</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="n">res</span><span class="p">[</span><span class="s1">&#39;股票代號&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;2330&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">sub</span> <span class="o">=</span> <span class="n">res</span>
</span></span><span class="line"><span class="cl"><span class="n">mask1</span> <span class="o">=</span> <span class="p">(</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;cata_0Q&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;80~100_0Q&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">mask2</span> <span class="o">=</span>  <span class="p">(</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;cata_4Q&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;40~60_4Q&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># sub.loc[mask1 &amp; mask2, [&#39;股票代號&#39;, &#39;日期_dt&#39;,&#39;hold_5Days_ret&#39;, &#39;hold_10Days_ret&#39;, &#39;hold_20Days_ret&#39;, &#39;hold_60Days_ret&#39;, &#39;hold_120Days_ret&#39;]].describe()</span>
</span></span><span class="line"><span class="cl"><span class="n">show_df</span> <span class="o">=</span> <span class="n">sub</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask1</span> <span class="o">&amp;</span> <span class="n">mask2</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;hold_5Days_ret&#39;</span><span class="p">,</span> <span class="s1">&#39;hold_10Days_ret&#39;</span><span class="p">,</span> <span class="s1">&#39;hold_20Days_ret&#39;</span><span class="p">,</span> <span class="s1">&#39;hold_60Days_ret&#39;</span><span class="p">,</span> <span class="s1">&#39;hold_120Days_ret&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">show_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;precision&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;hold_5Days_ret&#39;</span><span class="p">,</span> <span class="s1">&#39;hold_10Days_ret&#39;</span><span class="p">,</span> <span class="s1">&#39;hold_20Days_ret&#39;</span><span class="p">,</span> <span class="s1">&#39;hold_60Days_ret&#39;</span><span class="p">,</span> <span class="s1">&#39;hold_120Days_ret&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">sub</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask1</span> <span class="o">&amp;</span> <span class="n">mask2</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;hold_5Days_winrate&#39;</span><span class="p">,</span> <span class="s1">&#39;hold_10Days_winrate&#39;</span><span class="p">,</span> <span class="s1">&#39;hold_20Days_winrate&#39;</span><span class="p">,</span> <span class="s1">&#39;hold_60Days_winrate&#39;</span><span class="p">,</span> <span class="s1">&#39;hold_120Days_winrate&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">show_df</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">sub</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="n">res</span><span class="p">[</span><span class="s1">&#39;股票代號&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;2330&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">sub</span> <span class="o">=</span> <span class="n">res</span>
</span></span><span class="line"><span class="cl"><span class="n">mask1</span> <span class="o">=</span> <span class="p">(</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;cata_0Q&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;80~100_0Q&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">mask2</span> <span class="o">=</span>  <span class="p">(</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;cata_4Q&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;80~100_4Q&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># sub.loc[mask1 &amp; mask2, [&#39;股票代號&#39;, &#39;日期_dt&#39;,&#39;hold_5Days_ret&#39;, &#39;hold_10Days_ret&#39;, &#39;hold_20Days_ret&#39;, &#39;hold_60Days_ret&#39;, &#39;hold_120Days_ret&#39;]].describe()</span>
</span></span><span class="line"><span class="cl"><span class="n">show_df</span> <span class="o">=</span> <span class="n">sub</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask2</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;hold_5Days_ret&#39;</span><span class="p">,</span> <span class="s1">&#39;hold_10Days_ret&#39;</span><span class="p">,</span> <span class="s1">&#39;hold_20Days_ret&#39;</span><span class="p">,</span> <span class="s1">&#39;hold_60Days_ret&#39;</span><span class="p">,</span> <span class="s1">&#39;hold_120Days_ret&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">show_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;precision&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;hold_5Days_ret&#39;</span><span class="p">,</span> <span class="s1">&#39;hold_10Days_ret&#39;</span><span class="p">,</span> <span class="s1">&#39;hold_20Days_ret&#39;</span><span class="p">,</span> <span class="s1">&#39;hold_60Days_ret&#39;</span><span class="p">,</span> <span class="s1">&#39;hold_120Days_ret&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">sub</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask1</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;hold_5Days_winrate&#39;</span><span class="p">,</span> <span class="s1">&#39;hold_10Days_winrate&#39;</span><span class="p">,</span> <span class="s1">&#39;hold_20Days_winrate&#39;</span><span class="p">,</span> <span class="s1">&#39;hold_60Days_winrate&#39;</span><span class="p">,</span> <span class="s1">&#39;hold_120Days_winrate&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">show_df</span>
</span></span></code></pre></div><!-- raw HTML omitted -->
<pre><code>.dataframe tbody tr th {
    vertical-align: top;
}

.dataframe thead th {
    text-align: right;
}
</code></pre>
<p><!-- raw HTML omitted --></p>
<!-- raw HTML omitted -->
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">sub</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="n">res</span><span class="p">[</span><span class="s1">&#39;股票代號&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;2330&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">sub</span> <span class="o">=</span> <span class="n">res</span>
</span></span><span class="line"><span class="cl"><span class="c1"># mask1 = (sub[&#39;cata_0Q_G&#39;] == &#39;80~100_0Q_G&#39;)</span>
</span></span><span class="line"><span class="cl"><span class="n">mask2</span> <span class="o">=</span>  <span class="p">(</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;cata_4Q&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;40~60_4Q&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># sub.loc[mask1 &amp; mask2, [&#39;股票代號&#39;, &#39;日期_dt&#39;,&#39;hold_5Days_ret&#39;, &#39;hold_10Days_ret&#39;, &#39;hold_20Days_ret&#39;, &#39;hold_60Days_ret&#39;, &#39;hold_120Days_ret&#39;]].describe()</span>
</span></span><span class="line"><span class="cl"><span class="n">show_df</span> <span class="o">=</span> <span class="n">sub</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask2</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;hold_5Days_ret&#39;</span><span class="p">,</span> <span class="s1">&#39;hold_10Days_ret&#39;</span><span class="p">,</span> <span class="s1">&#39;hold_20Days_ret&#39;</span><span class="p">,</span> <span class="s1">&#39;hold_60Days_ret&#39;</span><span class="p">,</span> <span class="s1">&#39;hold_120Days_ret&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">show_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;precision&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;hold_5Days_ret&#39;</span><span class="p">,</span> <span class="s1">&#39;hold_10Days_ret&#39;</span><span class="p">,</span> <span class="s1">&#39;hold_20Days_ret&#39;</span><span class="p">,</span> <span class="s1">&#39;hold_60Days_ret&#39;</span><span class="p">,</span> <span class="s1">&#39;hold_120Days_ret&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">sub</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask2</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;hold_5Days_winrate&#39;</span><span class="p">,</span> <span class="s1">&#39;hold_10Days_winrate&#39;</span><span class="p">,</span> <span class="s1">&#39;hold_20Days_winrate&#39;</span><span class="p">,</span> <span class="s1">&#39;hold_60Days_winrate&#39;</span><span class="p">,</span> <span class="s1">&#39;hold_120Days_winrate&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">show_df</span>
</span></span></code></pre></div><!-- raw HTML omitted -->
<pre><code>.dataframe tbody tr th {
    vertical-align: top;
}

.dataframe thead th {
    text-align: right;
}
</code></pre>
<p><!-- raw HTML omitted --></p>
<!-- raw HTML omitted -->
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">sub</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="n">res</span><span class="p">[</span><span class="s1">&#39;股票代號&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;2330&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">sub</span> <span class="o">=</span> <span class="n">res</span>
</span></span><span class="line"><span class="cl"><span class="n">mask1</span> <span class="o">=</span> <span class="p">(</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;cata_0Q_G&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;80~100_0Q_G&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">mask2</span> <span class="o">=</span>  <span class="p">(</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;PEG_4Q&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;PEG_4Q&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># mask2 =  (sub[&#39;PEG_4Q&#39;] &gt; 0) </span>
</span></span><span class="line"><span class="cl"><span class="c1"># sub.loc[mask1 &amp; mask2, [&#39;股票代號&#39;, &#39;日期_dt&#39;,&#39;hold_5Days_ret&#39;, &#39;hold_10Days_ret&#39;, &#39;hold_20Days_ret&#39;, &#39;hold_60Days_ret&#39;, &#39;hold_120Days_ret&#39;]].describe()</span>
</span></span><span class="line"><span class="cl"><span class="n">show_df</span> <span class="o">=</span> <span class="n">sub</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask2</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;hold_5Days_ret&#39;</span><span class="p">,</span> <span class="s1">&#39;hold_10Days_ret&#39;</span><span class="p">,</span> <span class="s1">&#39;hold_20Days_ret&#39;</span><span class="p">,</span> <span class="s1">&#39;hold_60Days_ret&#39;</span><span class="p">,</span> <span class="s1">&#39;hold_120Days_ret&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">show_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;precision&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;hold_5Days_ret&#39;</span><span class="p">,</span> <span class="s1">&#39;hold_10Days_ret&#39;</span><span class="p">,</span> <span class="s1">&#39;hold_20Days_ret&#39;</span><span class="p">,</span> <span class="s1">&#39;hold_60Days_ret&#39;</span><span class="p">,</span> <span class="s1">&#39;hold_120Days_ret&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">sub</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask2</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;hold_5Days_winrate&#39;</span><span class="p">,</span> <span class="s1">&#39;hold_10Days_winrate&#39;</span><span class="p">,</span> <span class="s1">&#39;hold_20Days_winrate&#39;</span><span class="p">,</span> <span class="s1">&#39;hold_60Days_winrate&#39;</span><span class="p">,</span> <span class="s1">&#39;hold_120Days_winrate&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">show_df</span>
</span></span></code></pre></div><!-- raw HTML omitted -->
<pre><code>.dataframe tbody tr th {
    vertical-align: top;
}

.dataframe thead th {
    text-align: right;
}
</code></pre>
<p><!-- raw HTML omitted --></p>
<!-- raw HTML omitted -->
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">sub</span> <span class="o">=</span> <span class="n">res</span>
</span></span><span class="line"><span class="cl"><span class="n">mask1</span> <span class="o">=</span> <span class="p">(</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;cata_0Q_G&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;80~100_0Q_G&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">mask2</span> <span class="o">=</span>  <span class="p">(</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;PEG_4Q&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;PEG_4Q&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">show_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">mask2</span> <span class="o">=</span>  <span class="p">(</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;PEG_0Q&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;PEG_0Q&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mf">0.1</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">show_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">i</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">~</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mf">0.1</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">_mean return&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;hold_5Days_ret&#39;</span><span class="p">,</span> <span class="s1">&#39;hold_10Days_ret&#39;</span><span class="p">,</span> <span class="s1">&#39;hold_20Days_ret&#39;</span><span class="p">,</span> <span class="s1">&#39;hold_60Days_ret&#39;</span><span class="p">,</span> <span class="s1">&#39;hold_120Days_ret&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">sub</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask2</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;hold_5Days_ret&#39;</span><span class="p">,</span> <span class="s1">&#39;hold_10Days_ret&#39;</span><span class="p">,</span> <span class="s1">&#39;hold_20Days_ret&#39;</span><span class="p">,</span> <span class="s1">&#39;hold_60Days_ret&#39;</span><span class="p">,</span> <span class="s1">&#39;hold_120Days_ret&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">show_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">i</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">~</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mf">0.1</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">_precision&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;hold_5Days_ret&#39;</span><span class="p">,</span> <span class="s1">&#39;hold_10Days_ret&#39;</span><span class="p">,</span> <span class="s1">&#39;hold_20Days_ret&#39;</span><span class="p">,</span> <span class="s1">&#39;hold_60Days_ret&#39;</span><span class="p">,</span> <span class="s1">&#39;hold_120Days_ret&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">sub</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask2</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;hold_5Days_winrate&#39;</span><span class="p">,</span> <span class="s1">&#39;hold_10Days_winrate&#39;</span><span class="p">,</span> <span class="s1">&#39;hold_20Days_winrate&#39;</span><span class="p">,</span> <span class="s1">&#39;hold_60Days_winrate&#39;</span><span class="p">,</span> <span class="s1">&#39;hold_120Days_winrate&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">show_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">i</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">~</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mf">0.1</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">_mean return&#39;</span><span class="p">,</span> <span class="s1">&#39;count&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sub</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask2</span><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="n">show_df</span>
</span></span></code></pre></div><!-- raw HTML omitted -->
<pre><code>.dataframe tbody tr th {
    vertical-align: top;
}

.dataframe thead th {
    text-align: right;
}
</code></pre>
<p><!-- raw HTML omitted --></p>
<!-- raw HTML omitted -->
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">show_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">sub</span> <span class="o">=</span> <span class="n">res</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">quantile</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;0~20&#39;</span><span class="p">,</span> <span class="s1">&#39;20~40&#39;</span><span class="p">,</span> <span class="s1">&#39;40~60&#39;</span><span class="p">,</span> <span class="s1">&#39;60~80&#39;</span><span class="p">,</span> <span class="s1">&#39;80~100&#39;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">    <span class="n">mask1</span> <span class="o">=</span> <span class="p">(</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;cata_4Q&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">quantile</span><span class="si">}</span><span class="s1">_4Q&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">show_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;mean_</span><span class="si">{</span><span class="n">quantile</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;hold_5Days_ret&#39;</span><span class="p">,</span> <span class="s1">&#39;hold_10Days_ret&#39;</span><span class="p">,</span> <span class="s1">&#39;hold_20Days_ret&#39;</span><span class="p">,</span> <span class="s1">&#39;hold_60Days_ret&#39;</span><span class="p">,</span> <span class="s1">&#39;hold_120Days_ret&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">sub</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask1</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;hold_5Days_ret&#39;</span><span class="p">,</span> <span class="s1">&#39;hold_10Days_ret&#39;</span><span class="p">,</span> <span class="s1">&#39;hold_20Days_ret&#39;</span><span class="p">,</span> <span class="s1">&#39;hold_60Days_ret&#39;</span><span class="p">,</span> <span class="s1">&#39;hold_120Days_ret&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">show_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;precision_</span><span class="si">{</span><span class="n">quantile</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;hold_5Days_ret&#39;</span><span class="p">,</span> <span class="s1">&#39;hold_10Days_ret&#39;</span><span class="p">,</span> <span class="s1">&#39;hold_20Days_ret&#39;</span><span class="p">,</span> <span class="s1">&#39;hold_60Days_ret&#39;</span><span class="p">,</span> <span class="s1">&#39;hold_120Days_ret&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">sub</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask1</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;hold_5Days_winrate&#39;</span><span class="p">,</span> <span class="s1">&#39;hold_10Days_winrate&#39;</span><span class="p">,</span> <span class="s1">&#39;hold_20Days_winrate&#39;</span><span class="p">,</span> <span class="s1">&#39;hold_60Days_winrate&#39;</span><span class="p">,</span> <span class="s1">&#39;hold_120Days_winrate&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">show_df</span>
</span></span></code></pre></div><!-- raw HTML omitted -->
<pre><code>.dataframe tbody tr th {
    vertical-align: top;
}

.dataframe thead th {
    text-align: right;
}
</code></pre>
<p><!-- raw HTML omitted --></p>
<!-- raw HTML omitted -->
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">res</span><span class="o">.</span><span class="n">columns</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Example data with 8 categories</span>
</span></span><span class="line"><span class="cl"><span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Date&#39;</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="s1">&#39;2024-01-01&#39;</span><span class="p">,</span> <span class="n">periods</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;D&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;Signal&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;Category&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="s1">&#39;C&#39;</span><span class="p">,</span> <span class="s1">&#39;D&#39;</span><span class="p">,</span> <span class="s1">&#39;E&#39;</span><span class="p">,</span> <span class="s1">&#39;F&#39;</span><span class="p">,</span> <span class="s1">&#39;G&#39;</span><span class="p">,</span> <span class="s1">&#39;H&#39;</span><span class="p">,</span> <span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="s1">&#39;B&#39;</span><span class="p">]}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Get unique categories (suppose you have exactly 8 categories)</span>
</span></span><span class="line"><span class="cl"><span class="n">categories</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Category&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Define the number of rows and columns for the subplots</span>
</span></span><span class="line"><span class="cl"><span class="n">n_rows</span><span class="p">,</span> <span class="n">n_cols</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Create subplots for each category in a 2x4 grid</span>
</span></span><span class="line"><span class="cl"><span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">n_rows</span><span class="p">,</span> <span class="n">n_cols</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Flatten the axes array for easier indexing</span>
</span></span><span class="line"><span class="cl"><span class="n">axes</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Loop through each category and plot</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">category</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">categories</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># Filter DataFrame by category</span>
</span></span><span class="line"><span class="cl">    <span class="n">category_df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Category&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">category</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># Get dates where Signal == 1 for that category</span>
</span></span><span class="line"><span class="cl">    <span class="n">signal_dates</span> <span class="o">=</span> <span class="n">category_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">category_df</span><span class="p">[</span><span class="s1">&#39;Signal&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;Date&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># Plot vertical lines on the respective subplot</span>
</span></span><span class="line"><span class="cl">    <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">vlines</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">signal_dates</span><span class="p">,</span> <span class="n">ymin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ymax</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Signal </span><span class="si">{</span><span class="n">category</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Category </span><span class="si">{</span><span class="n">category</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Signal&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># Format the x-axis for dates (shared x-axis)</span>
</span></span><span class="line"><span class="cl">    <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">dates</span><span class="o">.</span><span class="n">DateFormatter</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Hide empty subplots if any (for cases when the grid is larger than needed)</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n_rows</span> <span class="o">*</span> <span class="n">n_cols</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">fig</span><span class="o">.</span><span class="n">delaxes</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Set the xlabel for the subplots in the last row</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axes</span><span class="p">[</span><span class="o">-</span><span class="n">n_cols</span><span class="p">:]:</span>
</span></span><span class="line"><span class="cl">    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Date&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Adjust layout</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="s1">&#39;股票代號&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="s1">&#39;&#39;&#39;
</span></span></span><span class="line"><span class="cl"><span class="s1">Plot 不同組合的signal
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">&#39;&#39;&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">n_rows</span><span class="p">,</span> <span class="n">n_cols</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Create subplots for each category in a 2x4 grid</span>
</span></span><span class="line"><span class="cl"><span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">n_rows</span><span class="p">,</span> <span class="n">n_cols</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Flatten the axes array for easier indexing</span>
</span></span><span class="line"><span class="cl"><span class="n">axes</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ticker</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="s1">&#39;股票代號&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()):</span>
</span></span><span class="line"><span class="cl">    <span class="n">sub</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="n">res</span><span class="p">[</span><span class="s1">&#39;股票代號&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">ticker</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">mask1</span> <span class="o">=</span> <span class="p">(</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;cata_0Q&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;0~20_0Q&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">mask2</span> <span class="o">=</span>  <span class="p">(</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;cata_4Q&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;0~20_4Q&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># sub.loc[mask1 &amp; mask2, [&#39;股票代號&#39;, &#39;日期_dt&#39;,&#39;hold_5Days_ret&#39;, &#39;hold_10Days_ret&#39;, &#39;hold_20Days_ret&#39;, &#39;hold_60Days_ret&#39;, &#39;hold_120Days_ret&#39;]].describe()</span>
</span></span><span class="line"><span class="cl">    <span class="n">sub</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># sub.loc[mask1 &amp; mask2, &#39;signal&#39;] = 1</span>
</span></span><span class="line"><span class="cl">    <span class="n">sub</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask2</span><span class="p">,</span> <span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">ax1</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">331</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># axes[i].set_title(f&#39;{ticker}_0Q 80~100, 4Q 0~20&#39;)</span>
</span></span><span class="line"><span class="cl">    <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">ticker</span><span class="si">}</span><span class="s1">_4Q 0~20&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;日期_dt&#39;</span><span class="p">],</span> <span class="n">sub</span><span class="p">[</span><span class="s1">&#39;收盤價&#39;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;price&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">ax2</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">twinx</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">ax2</span><span class="o">.</span><span class="n">vlines</span><span class="p">(</span><span class="n">sub</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;日期_dt&#39;</span><span class="p">],</span> <span class="n">ymin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ymax</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>  <span class="n">label</span><span class="o">=</span><span class="s1">&#39;signal&#39;</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">ax2</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    
</span></span></code></pre></div><pre><code>/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_1441/2901875589.py:18: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
  sub['signal'] = 0
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_1441/2901875589.py:18: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
  sub['signal'] = 0
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_1441/2901875589.py:18: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
  sub['signal'] = 0
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_1441/2901875589.py:18: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
  sub['signal'] = 0
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_1441/2901875589.py:18: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
  sub['signal'] = 0
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_1441/2901875589.py:18: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
  sub['signal'] = 0
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_1441/2901875589.py:18: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
  sub['signal'] = 0
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_1441/2901875589.py:18: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
  sub['signal'] = 0
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_1441/2901875589.py:18: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
  sub['signal'] = 0
</code></pre>
<p><figure 
	>
	<a href="/my-blog/Final_test_files/Final_test_188_1.png" >
		<img src="/my-blog/Final_test_files/Final_test_188_1.png"
			
			
			
			loading="lazy"
			alt="png">
	</a>
	
	<figcaption>png</figcaption>
	
</figure></p>
<p><figure 
	>
	<a href="/my-blog/Final_test_files/Final_test_188_2.png" >
		<img src="/my-blog/Final_test_files/Final_test_188_2.png"
			
			
			
			loading="lazy"
			alt="png">
	</a>
	
	<figcaption>png</figcaption>
	
</figure></p>
<p><figure 
	>
	<a href="/my-blog/Final_test_files/Final_test_188_3.png" >
		<img src="/my-blog/Final_test_files/Final_test_188_3.png"
			
			
			
			loading="lazy"
			alt="png">
	</a>
	
	<figcaption>png</figcaption>
	
</figure></p>
<p><figure 
	>
	<a href="/my-blog/Final_test_files/Final_test_188_4.png" >
		<img src="/my-blog/Final_test_files/Final_test_188_4.png"
			
			
			
			loading="lazy"
			alt="png">
	</a>
	
	<figcaption>png</figcaption>
	
</figure></p>
<p><figure 
	>
	<a href="/my-blog/Final_test_files/Final_test_188_5.png" >
		<img src="/my-blog/Final_test_files/Final_test_188_5.png"
			
			
			
			loading="lazy"
			alt="png">
	</a>
	
	<figcaption>png</figcaption>
	
</figure></p>
<p><figure 
	>
	<a href="/my-blog/Final_test_files/Final_test_188_6.png" >
		<img src="/my-blog/Final_test_files/Final_test_188_6.png"
			
			
			
			loading="lazy"
			alt="png">
	</a>
	
	<figcaption>png</figcaption>
	
</figure></p>
<p><figure 
	>
	<a href="/my-blog/Final_test_files/Final_test_188_7.png" >
		<img src="/my-blog/Final_test_files/Final_test_188_7.png"
			
			
			
			loading="lazy"
			alt="png">
	</a>
	
	<figcaption>png</figcaption>
	
</figure></p>
<p><figure 
	>
	<a href="/my-blog/Final_test_files/Final_test_188_8.png" >
		<img src="/my-blog/Final_test_files/Final_test_188_8.png"
			
			
			
			loading="lazy"
			alt="png">
	</a>
	
	<figcaption>png</figcaption>
	
</figure></p>
<p><figure 
	>
	<a href="/my-blog/Final_test_files/Final_test_188_9.png" >
		<img src="/my-blog/Final_test_files/Final_test_188_9.png"
			
			
			
			loading="lazy"
			alt="png">
	</a>
	
	<figcaption>png</figcaption>
	
</figure></p>
<p><figure 
	>
	<a href="/my-blog/Final_test_files/Final_test_188_10.png" >
		<img src="/my-blog/Final_test_files/Final_test_188_10.png"
			
			
			
			loading="lazy"
			alt="png">
	</a>
	
	<figcaption>png</figcaption>
	
</figure></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="s1">&#39;&#39;&#39;
</span></span></span><span class="line"><span class="cl"><span class="s1">Plot 不同組合的signal
</span></span></span><span class="line"><span class="cl"><span class="s1">PEG ver.
</span></span></span><span class="line"><span class="cl"><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">&#39;&#39;&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">n_rows</span><span class="p">,</span> <span class="n">n_cols</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Create subplots for each category in a 2x4 grid</span>
</span></span><span class="line"><span class="cl"><span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">n_rows</span><span class="p">,</span> <span class="n">n_cols</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Flatten the axes array for easier indexing</span>
</span></span><span class="line"><span class="cl"><span class="n">axes</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ticker</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="s1">&#39;股票代號&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()):</span>
</span></span><span class="line"><span class="cl">    <span class="n">sub</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="n">res</span><span class="p">[</span><span class="s1">&#39;股票代號&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">ticker</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="n">mask2</span> <span class="o">=</span>  <span class="p">(</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;PEG_4Q&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mf">0.7</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;PEG_4Q&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mf">0.9</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">    <span class="c1"># sub.loc[mask1 &amp; mask2, [&#39;股票代號&#39;, &#39;日期_dt&#39;,&#39;hold_5Days_ret&#39;, &#39;hold_10Days_ret&#39;, &#39;hold_20Days_ret&#39;, &#39;hold_60Days_ret&#39;, &#39;hold_120Days_ret&#39;]].describe()</span>
</span></span><span class="line"><span class="cl">    <span class="n">sub</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># sub.loc[mask1 &amp; mask2, &#39;signal&#39;] = 1</span>
</span></span><span class="line"><span class="cl">    <span class="n">sub</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask2</span><span class="p">,</span> <span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">ax1</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">331</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># axes[i].set_title(f&#39;{ticker}_0Q 80~100, 4Q 0~20&#39;)</span>
</span></span><span class="line"><span class="cl">    <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">ticker</span><span class="si">}</span><span class="s1">_4Q, PEG 0.7~0.9&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;日期_dt&#39;</span><span class="p">],</span> <span class="n">sub</span><span class="p">[</span><span class="s1">&#39;收盤價&#39;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;price&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">ax2</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">twinx</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">ax2</span><span class="o">.</span><span class="n">vlines</span><span class="p">(</span><span class="n">sub</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;日期_dt&#39;</span><span class="p">],</span> <span class="n">ymin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ymax</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>  <span class="n">label</span><span class="o">=</span><span class="s1">&#39;signal&#39;</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">ax2</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    
</span></span></code></pre></div><pre><code>/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_1441/2280781.py:19: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
  sub['signal'] = 0
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_1441/2280781.py:19: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
  sub['signal'] = 0
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_1441/2280781.py:19: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
  sub['signal'] = 0
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_1441/2280781.py:19: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
  sub['signal'] = 0
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_1441/2280781.py:19: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
  sub['signal'] = 0
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_1441/2280781.py:19: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
  sub['signal'] = 0
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_1441/2280781.py:19: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
  sub['signal'] = 0
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_1441/2280781.py:19: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
  sub['signal'] = 0
/var/folders/l8/m7cjxss57kbc_bplh66qpmy40000gn/T/ipykernel_1441/2280781.py:19: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
  sub['signal'] = 0
</code></pre>
<p><figure 
	>
	<a href="/my-blog/Final_test_files/Final_test_189_1.png" >
		<img src="/my-blog/Final_test_files/Final_test_189_1.png"
			
			
			
			loading="lazy"
			alt="png">
	</a>
	
	<figcaption>png</figcaption>
	
</figure></p>
<p><figure 
	>
	<a href="/my-blog/Final_test_files/Final_test_189_2.png" >
		<img src="/my-blog/Final_test_files/Final_test_189_2.png"
			
			
			
			loading="lazy"
			alt="png">
	</a>
	
	<figcaption>png</figcaption>
	
</figure></p>
<p><figure 
	>
	<a href="/my-blog/Final_test_files/Final_test_189_3.png" >
		<img src="/my-blog/Final_test_files/Final_test_189_3.png"
			
			
			
			loading="lazy"
			alt="png">
	</a>
	
	<figcaption>png</figcaption>
	
</figure></p>
<p><figure 
	>
	<a href="/my-blog/Final_test_files/Final_test_189_4.png" >
		<img src="/my-blog/Final_test_files/Final_test_189_4.png"
			
			
			
			loading="lazy"
			alt="png">
	</a>
	
	<figcaption>png</figcaption>
	
</figure></p>
<p><figure 
	>
	<a href="/my-blog/Final_test_files/Final_test_189_5.png" >
		<img src="/my-blog/Final_test_files/Final_test_189_5.png"
			
			
			
			loading="lazy"
			alt="png">
	</a>
	
	<figcaption>png</figcaption>
	
</figure></p>
<p><figure 
	>
	<a href="/my-blog/Final_test_files/Final_test_189_6.png" >
		<img src="/my-blog/Final_test_files/Final_test_189_6.png"
			
			
			
			loading="lazy"
			alt="png">
	</a>
	
	<figcaption>png</figcaption>
	
</figure></p>
<p><figure 
	>
	<a href="/my-blog/Final_test_files/Final_test_189_7.png" >
		<img src="/my-blog/Final_test_files/Final_test_189_7.png"
			
			
			
			loading="lazy"
			alt="png">
	</a>
	
	<figcaption>png</figcaption>
	
</figure></p>
<p><figure 
	>
	<a href="/my-blog/Final_test_files/Final_test_189_8.png" >
		<img src="/my-blog/Final_test_files/Final_test_189_8.png"
			
			
			
			loading="lazy"
			alt="png">
	</a>
	
	<figcaption>png</figcaption>
	
</figure></p>
<p><figure 
	>
	<a href="/my-blog/Final_test_files/Final_test_189_9.png" >
		<img src="/my-blog/Final_test_files/Final_test_189_9.png"
			
			
			
			loading="lazy"
			alt="png">
	</a>
	
	<figcaption>png</figcaption>
	
</figure></p>
<p><figure 
	>
	<a href="/my-blog/Final_test_files/Final_test_189_10.png" >
		<img src="/my-blog/Final_test_files/Final_test_189_10.png"
			
			
			
			loading="lazy"
			alt="png">
	</a>
	
	<figcaption>png</figcaption>
	
</figure></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">sub</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="n">res</span><span class="p">[</span><span class="s1">&#39;股票代號&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;2330&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">mask1</span> <span class="o">=</span> <span class="p">(</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;cata_0Q&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;80~100_0Q&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">mask2</span> <span class="o">=</span>  <span class="p">(</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;cata_4Q&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;0~20_4Q&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># sub.loc[mask1 &amp; mask2, [&#39;股票代號&#39;, &#39;日期_dt&#39;,&#39;hold_5Days_ret&#39;, &#39;hold_10Days_ret&#39;, &#39;hold_20Days_ret&#39;, &#39;hold_60Days_ret&#39;, &#39;hold_120Days_ret&#39;]].describe()</span>
</span></span><span class="line"><span class="cl"><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="n">sub</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask1</span> <span class="o">&amp;</span> <span class="n">mask2</span><span class="p">,</span> <span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">ax1</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">quantile</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">Q holding 120 ret&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;日期_dt&#39;</span><span class="p">],</span> <span class="n">sub</span><span class="p">[</span><span class="s1">&#39;收盤價&#39;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;price&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">ax2</span> <span class="o">=</span> <span class="n">ax1</span><span class="o">.</span><span class="n">twinx</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">ax2</span><span class="o">.</span><span class="n">vlines</span><span class="p">(</span><span class="n">sub</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;日期_dt&#39;</span><span class="p">],</span> <span class="n">ymin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ymax</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>  <span class="n">label</span><span class="o">=</span><span class="s1">&#39;signal&#39;</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">signal_dates</span> <span class="o">=</span> <span class="n">sub</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;日期_dt&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">ax1</span><span class="o">.</span><span class="n">vlines</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">signal_dates</span><span class="p">,</span>  <span class="n">label</span><span class="o">=</span><span class="s1">&#39;signal&#39;</span><span class="p">)</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">sub</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask1</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;hold_5Days_winrate&#39;</span><span class="p">,</span> <span class="s1">&#39;hold_10Days_winrate&#39;</span><span class="p">,</span> <span class="s1">&#39;hold_20Days_winrate&#39;</span><span class="p">,</span> <span class="s1">&#39;hold_60Days_winrate&#39;</span><span class="p">,</span> <span class="s1">&#39;hold_120Days_winrate&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">sub</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;cata_0Q&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;0~20_0Q&#39;</span><span class="p">,</span> <span class="s1">&#39;hold_120Days_ret&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">preview_res</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;2330&#39;</span><span class="p">]</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">res_indexPE</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">IndexPE_res</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">left_on</span><span class="o">=</span><span class="p">([</span><span class="s1">&#39;日期_dt&#39;</span><span class="p">]),</span> <span class="n">right_on</span><span class="o">=</span><span class="p">([</span><span class="s1">&#39;日期_dt&#39;</span><span class="p">]))</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">IndexPE_res</span><span class="o">.</span><span class="n">columns</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">res_indexPE</span><span class="p">[</span><span class="s1">&#39;股票代號&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">sub</span> <span class="o">=</span> <span class="n">IndexPE_res</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">IndexPE_res</span><span class="p">[</span><span class="s1">&#39;日期_dt&#39;</span><span class="p">]</span><span class="o">&gt;</span><span class="s1">&#39;20030701&#39;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">IndexPE_res</span><span class="p">[</span><span class="s1">&#39;日期_dt&#39;</span><span class="p">]</span><span class="o">&lt;</span><span class="s1">&#39;20101231&#39;</span><span class="p">),</span> <span class="p">[</span><span class="s1">&#39;日期_dt&#39;</span><span class="p">,</span><span class="s1">&#39;agg_PE_0Q&#39;</span><span class="p">,</span> <span class="s1">&#39;agg_PE_1Q&#39;</span><span class="p">,</span> <span class="s1">&#39;agg_PE_2Q&#39;</span><span class="p">,</span> <span class="s1">&#39;agg_PE_3Q&#39;</span><span class="p">,</span> <span class="s1">&#39;agg_PE_4Q&#39;</span><span class="p">]]</span>
</span></span><span class="line"><span class="cl"><span class="n">sub</span> <span class="o">=</span> <span class="n">IndexPE_res</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">IndexPE_res</span><span class="p">[</span><span class="s1">&#39;日期_dt&#39;</span><span class="p">]</span><span class="o">&gt;</span><span class="s1">&#39;20101231&#39;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">IndexPE_res</span><span class="p">[</span><span class="s1">&#39;日期_dt&#39;</span><span class="p">]</span><span class="o">&lt;</span><span class="s1">&#39;20191231&#39;</span><span class="p">),</span> <span class="p">[</span><span class="s1">&#39;日期_dt&#39;</span><span class="p">,</span><span class="s1">&#39;agg_PE_0Q&#39;</span><span class="p">,</span> <span class="s1">&#39;agg_PE_1Q&#39;</span><span class="p">,</span> <span class="s1">&#39;agg_PE_2Q&#39;</span><span class="p">,</span> <span class="s1">&#39;agg_PE_3Q&#39;</span><span class="p">,</span> <span class="s1">&#39;agg_PE_4Q&#39;</span><span class="p">]]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">sub</span> <span class="o">=</span> <span class="n">res_indexPE</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">res_indexPE</span><span class="p">[</span><span class="s1">&#39;日期_dt&#39;</span><span class="p">]</span><span class="o">&gt;</span><span class="s1">&#39;20121231&#39;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">res_indexPE</span><span class="p">[</span><span class="s1">&#39;日期_dt&#39;</span><span class="p">]</span><span class="o">&lt;</span><span class="s1">&#39;20240509&#39;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">res_indexPE</span><span class="p">[</span><span class="s1">&#39;股票代號&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;2330&#39;</span><span class="p">),</span> <span class="p">[</span><span class="s1">&#39;日期_dt&#39;</span><span class="p">,</span> <span class="s1">&#39;股票代號&#39;</span><span class="p">,</span><span class="sa">f</span><span class="s1">&#39;agg_PE_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">Q&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;PE_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">Q&#39;</span><span class="p">]]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">i</span> <span class="o">=</span> <span class="mi">4</span>
</span></span><span class="line"><span class="cl"><span class="n">sub</span> <span class="o">=</span> <span class="n">res_indexPE</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">res_indexPE</span><span class="p">[</span><span class="s1">&#39;日期_dt&#39;</span><span class="p">]</span><span class="o">&gt;</span><span class="s1">&#39;20161231&#39;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">res_indexPE</span><span class="p">[</span><span class="s1">&#39;日期_dt&#39;</span><span class="p">]</span><span class="o">&lt;</span><span class="s1">&#39;20231109&#39;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">res_indexPE</span><span class="p">[</span><span class="s1">&#39;股票代號&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;8069&#39;</span><span class="p">),</span> <span class="p">[</span><span class="s1">&#39;日期_dt&#39;</span><span class="p">,</span> <span class="s1">&#39;股票代號&#39;</span><span class="p">,</span><span class="sa">f</span><span class="s1">&#39;agg_PE_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">Q&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;PE_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">Q&#39;</span><span class="p">]]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">ax1</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">ticker</span> <span class="o">=</span> <span class="n">sub</span><span class="p">[</span><span class="s1">&#39;股票代號&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Index PE vs </span><span class="si">{</span><span class="n">ticker</span><span class="si">}</span><span class="s1">_forward</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">Q&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;日期_dt&#39;</span><span class="p">],</span> <span class="n">sub</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;PE_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">Q&#39;</span><span class="p">],</span>  <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">ticker</span><span class="si">}</span><span class="s1">_PE_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">Q&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;日期_dt&#39;</span><span class="p">],</span> <span class="n">sub</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;agg_PE_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">Q&#39;</span><span class="p">],</span>  <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;index_PE_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">Q&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">ticker</span> <span class="o">=</span> <span class="p">(</span><span class="n">res_indexPE</span><span class="p">[</span><span class="s1">&#39;股票代號&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;2330&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">q</span> <span class="o">=</span> <span class="mi">4</span>
</span></span><span class="line"><span class="cl"><span class="n">tmp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">8</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">    <span class="n">signal</span> <span class="o">=</span> <span class="p">(</span><span class="n">res_indexPE</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;PE_</span><span class="si">{</span><span class="n">q</span><span class="si">}</span><span class="s1">Q&#39;</span><span class="p">]</span><span class="o">&gt;</span><span class="n">res_indexPE</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;agg_PE_</span><span class="si">{</span><span class="n">q</span><span class="si">}</span><span class="s1">Q&#39;</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">res_indexPE</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;PE_</span><span class="si">{</span><span class="n">q</span><span class="si">}</span><span class="s1">Q&#39;</span><span class="p">]</span><span class="o">&lt;</span><span class="n">res_indexPE</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;q</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">0&#39;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># tmp.loc[f&#39;&lt;q{i}0&#39;, [&#39;hold_5Days_ret&#39;, &#39;hold_10Days_ret&#39;, &#39;hold_20Days_ret&#39;, &#39;hold_60Days_ret&#39;, &#39;hold_120Days_ret&#39;]] = res_indexPE.loc[signal, [&#39;hold_5Days_ret&#39;, &#39;hold_10Days_ret&#39;, &#39;hold_20Days_ret&#39;, &#39;hold_60Days_ret&#39;, &#39;hold_120Days_ret&#39;]].mean()</span>
</span></span><span class="line"><span class="cl">    <span class="n">tmp</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;&lt;q</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">0&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;hold_5Days_winrate&#39;</span><span class="p">,</span> <span class="s1">&#39;hold_10Days_winrate&#39;</span><span class="p">,</span> <span class="s1">&#39;hold_20Days_winrate&#39;</span><span class="p">,</span> <span class="s1">&#39;hold_60Days_winrate&#39;</span><span class="p">,</span> <span class="s1">&#39;hold_120Days_winrate&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">res_indexPE</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">signal</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;hold_5Days_winrate&#39;</span><span class="p">,</span> <span class="s1">&#39;hold_10Days_winrate&#39;</span><span class="p">,</span> <span class="s1">&#39;hold_20Days_winrate&#39;</span><span class="p">,</span> <span class="s1">&#39;hold_60Days_winrate&#39;</span><span class="p">,</span> <span class="s1">&#39;hold_120Days_winrate&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># res_indexPE.loc[signal, [&#39;hold_5Days_winrate&#39;, &#39;hold_10Days_winrate&#39;, &#39;hold_20Days_winrate&#39;, &#39;hold_60Days_winrate&#39;, &#39;hold_120Days_winrate&#39;]].describe()</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">tmp</span>
</span></span></code></pre></div><p>cumsum or rolling min/max + shift 就可以了</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">rolling_max</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;&#39;&#39;
</span></span></span><span class="line"><span class="cl"><span class="s1">    groupby ticker
</span></span></span><span class="line"><span class="cl"><span class="s1">    &#39;&#39;&#39;</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">_cummax_PE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pe_res</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">_max_PE&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">cummax</span><span class="p">()</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">_cummin_PE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pe_res</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">_min_PE&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">cummin</span><span class="p">()</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">_cummean_PE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pe_res</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">_min_PE&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">expanding</span><span class="p">()</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">_rolling5ymax_PE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pe_res</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">_max_PE&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">_rolling5ymin_PE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pe_res</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">_min_PE&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">_rolling5ymean_PE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pe_res</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">_min_PE&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">_rolling3ymax_PE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pe_res</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">_max_PE&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">_rolling3ymin_PE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pe_res</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">_min_PE&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">_rolling3ymean_PE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pe_res</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">_min_PE&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">_rolling10ymax_PE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pe_res</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">_max_PE&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">40</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">_rolling10ymin_PE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pe_res</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">_min_PE&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">40</span><span class="p">)</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">df</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">_rolling10ymean_PE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pe_res</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">_min_PE&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">40</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">df</span>
</span></span><span class="line"><span class="cl">        
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">pe_res</span> <span class="o">=</span> <span class="n">pe_res</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;股票代號&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">rolling_max</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># cumsum 至上一季 PE最高值, cumsum 至上一季 PE最低值, rolling 5y 至上一季 PE最高值,  rolling 5y 至上一季 PE最低值</span>
</span></span><span class="line"><span class="cl"><span class="n">pe_res</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">pe_res</span><span class="p">[</span><span class="s1">&#39;股票代號&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;2330&#39;</span><span class="p">)</span> <span class="p">,</span> <span class="p">[</span><span class="s1">&#39;年季&#39;</span><span class="p">,</span> <span class="s1">&#39;1_cummax_PE&#39;</span><span class="p">,</span> <span class="s1">&#39;1_cummin_PE&#39;</span><span class="p">,</span> <span class="s1">&#39;1_rolling5ymax_PE&#39;</span><span class="p">,</span> <span class="s1">&#39;1_rolling5ymin_PE&#39;</span><span class="p">]]</span>
</span></span></code></pre></div><h3 id="把-截至上一季-pe的高低點-算出來後-與股價merge">把 截至上一季 PE的高低點 算出來後 與股價merge</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">combine_df</span> <span class="o">=</span> <span class="n">combine_df</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">pe_res</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">left_on</span><span class="o">=</span><span class="p">([</span><span class="s1">&#39;股票代號&#39;</span><span class="p">,</span> <span class="s1">&#39;年季&#39;</span><span class="p">]),</span> <span class="n">right_on</span><span class="o">=</span><span class="p">([</span><span class="s1">&#39;股票代號&#39;</span><span class="p">,</span> <span class="s1">&#39;年季&#39;</span><span class="p">]),</span> <span class="n">suffixes</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;_MINMAX&#39;</span><span class="p">))</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">combine_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">combine_df</span><span class="p">[</span><span class="s1">&#39;股票代號&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;2330&#39;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">combine_df</span><span class="p">[</span><span class="s1">&#39;年季&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;202301&#39;</span><span class="p">)</span> <span class="p">,</span> <span class="p">[</span><span class="s1">&#39;日期&#39;</span><span class="p">,</span><span class="s1">&#39;PE_1Q&#39;</span> <span class="p">,</span><span class="s1">&#39;1_cummax_PE&#39;</span><span class="p">,</span> <span class="s1">&#39;1_cummin_PE&#39;</span><span class="p">,</span> <span class="s1">&#39;1_rolling5ymax_PE&#39;</span><span class="p">,</span> <span class="s1">&#39;1_rolling5ymin_PE&#39;</span><span class="p">]]</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">combine_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">combine_df</span><span class="p">[</span><span class="s1">&#39;股票代號&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;2454&#39;</span><span class="p">),</span> <span class="p">[</span><span class="s1">&#39;日期&#39;</span><span class="p">,</span> <span class="s1">&#39;收盤價&#39;</span><span class="p">,</span> <span class="s1">&#39;PE_1Q&#39;</span><span class="p">,</span> <span class="s1">&#39;knowNext1Q&#39;</span><span class="p">,</span> <span class="s1">&#39;1_rolling5ymax_PE&#39;</span><span class="p">,</span> <span class="s1">&#39;1_rolling5ymin_PE&#39;</span><span class="p">,</span> <span class="s1">&#39;1_rolling5ymean_PE&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">combine_df</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;knowNext</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">Q_5y最高價&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">combine_df</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;knowNext</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">Q&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">combine_df</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">_rolling5ymax_PE&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">combine_df</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;knowNext</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">Q_5y最低價&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">combine_df</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;knowNext</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">Q&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">combine_df</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">_rolling5ymin_PE&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">combine_df</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;knowNext</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">Q_5y平均價&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">combine_df</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;knowNext</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">Q&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">combine_df</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">_rolling5ymean_PE&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">combine_df</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;knowNext</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">Q_3y最高價&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">combine_df</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;knowNext</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">Q&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">combine_df</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">_rolling3ymax_PE&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">combine_df</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;knowNext</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">Q_3y最低價&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">combine_df</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;knowNext</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">Q&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">combine_df</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">_rolling3ymin_PE&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">combine_df</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;knowNext</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">Q_3y平均價&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">combine_df</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;knowNext</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">Q&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">combine_df</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">_rolling3ymean_PE&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">combine_df</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;knowNext</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">Q_10y最高價&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">combine_df</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;knowNext</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">Q&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">combine_df</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">_rolling10ymax_PE&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">combine_df</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;knowNext</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">Q_10y最低價&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">combine_df</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;knowNext</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">Q&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">combine_df</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">_rolling10ymin_PE&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">combine_df</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;knowNext</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">Q_10y平均價&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">combine_df</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;knowNext</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">Q&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">combine_df</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">_rolling10ymean_PE&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">combine_df</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;knowNext</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">Q_cumsum最高價&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">combine_df</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;knowNext</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">Q&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">combine_df</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">_cummax_PE&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">combine_df</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;knowNext</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">Q_cumsum最低價&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">combine_df</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;knowNext</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">Q&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">combine_df</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">_cummin_PE&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">combine_df</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;knowNext</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">Q_cumsum平均價&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">combine_df</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;knowNext</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">Q&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">combine_df</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">_cummean_PE&#39;</span><span class="p">]</span>    
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1">#  在知曉下一季EPS後 利用過往3季 + 未來1季 去算年度EPS</span>
</span></span><span class="line"><span class="cl"><span class="c1">#  在用該EPS 與當下股價計算 預知PE</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 期間預知PE的min, max 將獨立出來</span>
</span></span><span class="line"><span class="cl"><span class="n">combine_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">combine_df</span><span class="p">[</span><span class="s1">&#39;股票代號&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;8069&#39;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">combine_df</span><span class="p">[</span><span class="s1">&#39;年季&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;202301&#39;</span><span class="p">),</span> <span class="p">[</span><span class="s1">&#39;日期&#39;</span><span class="p">,</span> <span class="s1">&#39;PE_1Q&#39;</span><span class="p">,</span> <span class="s1">&#39;1_max_PE&#39;</span><span class="p">,</span> <span class="s1">&#39;1_min_PE&#39;</span><span class="p">,</span> <span class="s1">&#39;1_mean_PE&#39;</span><span class="p">,</span> <span class="s1">&#39;hold_20Days_ret&#39;</span><span class="p">,</span> <span class="s1">&#39;hold_60Days_ret&#39;</span><span class="p">,</span> <span class="s1">&#39;hold_120Days_ret&#39;</span><span class="p">]]</span>
</span></span></code></pre></div><h3 id="繪製本益比河流圖時-河流應為過去一段時間的min-max">繪製本益比河流圖時 河流應為過去一段時間的min, max</h3>
<p>ex : under 知曉下一Q EPS的情況下<br>
過去10年 所有在知曉下一Q對應的EPS<br>
min, max 作為河流 對照如今的 預知PE</p>
<p>可以try 的財務指標</p>
<ol>
<li>存貨(千)</li>
<li>研發費用(千)</li>
<li>PPE (不動產相關的變化)</li>
</ol>
<p>先做圖 在想要怎麼辦</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">combine_df</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">30</span><span class="p">]</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">combine_df</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">30</span><span class="p">:</span><span class="mi">60</span><span class="p">]</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">combine_df</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">60</span><span class="p">:</span><span class="mi">90</span><span class="p">]</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">combine_df</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">90</span><span class="p">:</span><span class="mi">120</span><span class="p">]</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">combine_df</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">120</span><span class="p">:</span><span class="mi">150</span><span class="p">]</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">combine_df</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">150</span><span class="p">:</span><span class="mi">180</span><span class="p">]</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">combine_df</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">180</span><span class="p">:</span><span class="mi">210</span><span class="p">]</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">combine_df</span><span class="p">[</span><span class="s1">&#39;股票代號&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">sub</span> <span class="o">=</span> <span class="n">combine_df</span><span class="p">[</span><span class="n">combine_df</span><span class="p">[</span><span class="s1">&#39;股票代號&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;2330&#39;</span><span class="p">]</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">sub</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">set_signal</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># Initialize the signal and state</span>
</span></span><span class="line"><span class="cl">    <span class="n">i</span> <span class="o">=</span> <span class="mi">4</span>
</span></span><span class="line"><span class="cl">    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">data</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;PE_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">Q&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">data</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">_rolling5ymean_PE&#39;</span><span class="p">]),</span> <span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="n">state</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># 0: Normal, 1: Lower bound hit, 2: Rebounding</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">state</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># Normal period</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;PE_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">Q&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">row</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">_rolling5ymean_PE&#39;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">                <span class="n">data</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">                <span class="n">state</span> <span class="o">=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">        <span class="k">elif</span> <span class="n">state</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># After hitting the lower bound, waiting for rebound</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;PE_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">Q&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">row</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">_rolling5ymean_PE&#39;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">                <span class="n">data</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">                <span class="n">state</span> <span class="o">=</span> <span class="mi">2</span>
</span></span><span class="line"><span class="cl">        <span class="k">elif</span> <span class="n">state</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># Rebounding, waiting for upper bound</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;PE_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">Q&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">row</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">_rolling5ymax_PE&#39;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">                <span class="n">data</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">                <span class="n">state</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">data</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">data</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">set_signal</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># Initialize the signal and state</span>
</span></span><span class="line"><span class="cl">    <span class="n">i</span> <span class="o">=</span> <span class="mi">4</span>
</span></span><span class="line"><span class="cl">    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">data</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;PE_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">Q&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">data</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">_rolling5ymin_PE&#39;</span><span class="p">]),</span> <span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="n">state</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># 0: Normal, 1: Lower bound hit, 2: Rebounding</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">state</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># Normal period</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;PE_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">Q&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">row</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">_rolling5ymin_PE&#39;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">                <span class="n">data</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">                <span class="n">state</span> <span class="o">=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">        <span class="k">elif</span> <span class="n">state</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># After hitting the lower bound, waiting for rebound</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;PE_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">Q&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">row</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">_rolling5ymin_PE&#39;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">                <span class="n">data</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">                <span class="n">state</span> <span class="o">=</span> <span class="mi">2</span>
</span></span><span class="line"><span class="cl">        <span class="k">elif</span> <span class="n">state</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># Rebounding, waiting for upper bound</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;PE_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">Q&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">row</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">_rolling5ymax_PE&#39;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">                <span class="n">data</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">                <span class="n">state</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">data</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">data</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># 反向</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">set_signal_reverse</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># Initialize the signal and state</span>
</span></span><span class="line"><span class="cl">    <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">data</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;PE_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">Q&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">_rolling5ymax_PE&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">0.7</span><span class="p">)),</span> <span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="n">state</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># 0: Normal, 1: Lower bound hit, 2: Rebounding</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">state</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># Normal period</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;PE_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">Q&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">_rolling5ymax_PE&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">0.7</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="n">data</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">                <span class="n">state</span> <span class="o">=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">        <span class="k">elif</span> <span class="n">state</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># After hitting the lower bound, waiting for rebound</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;PE_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">Q&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">row</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">_rolling5ymean_PE&#39;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">                <span class="n">data</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">                <span class="n">state</span> <span class="o">=</span> <span class="mi">2</span>
</span></span><span class="line"><span class="cl">        <span class="k">elif</span> <span class="n">state</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># Rebounding, waiting for upper bound</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;PE_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">Q&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">row</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">_rolling5ymean_PE&#39;</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">                <span class="n">data</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">                <span class="n">state</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">data</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">data</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># 反向</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">set_signal_reverse</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># Initialize the signal and state</span>
</span></span><span class="line"><span class="cl">    <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">data</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;PE_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">Q&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">_rolling5ymean_PE&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1.2</span><span class="p">))</span> <span class="o">*</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;PE_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">Q&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">_rolling5ymax_PE&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">0.9</span><span class="p">)),</span> <span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="n">state</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># 0: Normal, 1: Lower bound hit, 2: Rebounding</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">state</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># Normal period</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;PE_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">Q&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">_rolling5ymean_PE&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1.2</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="n">data</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">                <span class="n">state</span> <span class="o">=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">        <span class="k">elif</span> <span class="n">state</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># After hitting the lower bound, waiting for rebound</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;PE_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">Q&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">_rolling5ymax_PE&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">0.9</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="n">data</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">                <span class="n">state</span> <span class="o">=</span> <span class="mi">2</span>
</span></span><span class="line"><span class="cl">        <span class="k">elif</span> <span class="n">state</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># Rebounding, waiting for upper bound</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;PE_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">Q&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">_rolling5ymean_PE&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1.2</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="n">data</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">                
</span></span><span class="line"><span class="cl">            <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">data</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">                <span class="n">state</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">data</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">signal_df</span> <span class="o">=</span> <span class="n">combine_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;股票代號&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">set_signal</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">signal_df</span> <span class="o">=</span> <span class="n">combine_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;股票代號&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">set_signal_reverse</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">vector_backtest_delay_entering</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">delay_days</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># prodction ver.</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># input: df, 需要有signal columns, output : [{trade_data1}, {trade_data2}, ...] (list中包含多個dict)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># df[&#39;signal&#39;] != df[&#39;signal&#39;].shift(1) 會return boolean, 對此用cumsum</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 在false的時候 就不會+1 就可以讓連續的組出現一樣的數字</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># [0  , 1, 1, 0, 0, 1, 1, 1] (df[&#39;signal&#39;])</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># [nan, 0, 1, 1, 0, 0, 1, 1] (df[&#39;signal&#39;].shift(1))</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># [T, T, F, T, F, T, F, F] -&gt; [1, 2, 2, 3, 3, 4, 4, 4](cumsum)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 然而連續組 同時包含signal==1 &amp; signal==0 部分</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 利用df[signal]==1 來取得signal==1的index</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">## 想要include 最新持有的狀態 -&gt; 若是最後一個row 的連續持有日期 &gt;=4 (3個訊號 隔日才會買進 目前沒有持有)</span>
</span></span><span class="line"><span class="cl">    <span class="c1">## return的計算 要改</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;日期&#39;</span><span class="p">,</span> <span class="s1">&#39;股票代號&#39;</span><span class="p">,</span> <span class="s1">&#39;收盤價&#39;</span><span class="p">,</span> <span class="s1">&#39;signal&#39;</span><span class="p">]):</span>
</span></span><span class="line"><span class="cl">        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s2">&#34;df.columns should have 日期, 股票代號, 收盤價, signal&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;次日收盤價&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;收盤價&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;次二日收盤價&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;收盤價&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># 用來確認退場reaso</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 將所有連續的事件相同數字表示, 而事件轉換時, 數字不相同</span>
</span></span><span class="line"><span class="cl">    <span class="n">change_indices</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span> 
</span></span><span class="line"><span class="cl">    <span class="c1"># 只想要group signal==1的事件</span>
</span></span><span class="line"><span class="cl">    <span class="n">groups</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">change_indices</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">event_list_all</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;&#39;&#39;
</span></span></span><span class="line"><span class="cl"><span class="s1">        盤後才知道訊號, 故操作都會在後續日期...
</span></span></span><span class="line"><span class="cl"><span class="s1">        訊號開始日期(start_date): 該日收盤後有符合訊號, 故買入價會是隔一日的收盤價
</span></span></span><span class="line"><span class="cl"><span class="s1">        訊號最後日期(end_date): 代表隔日收盤後就無訊號, 故賣出價是訊號最後日的隔二日收盤價
</span></span></span><span class="line"><span class="cl"><span class="s1">        ex: date=[10/1, 10/2, 10/3, 10/4], signal = [1, 1, 0, 0]
</span></span></span><span class="line"><span class="cl"><span class="s1">        則10/1為訊號開始日期 -&gt; 10/2收盤價買入
</span></span></span><span class="line"><span class="cl"><span class="s1">        10/2為訊號最後日期 -&gt; 10/3收盤才知道訊號結束 -&gt; 10/4收盤賣出 
</span></span></span><span class="line"><span class="cl"><span class="s1">        &#39;&#39;&#39;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">group</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">delay_days</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># 訊號數不足 不會進場</span>
</span></span><span class="line"><span class="cl">            <span class="k">continue</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">group</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">group</span> <span class="o">=</span> <span class="n">group</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">delay_days</span><span class="p">::]</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1"># extract info from group</span>
</span></span><span class="line"><span class="cl">        <span class="n">trading_dict</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">           <span class="s1">&#39;股票代號&#39;</span><span class="p">:</span> <span class="n">group</span><span class="p">[</span><span class="s1">&#39;股票代號&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">           <span class="s1">&#39;買入日期&#39;</span><span class="p">:</span> <span class="n">group</span><span class="p">[</span><span class="s1">&#39;日期&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">           <span class="s1">&#39;賣出日期&#39;</span><span class="p">:</span> <span class="n">group</span><span class="p">[</span><span class="s1">&#39;日期&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">           <span class="s1">&#39;買入價&#39;</span> <span class="p">:</span> <span class="n">group</span><span class="p">[</span><span class="s1">&#39;次日收盤價&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">           <span class="s1">&#39;賣出價&#39;</span> <span class="p">:</span> <span class="n">group</span><span class="p">[</span><span class="s1">&#39;次二日收盤價&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">           <span class="s1">&#39;期間最高價&#39;</span> <span class="p">:</span> <span class="n">group</span><span class="p">[</span><span class="s1">&#39;次日收盤價&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">           <span class="s1">&#39;持有天數&#39;</span> <span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">group</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">           <span class="s1">&#39;持有狀態&#39;</span> <span class="p">:</span> <span class="s1">&#39;history&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">           <span class="s1">&#39;return&#39;</span> <span class="p">:</span>  <span class="p">(</span><span class="n">group</span><span class="p">[</span><span class="s1">&#39;次二日收盤價&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">group</span><span class="p">[</span><span class="s1">&#39;次日收盤價&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="n">event_list_all</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">trading_dict</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># production情況下 每日最新一個group的狀況不一定</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;&#39;&#39;
</span></span></span><span class="line"><span class="cl"><span class="s1">    原本是收盤後跑 下午3點跑
</span></span></span><span class="line"><span class="cl"><span class="s1">    改為開盤前 早上8點跑 這樣昨天的data一定更新好了 故 持有狀態的用詞修改
</span></span></span><span class="line"><span class="cl"><span class="s1">    從buy_tomorrow -&gt; buy_today
</span></span></span><span class="line"><span class="cl"><span class="s1">    &#39;&#39;&#39;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">event_list_all</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">vector_backtest_delay_entering</span><span class="p">(</span><span class="n">sub</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">res</span> <span class="o">=</span> <span class="n">signal_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;股票代號&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">df</span> <span class="p">:</span> <span class="n">vector_backtest_delay_entering</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">res</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Simulated data with multiple cycles</span>
</span></span><span class="line"><span class="cl"><span class="n">dates</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">([</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;2024-01-01&#39;</span><span class="p">,</span> <span class="s1">&#39;2024-01-02&#39;</span><span class="p">,</span> <span class="s1">&#39;2024-01-03&#39;</span><span class="p">,</span> <span class="s1">&#39;2024-01-04&#39;</span><span class="p">,</span> <span class="s1">&#39;2024-01-05&#39;</span><span class="p">,</span>  
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;2024-01-06&#39;</span><span class="p">,</span> <span class="s1">&#39;2024-01-07&#39;</span><span class="p">,</span> <span class="s1">&#39;2024-01-08&#39;</span><span class="p">,</span>  
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;2024-01-09&#39;</span><span class="p">,</span> <span class="s1">&#39;2024-01-10&#39;</span><span class="p">,</span> <span class="s1">&#39;2024-01-11&#39;</span><span class="p">,</span> <span class="s1">&#39;2024-01-12&#39;</span><span class="p">,</span>  
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;2024-01-13&#39;</span><span class="p">,</span> <span class="s1">&#39;2024-01-14&#39;</span><span class="p">,</span>  
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;2024-01-15&#39;</span><span class="p">,</span> <span class="s1">&#39;2024-01-16&#39;</span><span class="p">,</span> <span class="s1">&#39;2024-01-17&#39;</span><span class="p">,</span>  
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;2024-01-18&#39;</span><span class="p">,</span> <span class="s1">&#39;2024-01-19&#39;</span><span class="p">,</span> <span class="s1">&#39;2024-01-20&#39;</span>
</span></span><span class="line"><span class="cl"><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Simulated P/E ratios</span>
</span></span><span class="line"><span class="cl"><span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;PE_ratio&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">20</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span>  
</span></span><span class="line"><span class="cl">                 <span class="mi">10</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span>  
</span></span><span class="line"><span class="cl">                 <span class="mi">14</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span>  
</span></span><span class="line"><span class="cl">                 <span class="mi">35</span><span class="p">,</span> <span class="mi">36</span><span class="p">,</span>  
</span></span><span class="line"><span class="cl">                 <span class="mi">10</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span>  
</span></span><span class="line"><span class="cl">                 <span class="mi">15</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">20</span><span class="p">],</span>  
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;Adj Close&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dates</span><span class="p">))</span> <span class="o">*</span> <span class="mi">10</span> <span class="o">+</span> <span class="mi">100</span>  
</span></span><span class="line"><span class="cl"><span class="p">},</span> <span class="n">index</span><span class="o">=</span><span class="n">dates</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Parameters</span>
</span></span><span class="line"><span class="cl"><span class="n">lower_bound</span> <span class="o">=</span> <span class="mi">10</span>
</span></span><span class="line"><span class="cl"><span class="n">upper_bound</span> <span class="o">=</span> <span class="mi">35</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Initialize the signal and state</span>
</span></span><span class="line"><span class="cl"><span class="n">data</span><span class="p">[</span><span class="s1">&#39;Signal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;PE_ratio&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">lower_bound</span><span class="p">),</span> <span class="s1">&#39;Signal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">state</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># 0: Normal, 1: Lower bound hit, 2: Rebounding</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)):</span>
</span></span><span class="line"><span class="cl">    <span class="n">pe_ratio</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;PE_ratio&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">state</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># Normal period</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">pe_ratio</span> <span class="o">&lt;=</span> <span class="n">lower_bound</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">data</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s1">&#39;Signal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">            <span class="n">state</span> <span class="o">=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="n">state</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># After hitting the lower bound, waiting for rebound</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">pe_ratio</span> <span class="o">&gt;</span> <span class="n">lower_bound</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">data</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s1">&#39;Signal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">            <span class="n">state</span> <span class="o">=</span> <span class="mi">2</span>
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="n">state</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># Rebounding, waiting for upper bound</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">pe_ratio</span> <span class="o">&gt;=</span> <span class="n">upper_bound</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">data</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s1">&#39;Signal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">            <span class="n">state</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">data</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s1">&#39;Signal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Filtered Data with Signals:&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">trading_dict</span> <span class="o">=</span> <span class="n">signal_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;股票代號&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">df</span> <span class="p">:</span> <span class="n">vector_backtest_delay_entering</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"> <span class="c1"># 整理backtest result</span>
</span></span><span class="line"><span class="cl"><span class="n">code</span> <span class="o">=</span> <span class="n">signal_df</span><span class="p">[</span><span class="s1">&#39;股票代號&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">res_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">code</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">tmp</span> <span class="o">=</span> <span class="n">trading_dict</span><span class="p">[</span><span class="n">c</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">tmp_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="ow">not</span> <span class="n">tmp_df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">res_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">res_df</span><span class="p">,</span> <span class="n">tmp_df</span><span class="p">],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">code</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">res_df</span><span class="p">[</span><span class="s1">&#39;precision&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">res_df</span><span class="p">[</span><span class="s1">&#39;return&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span> <span class="p">:</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">res_df</span><span class="p">[[</span><span class="s1">&#39;return&#39;</span><span class="p">,</span> <span class="s1">&#39;precision&#39;</span><span class="p">,</span><span class="s1">&#39;持有天數&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">res_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">res_df</span><span class="p">[</span><span class="s1">&#39;股票代號&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;2383&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;return&#39;</span><span class="p">,</span> <span class="s1">&#39;持有天數&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">code</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="n">res_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">res_df</span><span class="p">[</span><span class="s1">&#39;股票代號&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">i</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;return&#39;</span><span class="p">,</span> <span class="s1">&#39;持有天數&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">describe</span><span class="p">())</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">trading_dict</span><span class="p">[</span><span class="s1">&#39;2059&#39;</span><span class="p">]</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;forwardPE&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">expanding</span><span class="p">()</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># combine_df = price_df.merge(resample_mon_df, how=&#39;left&#39;, left_on=([&#39;日期_dt&#39;, &#39;股票代號&#39;]), right_on=([&#39;公告日_dt&#39;, &#39;股票代號&#39;]))</span>
</span></span></code></pre></div><h2 id="columns-展示">columns 展示</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">combine_df</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">30</span><span class="p">]</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">combine_df</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">30</span><span class="p">:</span><span class="mi">60</span><span class="p">]</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">combine_df</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">60</span><span class="p">:</span><span class="mi">90</span><span class="p">]</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">combine_df</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">90</span><span class="p">:</span><span class="mi">120</span><span class="p">]</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">combine_df</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">120</span><span class="p">:</span><span class="mi">150</span><span class="p">]</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">combine_df</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">150</span><span class="p">:</span><span class="mi">180</span><span class="p">]</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Create subplots without shared axes</span>
</span></span><span class="line"><span class="cl"><span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Flatten the axes array for easy iteration</span>
</span></span><span class="line"><span class="cl"><span class="n">axes</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Group by &#39;Stock&#39; and plot each group in a separate subplot</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">ax</span><span class="p">,</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">axes</span><span class="p">,</span> <span class="n">combine_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;股票代號&#39;</span><span class="p">)):</span>
</span></span><span class="line"><span class="cl">    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">group</span><span class="p">[</span><span class="s1">&#39;日期_dt&#39;</span><span class="p">],</span> <span class="n">group</span><span class="p">[</span><span class="s1">&#39;收盤價&#39;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Price&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Date&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># ax.set_ylabel(&#39;Price&#39;, color=&#39;blue&#39;)</span>
</span></span><span class="line"><span class="cl">    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># Create a secondary y-axis and plot &#39;Volume&#39;</span>
</span></span><span class="line"><span class="cl">    <span class="n">ax2</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">twinx</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">group</span><span class="p">[</span><span class="s1">&#39;日期_dt&#39;</span><span class="p">],</span> <span class="n">group</span><span class="p">[</span><span class="s1">&#39;稅後純益率(%)&#39;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;net profit ratio&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># ax2.set_ylabel(&#39;monthly rev&#39;, color=&#39;green&#39;)</span>
</span></span><span class="line"><span class="cl">    <span class="n">ax2</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># Set axis colors to match the data they represent</span>
</span></span><span class="line"><span class="cl">    <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">labelcolor</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">ax2</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">labelcolor</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Adjust layout to prevent overlap</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Show the plot</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">combine_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">combine_df</span><span class="p">[</span><span class="s1">&#39;股票代號&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;8069&#39;</span><span class="p">,</span> <span class="s1">&#39;近三月合併營收(千)&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">combine_df</span><span class="p">[</span><span class="s1">&#39;股票代號&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">sub</span> <span class="o">=</span> <span class="n">combine_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">combine_df</span><span class="p">[</span><span class="s1">&#39;股票代號&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;3529&#39;</span><span class="p">]</span>
</span></span></code></pre></div><p><figure 
	>
	<a href="/my-blog/Final_test_files/image_2024-08-15_11-38-01.png" >
		<img src="/my-blog/Final_test_files/image_2024-08-15_11-38-01.png"
			
			
			
			loading="lazy"
			alt="image_2024-08-15_11-38-01.png">
	</a>
	
	<figcaption>image_2024-08-15_11-38-01.png</figcaption>
	
</figure></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">ax1</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;2317&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;公告日_dt&#39;</span><span class="p">],</span> <span class="n">sub</span><span class="p">[</span><span class="s1">&#39;收盤價&#39;</span><span class="p">],</span>  <span class="n">label</span><span class="o">=</span><span class="s1">&#39;price&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">ax2</span> <span class="o">=</span> <span class="n">ax1</span><span class="o">.</span><span class="n">twinx</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;公告日_dt&#39;</span><span class="p">],</span> <span class="n">sub</span><span class="p">[</span><span class="s1">&#39;近12月累計合併營收(千)&#39;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;12m_rev_agg&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span></span></code></pre></div><p>指標相關聯 我覺得應該不只是財務數據 也有其他的東西但我們無法access<br>
籌碼相關, 分析師估值等<br>
但以我目前的情況 應該是做估值 並建立買賣點<br>
-&gt; 存貨</p>
<p>大概看了一下 營收的趨勢整體多為向上，股價也是 但若將週期縮小至2-3個月 營收與股價背離的情況很常發生<br>
判斷營收成長 or 衰退的趨勢 其time frame也要抓好<br>
畢竟營收整個趨勢變化較慢 但方向較穩定 但股價有更多雜訊因素</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">sub</span> <span class="o">=</span> <span class="n">combine_df</span><span class="p">[</span><span class="n">combine_df</span><span class="p">[</span><span class="s1">&#39;股票代號&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;2330&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">sub</span> <span class="o">=</span> <span class="n">sub</span><span class="p">[(</span><span class="o">~</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;3m_diff&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">())</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;12m_diff&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">())]</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">sub</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">combine_df</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="o">-</span><span class="mi">60</span><span class="p">:</span><span class="o">-</span><span class="mi">30</span><span class="p">]</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;optimize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;3m_diff&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">sub</span><span class="p">[</span><span class="s1">&#39;12m_diff&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span> <span class="p">:</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">x</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;近三月合併營收(千)&#39;</span><span class="p">]</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;3m_diff&#39;</span><span class="p">]</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="mi">694442123</span> <span class="o">-</span> <span class="mi">673510177</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"></code></pre></div>
</section>


    <footer class="article-footer">
    

    
    <section class="article-copyright">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <path d="M14.5 9a3.5 4 0 1 0 0 6" />
</svg>



        <span>Licensed under CC BY-NC-SA 4.0</span>
    </section>
    </footer>


    
</article>

    <aside class="related-contents--wrapper">
    
    
</aside>

     
    
        
    

    <footer class="site-footer">
    <section class="copyright">
        &copy; 
        
            2021 - 
        
        2025 RobertBasement
    </section>
    
    <section class="powerby">
        Built with <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> <br />
        Theme <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener" data-version="3.2.0">Stack</a></b> designed by <a href="https://jimmycai.com" target="_blank" rel="noopener">Jimmy</a> &emsp;
        
        
    </section>
</footer>


    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer="true"
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer="true"
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.css"integrity="sha256-c0uckgykQ9v5k&#43;IqViZOZKc47Jn7KQil4/MP3ySA3F8="crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.css"integrity="sha256-SBLU4vv6CA6lHsZ1XyTdhyjJxCjPif/TRkjnsyGAGnE="crossorigin="anonymous"
            >

            </main>
    
        <aside class="sidebar right-sidebar sticky">
            <section class="widget archives">
                <div class="widget-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <line x1="5" y1="9" x2="19" y2="9" />
  <line x1="5" y1="15" x2="19" y2="15" />
  <line x1="11" y1="4" x2="7" y2="20" />
  <line x1="17" y1="4" x2="13" y2="20" />
</svg>



                </div>
                <h2 class="widget-title section-title">Table of contents</h2>
                
                <div class="widget--toc">
                    <nav id="TableOfContents">
  <ol>
    <li><a href="#月營收">月營收</a></li>
    <li><a href="#收盤價">收盤價</a></li>
    <li><a href="#融資">融資</a></li>
    <li><a href="#週集保">週集保</a></li>
    <li><a href="#看起來本益比切線斜率-累積增加0-對捕捉上升趨勢還不錯">看起來本益比切線斜率 累積增加&gt;0 對捕捉上升趨勢還不錯</a></li>
    <li><a href="#local-minima-maxima">Local Minima, maxima</a></li>
    <li><a href="#strategy-logic">strategy Logic</a></li>
    <li><a href="#組合上下行">組合上下行</a></li>
    <li><a href="#now">NOW</a></li>
    <li><a href="#簡易pnl模擬">簡易PnL模擬</a></li>
    <li><a href="#如果是想要抄底的策略-holding-天數可能要拉長到可以等他漲回去">如果是想要抄底的策略 holding 天數可能要拉長到可以等他漲回去</a></li>
    <li><a href="#2454-2383-2059-3008-done">2454, 2383, 2059, 3008 done</a></li>
    <li><a href="#pe">PE</a></li>
    <li><a href="#不同時間段-適合看得指標也不盡相同-我能不能這個概念---用基本面的變化來作為時間段的區分">不同時間段 適合看得指標也不盡相同 我能不能這個概念 -&gt; 用基本面的變化來作為時間段的區分</a></li>
    <li><a href="#貝氏定理">貝氏定理</a></li>
    <li><a href="#reample--merge">reample + merge</a></li>
    <li><a href="#eps-forward-knowing--cal--resample--merge">EPS forward knowing , cal + resample + merge</a>
      <ol>
        <li><a href="#1-先把每一季的eps做加總4季-agg-再藉由shift去假設-能夠完美預測未來n季">1. 先把每一季的EPS做加總(4季 agg) 再藉由shift去假設 能夠完美預測未來N季</a></li>
        <li><a href="#再resample-至daily">再resample 至daily</a></li>
        <li><a href="#2-與股價合併">2. 與股價合併</a></li>
        <li><a href="#3-有股價-有完美預測一段時間的eps---就有完美預估的pe">3. 有股價 有完美預測一段時間的EPS -&gt; 就有完美預估的PE</a></li>
        <li><a href="#找出該期間的max-min值-主要是用來繪制河流圖">找出該期間的MAX, MIN值 主要是用來繪制河流圖</a></li>
        <li><a href="#並shift">並shift</a></li>
        <li><a href="#用前一季之前的all-data-來計算-分位數">用前一季之前的All data 來計算 分位數</a></li>
        <li><a href="#把-截至上一季-pe的高低點-算出來後-與股價merge">把 截至上一季 PE的高低點 算出來後 與股價merge</a></li>
        <li><a href="#繪製本益比河流圖時-河流應為過去一段時間的min-max">繪製本益比河流圖時 河流應為過去一段時間的min, max</a></li>
      </ol>
    </li>
    <li><a href="#columns-展示">columns 展示</a></li>
  </ol>
</nav>
                </div>
            </section>
        </aside>
    

        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.5/dist/vibrant.min.js"integrity="sha256-5NovOZc4iwiAWTYIFiIM7DxKUXKWvpVEuMEPLzcm5/g="crossorigin="anonymous"
                defer="false"
                >
            </script><script type="text/javascript" src="/my-blog/ts/main.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>

    </body>
</html>
